<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Bibliophile 2.0: Procedural Reading Galaxy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#34D399',
                        cosmic: '#805AD5',
                        danger: '#F87171',
                        warning: '#FBBF24',
                        info: '#60A5FA',
                        enlightenment: '#FF6B6B',
                        galaxy: '#4F46E5',
                        dark: {
                            bg: '#181818',
                            card: '#252525',
                            text: '#E5E5E5'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'space-twinkle': 'twinkle 3s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'rotate-slow': 'rotate 30s linear infinite'
                    },
                    keyframes: {
                        glow: {
                            '0%': { textShadow: '0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B' },
                            '100%': { textShadow: '0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B' }
                        },
                        twinkle: {
                            '0%': { opacity: '0.5' },
                            '50%': { opacity: '1' },
                            '100%': { opacity: '0.7' }
                        },
                        float: {
                            '0%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                            '100%': { transform: 'translateY(0px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .resource-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        /* Progress bar animations */
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .progress-animation {
            animation: progress 30s linear infinite;
        }
        
        /* Dark mode support */
        .dark .dark\:bg-dark-bg { background-color: #181818; }
        .dark .dark\:bg-dark-card { background-color: #252525; }
        .dark .dark\:text-dark-text { color: #E5E5E5; }
        .dark .dark\:border-gray-700 { border-color: #4B5563; }
        
        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 200px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: opacity 0.2s ease-in-out;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
        }
        
        /* Enlightenment glow effect */
        .enlightenment-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B; }
            100% { text-shadow: 0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B; }
        }
        
        /* Galaxy map styling */
        .galaxy-map {
            position: relative;
            overflow: hidden;
            background-color: #070b19;
            border-radius: 8px;
        }
        
        .star {
            position: absolute;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .star-system:hover {
            transform: scale(1.2);
        }
        
        .star-system.discovered {
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system.unexplored {
            opacity: 0.6;
            filter: grayscale(70%);
        }
        
        .exploration-radius {
            position: absolute;
            border: 2px dashed rgba(93, 92, 222, 0.4);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .star-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            z-index: 20;
            min-width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Galaxy controls */
        .galaxy-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(5px);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .galaxy-control-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .galaxy-control-btn:hover {
            background-color: rgba(93, 92, 222, 0.6);
        }
        
        /* Procedural facility styling */
        .facility-card {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        
        .facility-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .facility-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--facility-color-1), var(--facility-color-2));
        }
        
        .facility-icon {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--facility-color-1), var(--facility-color-2));
            color: white;
            font-size: 18px;
        }
        
        .facility-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--facility-color-1);
            opacity: 0.6;
            pointer-events: none;
            animation: float 3s infinite ease-in-out;
        }
        
        /* Notification system */
        #notification-area {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            max-width: 320px;
            width: 100%;
        }
        
        .notification {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        /* Floating particles */
        @keyframes float-particle {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
        
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            animation: float-particle 4s ease-in-out forwards;
        }
        
        /* Facility upgrade progress */
        .upgrade-progress {
            height: 4px;
            background-color: rgba(93, 92, 222, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .upgrade-progress-bar {
            height: 100%;
            background-color: var(--facility-color-1);
            width: var(--progress-width, 0%);
            transition: width 0.5s ease;
        }
        
        /* Cosmic effect animation */
        @keyframes cosmic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(128, 90, 213, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(128, 90, 213, 0); }
            100% { box-shadow: 0 0 0 0 rgba(128, 90, 213, 0); }
        }
        
        .cosmic-effect {
            animation: cosmic-pulse 2s infinite;
        }
        
        /* Collection animation */
        @keyframes collect {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .collect-animation {
            animation: collect 0.5s ease-out forwards;
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* System discovery effect */
        .discovery-flash {
            animation: flash 0.8s ease-out;
        }
        
        @keyframes flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.8); }
            70% { box-shadow: 0 0 0 30px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        /* Celestial object animation */
        .celestial-orbit {
            position: absolute;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: rotate-slow 30s linear infinite;
        }
        
        .celestial-body {
            position: absolute;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite alternate;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg min-h-screen transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-dark-text mb-2">Stellar Bibliophile 2.0</h1>
            <p class="text-gray-600 dark:text-gray-400">Procedural Reading Galaxy Explorer</p>
            <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">v2.0.0</div>
        </header>

        <!-- Resources Bar -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
            <div class="grid grid-cols-3 md:grid-cols-4 gap-2 md:gap-4">
                <div class="flex items-center">
                    <div class="resource-icon bg-blue-100 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Knowledge Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="knowledge-points">0</span> KP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-purple-100 text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Research Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="research-points">0</span> RP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-yellow-100 text-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Cosmic Influence</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="influence">0</span> CI</div>
                    </div>
                </div>
                <div id="enlightenment-container" class="flex items-center">
                    <div class="resource-icon bg-red-100 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Enlightenment</div>
                        <div class="font-bold text-enlightenment"><span id="enlightenment-points">0</span> EP</div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex justify-between">
                <div>Level: <span id="player-level" class="font-medium">1</span></div>
                <div>Passive RP: <span id="passive-rp" class="font-medium">0</span>/min</div>
                <div>Books Read: <span id="books-read" class="font-medium">0</span></div>
                <div>Prestige: <span id="prestige-level" class="font-medium">0</span></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <a href="#" class="tab-link active inline-block p-4 border-b-2 border-primary text-primary dark:text-primary rounded-t-lg" data-tab="reading">Reading Tracker</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="facilities">Facilities</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="research">Research</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="stats">Stats</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="galaxy">Galaxy</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg enlightenment-text" data-tab="enlightenment">Enlightenment</a>
                </li>
                <li>
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="settings">Settings</a>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Reading Tracker Tab -->
            <div id="reading-tab" class="tab-pane active">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Track Your Reading</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Book Title</label>
                        <input type="text" id="book-title" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter book title">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Genre</label>
                            <select id="book-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="sci-fi">Science Fiction</option>
                                <option value="fantasy">Fantasy</option>
                                <option value="non-fiction">Non-Fiction</option>
                                <option value="mystery">Mystery/Thriller</option>
                                <option value="history">History</option>
                                <option value="science">Science</option>
                                <option value="biography">Biography</option>
                                <option value="custom">Other (Custom)</option>
                            </select>
                            <div id="custom-genre-container" class="mt-2 hidden">
                                <input type="text" id="custom-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter custom genre">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Difficulty</label>
                            <select id="book-difficulty" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="easy">Easy (x1.0 KP)</option>
                                <option value="medium" selected>Medium (x1.5 KP)</option>
                                <option value="hard">Hard (x2.0 KP)</option>
                                <option value="expert">Expert (x3.0 KP)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pages Read</label>
                            <input type="number" id="pages-read" min="1" value="10" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reading Minutes</label>
                            <input type="number" id="reading-minutes" min="1" value="30" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="log-reading" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200 flex-grow">
                            Log Reading Session
                        </button>
                        <button id="complete-book" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                            Complete Book
                        </button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Current Reading</h2>
                    <div id="current-reading-list" class="space-y-3">
                        <div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>
                    </div>
                </div>
            </div>

            <!-- Facilities Tab -->
            <div id="facilities-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Your Facilities</h2>
                        <button id="discover-facility-btn" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white text-sm font-bold rounded transition-colors duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Discover New Facility (100 KP)
                        </button>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Build and upgrade procedurally generated facilities to boost your reading empire.</p>
                    
                    <div id="facilities-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Procedurally generated facilities will be added here -->
                    </div>
                </div>
            </div>

            <!-- Research Tab -->
            <div id="research-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Research Technologies</h2>
                        <button id="discover-research-btn" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white text-sm font-bold rounded transition-colors duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Discover New Research (75 RP)
                        </button>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Unlock technologies to enhance your reading journey and boost your resources.</p>
                    
                    <div id="research-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Procedurally generated research will be added here -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Core Technologies</h2>
                    <div id="core-research-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Core research items will be added here -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Enlightenment Studies</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Prepares your mind for transcendence. Unlocks the Prestige system and Enlightenment points.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 500 RP</span>
                                <span>Status: <span id="enlightenment-status">Not Researched</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                                <span class="font-semibold">Requirements:</span> Player Level 7, 10 Books Completed
                            </div>
                            <button id="research-enlightenment" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Stellar Cartography</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Unlocks the Galaxy exploration system and the ability to discover cosmic objects.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 150 RP</span>
                                <span>Status: <span id="cartography-status">Not Researched</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                                <span class="font-semibold">Requirements:</span> Player Level 3, 3 Books Completed
                            </div>
                            <button id="research-cartography" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Reading Statistics</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-books">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Books Completed</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-pages">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Pages Read</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-minutes">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Reading Minutes</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-kp">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">KP Generated</div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Genre Distribution</h3>
                    <div id="genre-distribution" class="space-y-3 mb-6">
                        <!-- Genre bars will be generated dynamically -->
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Achievements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Bookworm</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Complete 3 books</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="bookworm-progress">0</span>/3</div>
                            </div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Prolific Reader</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Read 500 pages</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="prolific-progress">0</span>/500</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prestige Stats Section -->
                    <div id="prestige-stats-section" class="mt-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Prestige Statistics</h3>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-prestige">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Prestiges</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-ep">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total EP Earned</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-level">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Highest Level</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-books">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Most Books Read</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Procedural Discoveries -->
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Procedural Discoveries</h3>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary"><span id="discovered-facilities">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Facilities Discovered</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary"><span id="discovered-research">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Research Discovered</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-galaxy"><span id="discovered-systems">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Star Systems</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-galaxy"><span id="colonized-planets">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Colonized Planets</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Galaxy Tab -->
            <div id="galaxy-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Literary Galaxy</h2>
                        <div class="flex items-center">
                            <div class="resource-icon bg-yellow-100 text-yellow-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </div>
                            <span class="font-medium text-gray-700 dark:text-gray-300"><span id="galaxy-influence">0</span> CI</span>
                            <button id="discover-system-btn" class="ml-4 px-4 py-2 bg-galaxy hover:bg-indigo-700 text-white text-sm font-bold rounded transition-colors duration-200 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Explore (25 CI)
                            </button>
                        </div>
                    </div>
                    
                    <div id="galaxy-unlock-message" class="py-8 text-center">
                        <div class="text-4xl mb-4">🔭</div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Unlock the Literary Galaxy</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4 max-w-lg mx-auto">
                            Research Stellar Cartography to explore the vast Literary Galaxy, discover procedurally generated 
                            star systems, and establish reading outposts for powerful bonuses.
                        </p>
                        <div class="flex flex-col space-y-2 max-w-xs mx-auto">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Requirements:</span>
                                <span class="font-medium text-gray-900 dark:text-dark-text">Level 3, 3 Books Read</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Stellar Cartography</span>
                                <span class="font-medium text-gray-900 dark:text-dark-text" id="galaxy-cartography-status">Not Researched</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="galaxy-interface" class="hidden">
                        <div class="mb-4">
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
                                Explore the Literary Galaxy to discover procedurally generated star systems and establish reading outposts. Each system has unique celestial objects with special bonuses.
                            </p>
                            
                            <div class="flex flex-wrap gap-4 mb-4">
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Systems Discovered</div>
                                    <div class="text-2xl font-bold text-galaxy" id="systems-discovered">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Outposts Established</div>
                                    <div class="text-2xl font-bold text-galaxy" id="outposts-established">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exploration Range</div>
                                    <div class="text-2xl font-bold text-galaxy" id="exploration-range">3</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Next System Cost</div>
                                    <div class="text-2xl font-bold text-galaxy" id="next-system-cost">25</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="galaxy-map-container">
                            <div class="galaxy-map w-full h-[400px] relative mb-4" id="galaxy-map">
                                <!-- Background stars (added via JS) -->
                                <!-- Star systems (added via JS) -->
                                <!-- Exploration radius visualization -->
                                <div class="exploration-radius" id="exploration-radius"></div>
                                
                                <!-- Galaxy map controls -->
                                <div class="galaxy-controls">
                                    <button class="galaxy-control-btn" id="zoom-in">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="zoom-out">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="center-map">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Star system tooltip (shown when hovering over a system) -->
                                <div class="star-tooltip" id="star-tooltip"></div>
                            </div>
                        </div>
                        
                        <!-- Selected System Details Panel -->
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 hidden" id="system-details-panel">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text" id="selected-system-name">System Name</h3>
                                <div class="text-sm px-2 py-1 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" id="selected-system-type">Star Type</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" id="selected-system-description">
                                        System description will appear here.
                                    </p>
                                    <div class="flex space-x-6 text-sm">
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Coordinates:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-coordinates">(0, 0)</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Celestial Objects:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-planets">0</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Rarity:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-rarity">Common</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end items-center">
                                    <button id="establish-outpost-btn" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Establish Outpost (25 CI)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">Celestial Objects</h4>
                                <div id="system-planets-list" class="space-y-2">
                                    <!-- Celestial objects will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expedition Status Panel -->
                        <div id="expedition-panel" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 overflow-hidden hidden">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-medium text-blue-800 dark:text-blue-200">Expedition in Progress</h3>
                                <span class="text-sm text-blue-600 dark:text-blue-300" id="expedition-time">0:30</span>
                            </div>
                            <p class="text-sm text-blue-600 dark:text-blue-300 mb-2" id="expedition-message">
                                Your literary expedition is exploring the cosmos...
                            </p>
                            <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2 overflow-hidden">
                                <div id="expedition-progress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Outposts Panel -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Active Reading Outposts</h2>
                    
                    <div id="no-outposts-message" class="py-8 text-center">
                        <p class="text-gray-600 dark:text-gray-400">
                            You haven't established any reading outposts yet. Explore the galaxy to find star systems and establish outposts.
                        </p>
                    </div>
                    
                    <div id="outposts-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- Active outposts will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Enlightenment Tab -->
            <div id="enlightenment-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-enlightenment">Enlightenment</h2>
                        <div class="text-enlightenment font-bold">EP Available: <span id="available-ep">0</span></div>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Unlock permanent upgrades with Enlightenment Points. These bonuses persist through prestige resets.</p>
                    
                    <div id="enlightenment-upgrades" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Permanent upgrades will be added here -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-enlightenment mb-4">Ascension</h2>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Ascending will reset your progress, but reward you with Enlightenment Points (EP) based on your achievements. These points can be spent on permanent upgrades.
                        </p>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-gray-900 dark:text-white mb-2">Enlightenment Points Preview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Level:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-level">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Books:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-books">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Discoveries:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-discoveries">0</span> EP</span>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total EP to be gained:</span>
                                <span class="text-2xl font-bold text-enlightenment ml-2"><span id="total-ep-gain">0</span> EP</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-center">
                            <button id="ascend-button" class="bg-enlightenment hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 text-center flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                Ascend
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-6">
                        <h3 class="text-lg font-bold text-enlightenment mb-3">Galactic Relics</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            These powerful artifacts persist across prestige resets, providing permanent bonuses to your reading empire.
                        </p>
                        
                        <div id="relics-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center p-6 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                                <div class="text-gray-500 dark:text-gray-400">
                                    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <p>Discover relics by exploring rare star systems or completing special achievements</p>
                                </div>
                            </div>
                            <!-- Relics will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Game Settings</h2>
                    
                    <div class="space-y-6">
                        <!-- Save/Load Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Save/Load Game</h3>
                            <div class="space-y-3">
                                <div>
                                    <button id="export-save" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Export Save Data
                                    </button>
                                    <button id="copy-save" class="ml-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Copy to Clipboard
                                    </button>
                                    <button id="download-save" class="ml-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Save as File
                                    </button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import Save Data</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="import-save-data" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Paste save data here">
                                        <button id="import-save" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                            Import
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import From File</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="file" id="import-save-file" class="hidden" accept=".json">
                                        <button id="import-file-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                            Choose File
                                        </button>
                                        <span id="file-name" class="text-sm text-gray-500">No file selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Offline Progression -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Offline Progression</h3>
                            <div class="flex items-center mb-2">
                                <div class="mr-2 w-12 h-6 relative">
                                    <input type="checkbox" id="offline-progression" class="sr-only" checked>
                                    <div class="w-12 h-6 bg-gray-200 rounded-full shadow-inner"></div>
                                    <div id="offline-slider" class="dot absolute left-0 top-0 bg-primary w-6 h-6 rounded-full transition-all duration-300 transform translate-x-6"></div>
                                </div>
                                <span class="text-sm text-gray-700 dark:text-gray-300">Enable offline progression</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                When enabled, you'll continue to earn resources while you're away. Resources will be calculated based on your facilities and game state.
                            </p>
                            <div id="offline-stats" class="text-sm text-gray-700 dark:text-gray-300">
                                <div>Offline efficiency: <span id="offline-efficiency">50</span>%</div>
                                <div>Last online: <span id="last-online">Never</span></div>
                            </div>
                        </div>
                        
                        <!-- Prestige Section -->
                        <div id="prestige-settings-section">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Prestige</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">You can ascend to gain Enlightenment Points. This will reset your progress but unlock permanent bonuses.</p>
                            <button id="prestige-button" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Ascend for Enlightenment Points
                            </button>
                        </div>
                        
                        <!-- Reset Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Reset Game</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">This will reset all progress. Make sure to export your save first!</p>
                            <button id="reset-game" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Reset All Progress
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- About & Support -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">About & Support</h2>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">About Stellar Bibliophile 2.0</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Stellar Bibliophile v2.0.0 is a procedural reading tracker with grand strategy elements. 
                            Track your reading progress, discover procedurally generated facilities and research, explore the galaxy,
                            and ascend for permanent bonuses.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-xs text-gray-500 dark:text-gray-500 py-4">
            <p>Stellar Bibliophile v2.0.0 | Procedural Reading Galaxy Explorer</p>
            <p class="mt-1">Track your reading journey with procedurally generated content and endless progression</p>
        </footer>
        
        <!-- Notification Area -->
        <div id="notification-area" class="fixed bottom-4 right-4 max-w-sm"></div>
        
        <!-- Save Data Export Modal -->
        <div id="save-export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Export Game Save</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Copy the text below to save your game progress. You can import this later to restore your game.
                </p>
                <textarea id="export-save-text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-xs font-mono" rows="5" readonly></textarea>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="copy-save-modal" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Copy to Clipboard
                    </button>
                    <button id="close-export-modal" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ascension Confirmation Modal -->
        <div id="ascension-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold text-enlightenment mb-4">Confirm Ascension</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    You are about to ascend and reset your progress. You will gain <span id="confirm-ep-gain" class="font-bold text-enlightenment">0</span> Enlightenment Points.
                </p>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    The following will be RESET:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-4">
                    <li>Player level and all resources</li>
                    <li>All facilities and their levels</li>
                    <li>All research (except core technologies)</li>
                    <li>Current books and reading progress</li>
                    <li>Unexplored star systems</li>
                </ul>
                <p class="text-gray-600 dark:text-gray-400 mb-6">
                    The following will be KEPT:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-6">
                    <li>Enlightenment Points and all permanent upgrades</li>
                    <li>Galactic Relics and their bonuses</li>
                    <li>Lifetime statistics and achievements</li>
                    <li>Prestige level and unlocked features</li>
                </ul>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-ascension" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirm-ascension" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Ascend
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Discovery Modal (for facilities, research, systems) -->
        <div id="discovery-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center">
                <div class="text-4xl mb-2">✨</div>
                <h3 class="text-xl font-bold text-galaxy mb-3" id="discovery-type">New Facility Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="discovery-name">Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="discovery-description">
                    Description will appear here.
                </p>
                <div id="discovery-details" class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <!-- Additional details will be added here dynamically -->
                </div>
                <button id="close-discovery-modal" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Awesome!
                </button>
            </div>
        </div>
        
        <!-- Offline Progress Modal -->
        <div id="offline-progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Welcome Back!</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    While you were away, your reading empire continued to progress:
                </p>
                <div class="mb-6 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Knowledge Points:
                        </span>
                        <span class="font-bold text-gray-900 dark:text-dark-text">+<span id="offline-kp">0</span> KP</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Research Points:
                        </span>
                        <span class="font-bold text-gray-900 dark:text-dark-text">+<span id="offline-rp">0</span> RP</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                            Cosmic Influence:
                        </span>
                        <span class="font-bold text-gray-900 dark:text-dark-text">+<span id="offline-influence">0</span> CI</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Time away:</span>
                        <span class="font-bold text-gray-900 dark:text-dark-text"><span id="offline-time">0</span></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Efficiency:</span>
                        <span class="font-bold text-gray-900 dark:text-dark-text"><span id="offline-progress-efficiency">50</span>%</span>
                    </div>
                </div>
                <button id="claim-offline-progress" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Claim Resources
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game version
        const GAME_VERSION = "2.0.0";
        
        // Check for dark mode preference
        function checkDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        }
        
        checkDarkMode();
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Game state
        let gameState = {
            version: GAME_VERSION,
            lastSaved: Date.now(),
            lastOnline: Date.now(),
            player: {
                level: 1,
                experiencePoints: 0,
                experienceToNextLevel: 100
            },
            resources: {
                knowledgePoints: 100, // Starting with more KP
                researchPoints: 0,
                influence: 0
            },
            // Procedurally generated facilities
            facilities: {},
            // Procedurally generated research
            research: {
                enlightenmentStudies: false,
                stellarCartography: false
            },
            stats: {
                booksCompleted: 0,
                pagesRead: 0,
                minutesRead: 0,
                totalKpGenerated: 0,
                facilitiesDiscovered: 0,
                researchDiscovered: 0,
                genreDistribution: {
                    'sci-fi': 0,
                    'fantasy': 0,
                    'non-fiction': 0,
                    'mystery': 0,
                    'history': 0,
                    'science': 0,
                    'biography': 0,
                    'custom': {}
                }
            },
            currentBooks: [],
            // Prestige-related properties
            prestige: {
                unlocked: false,
                level: 0,
                enlightenmentPoints: 0,
                totalEnlightenmentEarned: 0,
                // Permanent upgrades that persist across prestige resets
                permanentUpgrades: {}
            },
            // Lifetime stats that persist across prestiges
            lifetimeStats: {
                totalPrestiges: 0,
                maxLevel: 1,
                maxBooks: 0,
                totalEnlightenmentPoints: 0
            },
            // Galaxy exploration system data
            galaxy: {
                unlocked: false,
                discoveredSystems: {},
                currentCoordinates: { x: 0, y: 0 },
                viewCenter: { x: 0, y: 0 },
                explorationRange: 3,
                zoomLevel: 1,
                nextSystemCost: 25,
                systemCosts: {
                    base: 25,
                    distanceMultiplier: 1.2
                },
                activeCelestialObjects: [],
                activeExpedition: null,
                stats: {
                    systemsDiscovered: 0,
                    outpostsEstablished: 0,
                    objectsColonized: 0,
                    expeditionsCompleted: 0,
                    rareObjectsFound: 0
                }
            },
            // Galactic relics that persist across prestiges
            relics: {},
            // Settings
            settings: {
                offlineProgression: true,
                offlineEfficiency: 50 // 50% efficiency by default
            }
        };
        
        // Game configuration
        const gameConfig = {
            // Resource generation rates
            baseKpPerPage: 1,
            baseKpPerMinute: 0.5,
            facilityBaseCost: 100,
            researchBaseCost: 75,
            difficultyMultipliers: {
                'easy': 1.0,
                'medium': 1.5,
                'hard': 2.0,
                'expert': 3.0
            },
            completionBonus: 0.2, // 20% bonus for completing a book
            resourceInterval: 10000, // Generate resources every 10 seconds (faster than original)
            
            // Procedural generation settings
            facilities: {
                namePatterns: [
                    "{adjective} {noun}",
                    "{noun} of {concept}",
                    "{cosmic} {noun}",
                    "{concept} {noun}",
                    "{adjective} {cosmic} {noun}"
                ],
                adjectives: [
                    "Quantum", "Stellar", "Cosmic", "Ethereal", "Astral", "Galactic", "Celestial", 
                    "Transcendent", "Chronological", "Dimensional", "Crystalline", "Prismatic", 
                    "Harmonic", "Arcane", "Neural", "Hyperspace", "Temporal", "Interdimensional",
                    "Parallel", "Metaphysical", "Sentient", "Luminous", "Resonant", "Psychic", "Vortex"
                ],
                nouns: [
                    "Nexus", "Archive", "Library", "Observatory", "Repository", "Sanctum", "Citadel", 
                    "Matrix", "Academy", "Forge", "Bastion", "Codex", "Compendium", "Crucible", "Lexicon", 
                    "Athenaeum", "Network", "Conduit", "Engine", "Weave", "Apparatus", "Algorithm", 
                    "Chamber", "Prism", "Core", "Interface", "Beacon", "Amplifier", "Catalyst"
                ],
                cosmicObjects: [
                    "Nebula", "Quasar", "Pulsar", "Star", "Constellation", "Void", "Galaxy", "Nova", 
                    "Supernova", "Singularity", "Wormhole", "Starfield", "Cosmos", "Comet", "Asteroid"
                ],
                concepts: [
                    "Knowledge", "Wisdom", "Enlightenment", "Thought", "Cognition", "Memory", "Insight", 
                    "Comprehension", "Understanding", "Consciousness", "Reflection", "Awareness", 
                    "Intuition", "Perception", "Intellect", "Sagacity", "Erudition", "Acumen"
                ],
                // Types of effects facilities can have
                effectTypes: [
                    { id: "kp_passive", name: "Passive KP", desc: "Generates {value} KP per minute", max: 5, valueType: "flat", 
                      valueRange: [0.5, 2.0], scalingFactor: 0.7, icon: "📚" },
                    { id: "rp_passive", name: "Passive RP", desc: "Generates {value} RP per minute", max: 3, valueType: "flat", 
                      valueRange: [0.3, 1.5], scalingFactor: 0.6, icon: "🧪" },
                    { id: "inf_passive", name: "Passive Influence", desc: "Generates {value} CI per minute", max: 1, valueType: "flat", 
                      valueRange: [0.1, 0.8], scalingFactor: 0.5, icon: "✨" },
                    { id: "kp_per_page", name: "KP per Page", desc: "Increases KP from pages by {value}%", max: 25, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "📄" },
                    { id: "kp_per_min", name: "KP per Minute", desc: "Increases KP from reading time by {value}%", max: 25, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "⏱️" },
                    { id: "completion_bonus", name: "Completion Bonus", desc: "Increases book completion bonus by {value}%", max: 35, valueType: "percentage", 
                      valueRange: [8, 20], scalingFactor: 0.7, icon: "🏆" },
                    { id: "xp_bonus", name: "XP Boost", desc: "Increases experience gain by {value}%", max: 20, valueType: "percentage", 
                      valueRange: [3, 12], scalingFactor: 0.5, icon: "⭐" },
                    { id: "facility_discount", name: "Building Discount", desc: "Reduces facility cost by {value}%", max: 25, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "🏗️" },
                    { id: "research_discount", name: "Research Discount", desc: "Reduces research cost by {value}%", max: 25, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "🔬" },
                    { id: "offline_bonus", name: "Offline Efficiency", desc: "Increases offline progression by {value}%", max: 30, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "💤" },
                    { id: "exploration_bonus", name: "Exploration Range", desc: "Increases galaxy exploration range by {value}", max: 3, valueType: "flat", 
                      valueRange: [0.2, 1.0], scalingFactor: 0.5, icon: "🔭" },
                    { id: "discovery_chance", name: "Discovery Chance", desc: "Increases chance of rare discoveries by {value}%", max: 25, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "🔍" }
                ],
                // Rarity levels for facilities
                rarities: [
                    { id: "common", name: "Common", chance: 0.5, colorClass: "blue-500", 
                      effectCount: { min: 1, max: 1 }, effectQuality: 0.7, upgradeCostFactor: 1.0 },
                    { id: "uncommon", name: "Uncommon", chance: 0.3, colorClass: "green-500", 
                      effectCount: { min: 1, max: 2 }, effectQuality: 0.85, upgradeCostFactor: 1.1 },
                    { id: "rare", name: "Rare", chance: 0.15, colorClass: "purple-500", 
                      effectCount: { min: 2, max: 2 }, effectQuality: 1.0, upgradeCostFactor: 1.2 },
                    { id: "epic", name: "Epic", chance: 0.04, colorClass: "yellow-500", 
                      effectCount: { min: 2, max: 3 }, effectQuality: 1.2, upgradeCostFactor: 1.4 },
                    { id: "legendary", name: "Legendary", chance: 0.01, colorClass: "red-500", 
                      effectCount: { min: 3, max: 3 }, effectQuality: 1.5, upgradeCostFactor: 1.7 }
                ]
            },
            
            // Research procedural generation
            research: {
                namePatterns: [
                    "{adjective} {concept}",
                    "{concept} {noun}",
                    "{adjective} {noun}",
                    "{concept} {theory}",
                    "{adjective} {theory}"
                ],
                adjectives: [
                    "Advanced", "Enhanced", "Optimized", "Accelerated", "Augmented", "Efficient", 
                    "Quantum", "Neural", "Cognitive", "Harmonic", "Resonant", "Synchronized", 
                    "Crystalline", "Ethereal", "Temporal", "Spatial", "Dimensional", "Holistic"
                ],
                nouns: [
                    "Algorithms", "Systems", "Methodologies", "Frameworks", "Processes", "Protocols", 
                    "Networks", "Matrices", "Arrays", "Structures", "Paradigms", "Dynamics", 
                    "Mechanics", "Interfaces", "Pathways", "Conduits", "Catalysts", "Synthesis"
                ],
                concepts: [
                    "Cognition", "Comprehension", "Perception", "Analysis", "Integration", "Synthesis", 
                    "Recognition", "Interpretation", "Assimilation", "Abstraction", "Extraction", 
                    "Retention", "Recollection", "Indexing", "Classification", "Organization", "Intuition"
                ],
                theories: [
                    "Theory", "Hypothesis", "Principle", "Postulate", "Theorem", "Axiom", "Law", 
                    "Framework", "Paradigm", "Model", "Doctrine", "Methodology", "Approach", "System"
                ],
                // Types of effects research can have
                effectTypes: [
                    { id: "kp_multiplier", name: "Knowledge Multiplier", desc: "Multiplies all KP gain by {value}%", max: 50, valueType: "percentage", 
                      valueRange: [5, 20], scalingFactor: 0.7, icon: "📚" },
                    { id: "rp_multiplier", name: "Research Multiplier", desc: "Multiplies all RP gain by {value}%", max: 50, valueType: "percentage", 
                      valueRange: [5, 20], scalingFactor: 0.7, icon: "🧪" },
                    { id: "inf_multiplier", name: "Influence Multiplier", desc: "Multiplies all CI gain by {value}%", max: 50, valueType: "percentage", 
                      valueRange: [5, 20], scalingFactor: 0.7, icon: "✨" },
                    { id: "facility_output", name: "Facility Output", desc: "Increases all facility outputs by {value}%", max: 40, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "🏗️" },
                    { id: "reading_efficiency", name: "Reading Efficiency", desc: "Increases KP from all reading by {value}%", max: 40, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "📖" },
                    { id: "completion_boost", name: "Completion Boost", desc: "Adds {value}% more resources when completing books", max: 50, valueType: "percentage", 
                      valueRange: [10, 25], scalingFactor: 0.7, icon: "🏆" },
                    { id: "xp_multiplier", name: "XP Multiplier", desc: "Increases all XP gain by {value}%", max: 40, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "⭐" },
                    { id: "upgrade_discount", name: "Upgrade Discount", desc: "Reduces all upgrade costs by {value}%", max: 30, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "💰" },
                    { id: "offline_progress", name: "Offline Progress", desc: "Increases offline progression rate by {value}%", max: 50, valueType: "percentage", 
                      valueRange: [10, 25], scalingFactor: 0.7, icon: "💤" },
                    { id: "galaxy_reach", name: "Galaxy Range", desc: "Increases galaxy exploration range by {value}", max: 3, valueType: "flat", 
                      valueRange: [0.2, 1.0], scalingFactor: 0.5, icon: "🔭" },
                    { id: "galaxy_speed", name: "Exploration Speed", desc: "Increases galaxy exploration speed by {value}%", max: 75, valueType: "percentage", 
                      valueRange: [10, 30], scalingFactor: 0.7, icon: "🚀" },
                    { id: "galaxy_efficiency", name: "Cosmic Efficiency", desc: "Reduces cosmic influence costs by {value}%", max: 30, valueType: "percentage", 
                      valueRange: [5, 15], scalingFactor: 0.6, icon: "⚡" }
                ],
                // Rarity levels for research
                rarities: [
                    { id: "common", name: "Common", chance: 0.5, colorClass: "blue-500", 
                      effectCount: { min: 1, max: 1 }, effectQuality: 0.7, costFactor: 1.0 },
                    { id: "uncommon", name: "Uncommon", chance: 0.3, colorClass: "green-500", 
                      effectCount: { min: 1, max: 1 }, effectQuality: 0.9, costFactor: 1.3 },
                    { id: "rare", name: "Rare", chance: 0.15, colorClass: "purple-500", 
                      effectCount: { min: 1, max: 2 }, effectQuality: 1.1, costFactor: 1.6 },
                    { id: "epic", name: "Epic", chance: 0.04, colorClass: "yellow-500", 
                      effectCount: { min: 2, max: 2 }, effectQuality: 1.3, costFactor: 2.0 },
                    { id: "legendary", name: "Legendary", chance: 0.01, colorClass: "red-500", 
                      effectCount: { min: 2, max: 3 }, effectQuality: 1.7, costFactor: 3.0 }
                ]
            },
            
            // Galaxy procedural generation
            galaxy: {
                systemColors: {
                    classic: "#FFD700", // Yellow - Classical literature
                    academic: "#FFFFFF", // White - Academic literature
                    modern: "#60A5FA", // Blue - Modern literature
                    experimental: "#F87171", // Red - Experimental literature
                    speculative: "#34D399" // Green - Speculative fiction
                },
                rarityColors: {
                    common: "#FFFFFF",
                    uncommon: "#34D399",
                    rare: "#60A5FA",
                    legendary: "#805AD5",
                    mythic: "#F87171"
                },
                starSizesByRarity: {
                    common: 4,
                    uncommon: 6,
                    rare: 8,
                    legendary: 10,
                    mythic: 12
                },
                systemTypes: [
                    "classic", "academic", "modern", "experimental", "speculative"
                ],
                systemRarities: [
                    { rarity: "common", weight: 60 },
                    { rarity: "uncommon", weight: 25 },
                    { rarity: "rare", weight: 10 },
                    { rarity: "legendary", weight: 4 },
                    { rarity: "mythic", weight: 1 }
                ],
                // Names for celestial objects
                objectNamePrefixes: [
                    "Nova", "Stellar", "Cosmo", "Astro", "Aether", "Nebula", "Pulsar", "Quasar", "Orbital",
                    "Helio", "Lunar", "Solar", "Celestial", "Cosmic", "Galactic", "Terran", "Vega", "Antares",
                    "Echo", "Lumina", "Aurora", "Zenith", "Meridian", "Horizon", "Infinity", "Parallax", "Apogee",
                    "Chronicle", "Saga", "Lexicon", "Compendium", "Atlas", "Opus", "Codex", "Grimoire", "Tome",
                    "Libri", "Volumen", "Bibliotheca", "Arcanum", "Memoria", "Enigma", "Paragon", "Literati", "Folio"
                ],
                objectNameSuffixes: [
                    "Prime", "Alpha", "Beta", "Gamma", "Major", "Minor", "Maxima", "Proxima", "Ultima",
                    "Core", "Centauri", "Terminus", "Nexus", "Locus", "Vertex", "Apex", "Nadir", "Primordial", 
                    "IX", "IV", "VI", "III", "II", "I", "VII", "VIII", "X",
                    "Archive", "Library", "Repository", "Compendium", "Collection", "Anthology", "Index", "Lexicon", "Chronicle"
                ],
                systemNamePatterns: [
                    "{prefix}",
                    "{prefix} {suffix}",
                    "{prefix}-{suffix}",
                    "{prefix} {number}",
                    "{prefix}-{number}",
                    "{letter}-{number}",
                    "{prefix} {letter}-{number}"
                ],
                baseTypeDescriptions: {
                    classic: "A traditional system with well-established celestial objects, offering reliable bonuses to your reading journey.",
                    academic: "A scholarly system with knowledge-focused celestial objects, increasing your research and understanding.",
                    modern: "A contemporary system with innovative celestial objects, providing efficient and varied bonuses.",
                    experimental: "An avant-garde system with unconventional celestial objects, offering unique and transformative bonuses.",
                    speculative: "A visionary system with imaginative celestial objects, expanding possibilities with creative bonuses."
                },
                baseRarityDescriptions: {
                    common: "A typical star system with standard resources.",
                    uncommon: "A noteworthy system with above-average resources.",
                    rare: "A remarkable system with valuable and uncommon resources.",
                    legendary: "An extraordinary system with powerful, rare resources.",
                    mythic: "A legendary system with transformative, unique resources."
                },
                // Types of celestial objects
                objectTypes: [
                    { type: "planet", name: "Planet", desc: "A stable celestial body orbiting the star", weight: 40, 
                      bonusCount: { min: 1, max: 2 }, bonusQuality: 1.0, },
                    { type: "moon", name: "Moon", desc: "A small celestial body orbiting a planet", weight: 30, 
                      bonusCount: { min: 1, max: 1 }, bonusQuality: 0.8 },
                    { type: "asteroid", name: "Asteroid Belt", desc: "A cluster of rocky bodies", weight: 15, 
                      bonusCount: { min: 1, max: 1 }, bonusQuality: 0.9 },
                    { type: "comet", name: "Comet", desc: "A celestial body with a distinctive tail", weight: 10, 
                      bonusCount: { min: 1, max: 2 }, bonusQuality: 1.2 },
                    { type: "nebula", name: "Nebula Pocket", desc: "A cloud of cosmic dust and gas", weight: 3, 
                      bonusCount: { min: 2, max: 2 }, bonusQuality: 1.4 },
                    { type: "anomaly", name: "Spatial Anomaly", desc: "A mysterious phenomenon in space", weight: 2, 
                      bonusCount: { min: 2, max: 3 }, bonusQuality: 1.7 }
                ],
                // Types of bonuses celestial objects can have
                celestialBonusTypes: [
                    { type: "kp_per_page", name: "KP per Page", desc: "{value}% increase to Knowledge Points per page", max: 20, minValue: 3, maxValue: 15 },
                    { type: "kp_per_minute", name: "KP per Minute", desc: "{value}% increase to Knowledge Points per minute", max: 20, minValue: 3, maxValue: 15 },
                    { type: "research_production", name: "Research Production", desc: "{value}% increase to Research Point generation", max: 25, minValue: 3, maxValue: 15 },
                    { type: "influence_gain", name: "Influence Gain", desc: "{value}% increase to Influence gained from books", max: 25, minValue: 3, maxValue: 15 },
                    { type: "xp_gain", name: "XP Gain", desc: "{value}% increase to Experience Points", max: 20, minValue: 3, maxValue: 15 },
                    { type: "completion_bonus", name: "Completion Bonus", desc: "{value}% bonus when completing books", max: 30, minValue: 5, maxValue: 20 },
                    { type: "passive_kp", name: "Passive KP", desc: "Generate {value} Knowledge Points per minute", max: 5, minValue: 0.3, maxValue: 2 },
                    { type: "passive_rp", name: "Passive RP", desc: "Generate {value} Research Points per minute", max: 3, minValue: 0.2, maxValue: 1.5 },
                    { type: "passive_inf", name: "Passive Influence", desc: "Generate {value} Influence per minute", max: 2, minValue: 0.1, maxValue: 1 },
                    { type: "discovery_chance", name: "Discovery Chance", desc: "{value}% increased chance to discover new systems", max: 30, minValue: 5, maxValue: 15 },
                    { type: "offline_bonus", name: "Offline Efficiency", desc: "Increases offline progression by {value}%", max: 25, minValue: 3, maxValue: 15 },
                    { type: "facility_boost", name: "Facility Output", desc: "Increases all facility outputs by {value}%", max: 20, minValue: 3, maxValue: 12 },
                    { type: "research_boost", name: "Research Efficiency", desc: "Increases research effects by {value}%", max: 20, minValue: 3, maxValue: 12 },
                    { type: "genre_bonus", name: "Genre Specialist", desc: "{value}% bonus for reading a specific genre", max: 40, minValue: 10, maxValue: 25 }
                ]
            },
            
            // Enlightenment/Prestige
            prestigeRequirements: {
                playerLevel: 7, // Reduced from 10
                booksCompleted: 10 // Reduced from 25
            },
            // EP calculation factors
            epCalculation: {
                levelFactor: 0.5,      // Each level gives 0.5 EP
                bookFactor: 0.5,       // Each book gives 0.5 EP (increased from 0.2)
                facilityFactor: 0.5,   // Each facility gives 0.5 EP
                researchFactor: 0.5,   // Each research gives 0.5 EP
                galaxyFactor: 1.0      // Each galaxy system gives 1.0 EP
            },
            // Permanent upgrade types
            enlightenmentUpgrades: [
                { id: "resource_production", name: "Resource Production", 
                  desc: "Permanently increases all resource production rates.", 
                  baseCost: 3, costScaling: 1.5, effect: { type: "percentage", value: 10, cap: 500 },
                  iconClass: "text-blue-500", iconSymbol: "📈" },
                { id: "starting_resources", name: "Starting Resources", 
                  desc: "Begin each prestige run with more resources.", 
                  baseCost: 3, costScaling: 1.5, effect: { type: "flat", kp: 25, rp: 10, inf: 5, cap: 50 },
                  iconClass: "text-green-500", iconSymbol: "💰" },
                { id: "reading_efficiency", name: "Reading Efficiency", 
                  desc: "Permanently increases knowledge gained from reading.", 
                  baseCost: 5, costScaling: 1.6, effect: { type: "percentage", value: 15, cap: 500 },
                  iconClass: "text-purple-500", iconSymbol: "📚" },
                { id: "experience_boost", name: "Experience Boost", 
                  desc: "Permanently increases experience gained from all sources.", 
                  baseCost: 4, costScaling: 1.5, effect: { type: "percentage", value: 12, cap: 500 },
                  iconClass: "text-yellow-500", iconSymbol: "⭐" },
                { id: "offline_progression", name: "Offline Progression", 
                  desc: "Increases the efficiency of offline progression.", 
                  baseCost: 3, costScaling: 1.4, effect: { type: "percentage", value: 10, cap: 100 },
                  iconClass: "text-gray-500", iconSymbol: "💤" },
                { id: "discovery_chance", name: "Discovery Chance", 
                  desc: "Increases chance of finding rare facilities, research, and celestial objects.", 
                  baseCost: 5, costScaling: 1.7, effect: { type: "percentage", value: 10, cap: 200 },
                  iconClass: "text-indigo-500", iconSymbol: "🔍" },
                { id: "auto_research", name: "Auto Research", 
                  desc: "Start with auto-researched technologies.", 
                  baseCost: 8, costScaling: 2.0, effect: { type: "level", value: 1, cap: 5 },
                  iconClass: "text-red-500", iconSymbol: "🔬" },
                { id: "facility_retention", name: "Facility Retention", 
                  desc: "Retain some facilities after prestige.", 
                  baseCost: 10, costScaling: 2.5, effect: { type: "level", value: 1, cap: 3 },
                  iconClass: "text-teal-500", iconSymbol: "🏗️" }
            ],
            
            // Galactic Relics
            relicTypes: [
                { id: "ancient_codex", name: "Ancient Codex", 
                  desc: "A mysterious book containing universal knowledge that persists across time and space.", 
                  rarity: "legendary", chance: 0.01, effect: { type: "multiplier", target: "all_resources", value: 1.25 },
                  icon: "📜", color: "text-yellow-500" },
                { id: "stellar_compass", name: "Stellar Compass", 
                  desc: "A device used by cosmic navigators to traverse the literary galaxy with unerring precision.", 
                  rarity: "epic", chance: 0.03, effect: { type: "flat", target: "exploration_range", value: 2 },
                  icon: "🧭", color: "text-blue-500" },
                { id: "lexicon_crystal", name: "Lexicon Crystal", 
                  desc: "A crystalline structure that resonates with the frequency of knowledge itself.", 
                  rarity: "rare", chance: 0.05, effect: { type: "multiplier", target: "knowledge_points", value: 1.5 },
                  icon: "💎", color: "text-purple-500" },
                { id: "quantum_quill", name: "Quantum Quill", 
                  desc: "A writing implement that exists simultaneously in all possible literary worlds.", 
                  rarity: "epic", chance: 0.03, effect: { type: "multiplier", target: "book_completion", value: 2.0 },
                  icon: "✒️", color: "text-indigo-500" },
                { id: "temporal_bookmark", name: "Temporal Bookmark", 
                  desc: "A marker that allows the reader to hold their place across multiple dimensions and realities.", 
                  rarity: "rare", chance: 0.05, effect: { type: "percentage", target: "offline_efficiency", value: 50 },
                  icon: "🔖", color: "text-red-500" },
                { id: "philosophers_stone", name: "Philosopher's Stone", 
                  desc: "The legendary alchemical substance capable of transmuting ignorance into knowledge.", 
                  rarity: "legendary", chance: 0.01, effect: { type: "multiplier", target: "experience_gain", value: 1.75 },
                  icon: "🔮", color: "text-green-500" }
            ],
            
            // Genre colors for custom genres
            genreColors: [
                'blue-600',
                'purple-600',
                'green-600',
                'yellow-600',
                'red-600',
                'pink-600',
                'indigo-600',
                'teal-600',
                'orange-600'
            ]
        };
        
        // ================================================
        // Procedural Generation Functions
        // ================================================
        
        // Generate a random adjective
        function getRandomFromArray(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // Generate a random name from a pattern
        function generateNameFromPattern(pattern, components) {
            let name = pattern;
            // Replace each placeholder with a random value from the corresponding array
            for (const [key, values] of Object.entries(components)) {
                const regex = new RegExp(`{${key}}`, 'g');
                name = name.replace(regex, getRandomFromArray(values));
            }
            
            // Replace any {number} with a random number between 1-999
            name = name.replace(/{number}/g, () => Math.floor(Math.random() * 999) + 1);
            
            // Replace any {letter} with a random capital letter
            name = name.replace(/{letter}/g, () => String.fromCharCode(65 + Math.floor(Math.random() * 26)));
            
            return name;
        }
        
        // Generate a random facility
        function generateRandomFacility() {
            // Determine rarity using weighted random selection
            const rarityRoll = Math.random();
            let cumulativeChance = 0;
            let selectedRarity = gameConfig.facilities.rarities[0]; // Default to common
            
            for (const rarity of gameConfig.facilities.rarities) {
                cumulativeChance += rarity.chance;
                if (rarityRoll < cumulativeChance) {
                    selectedRarity = rarity;
                    break;
                }
            }
            
            // Apply any discovery chance bonuses from research and facilities
            const discoveryBonus = calculateTotalBonus('discovery_chance') / 100;
            if (discoveryBonus > 0 && rarityRoll < discoveryBonus) {
                // Bump up rarity if discovery bonus triggers
                const currentIndex = gameConfig.facilities.rarities.findIndex(r => r.id === selectedRarity.id);
                if (currentIndex < gameConfig.facilities.rarities.length - 1) {
                    selectedRarity = gameConfig.facilities.rarities[currentIndex + 1];
                }
            }
            
            // Generate name
            const namePattern = getRandomFromArray(gameConfig.facilities.namePatterns);
            const nameComponents = {
                adjective: gameConfig.facilities.adjectives,
                noun: gameConfig.facilities.nouns,
                cosmic: gameConfig.facilities.cosmicObjects,
                concept: gameConfig.facilities.concepts
            };
            
            const name = generateNameFromPattern(namePattern, nameComponents);
            
            // Determine number of effects based on rarity
            const effectCount = Math.floor(Math.random() * 
                (selectedRarity.effectCount.max - selectedRarity.effectCount.min + 1)) 
                + selectedRarity.effectCount.min;
            
            // Select random effects
            const possibleEffects = [...gameConfig.facilities.effectTypes];
            const selectedEffects = [];
            
            for (let i = 0; i < effectCount; i++) {
                if (possibleEffects.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * possibleEffects.length);
                const effect = possibleEffects.splice(randomIndex, 1)[0];
                
                // Calculate a value for the effect based on rarity
                let value;
                if (effect.valueType === "flat") {
                    // For flat values (e.g., +1, +2, etc.)
                    const [min, max] = effect.valueRange;
                    value = min + Math.random() * (max - min);
                    // Apply quality multiplier based on rarity
                    value *= selectedRarity.effectQuality;
                    // Round to 1 decimal place
                    value = Math.round(value * 10) / 10;
                } else {
                    // For percentage values
                    const [min, max] = effect.valueRange;
                    value = min + Math.random() * (max - min);
                    // Apply quality multiplier based on rarity
                    value *= selectedRarity.effectQuality;
                    // Round to nearest integer
                    value = Math.round(value);
                }
                
                // Ensure value doesn't exceed maximum
                value = Math.min(value, effect.max);
                
                selectedEffects.push({
                    id: effect.id,
                    name: effect.name,
                    desc: effect.desc.replace('{value}', value),
                    value: value,
                    icon: effect.icon,
                    scalingFactor: effect.scalingFactor
                });
            }
            
            // Calculate costs
            const baseCost = gameConfig.facilityBaseCost;
            const upgradeBase = baseCost * selectedRarity.upgradeCostFactor;
            
            // Generate icon color variables
            const colors = [
                getRandomFromArray(['#5D5CDE', '#4F46E5', '#3730A3', '#6366F1']), // Blue-purple range
                getRandomFromArray(['#EC4899', '#BE185D', '#DB2777', '#F472B6']), // Pink range
                getRandomFromArray(['#10B981', '#059669', '#34D399', '#6EE7B7']), // Green range
                getRandomFromArray(['#F97316', '#EA580C', '#FB923C', '#FDBA74']), // Orange range
                getRandomFromArray(['#8B5CF6', '#7C3AED', '#A78BFA', '#C4B5FD'])  // Purple range
            ];
            
            const color1 = getRandomFromArray(colors);
            let color2 = getRandomFromArray(colors);
            // Make sure color2 is different from color1
            while (color2 === color1) {
                color2 = getRandomFromArray(colors);
            }
            
            // Generate a unique ID
            const id = 'facility_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            // Create the facility object
            return {
                id: id,
                name: name,
                rarity: selectedRarity.id,
                rarityName: selectedRarity.name,
                colorClass: selectedRarity.colorClass,
                description: `A ${selectedRarity.name.toLowerCase()} facility that ${selectedEffects.length === 1 ? 'enhances' : 'provides multiple improvements to'} your reading journey.`,
                effects: selectedEffects,
                level: 0,
                maxLevel: 25, // Facilities can be upgraded up to level 25
                built: false,
                cost: baseCost,
                upgradeCost: upgradeBase,
                upgradeCostMultiplier: 1 + (selectedRarity.upgradeCostFactor * 0.1), // How much cost increases per level
                colors: {
                    primary: color1,
                    secondary: color2
                },
                discoveryDate: Date.now()
            };
        }
        
        // Generate a random research technology
        function generateRandomResearch() {
            // Determine rarity using weighted random selection
            const rarityRoll = Math.random();
            let cumulativeChance = 0;
            let selectedRarity = gameConfig.research.rarities[0]; // Default to common
            
            for (const rarity of gameConfig.research.rarities) {
                cumulativeChance += rarity.chance;
                if (rarityRoll < cumulativeChance) {
                    selectedRarity = rarity;
                    break;
                }
            }
            
            // Apply any discovery chance bonuses from research and facilities
            const discoveryBonus = calculateTotalBonus('discovery_chance') / 100;
            if (discoveryBonus > 0 && rarityRoll < discoveryBonus) {
                // Bump up rarity if discovery bonus triggers
                const currentIndex = gameConfig.research.rarities.findIndex(r => r.id === selectedRarity.id);
                if (currentIndex < gameConfig.research.rarities.length - 1) {
                    selectedRarity = gameConfig.research.rarities[currentIndex + 1];
                }
            }
            
            // Generate name
            const namePattern = getRandomFromArray(gameConfig.research.namePatterns);
            const nameComponents = {
                adjective: gameConfig.research.adjectives,
                noun: gameConfig.research.nouns,
                concept: gameConfig.research.concepts,
                theory: gameConfig.research.theories
            };
            
            const name = generateNameFromPattern(namePattern, nameComponents);
            
            // Determine number of effects based on rarity
            const effectCount = Math.floor(Math.random() * 
                (selectedRarity.effectCount.max - selectedRarity.effectCount.min + 1)) 
                + selectedRarity.effectCount.min;
            
            // Select random effects
            const possibleEffects = [...gameConfig.research.effectTypes];
            const selectedEffects = [];
            
            for (let i = 0; i < effectCount; i++) {
                if (possibleEffects.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * possibleEffects.length);
                const effect = possibleEffects.splice(randomIndex, 1)[0];
                
                // Calculate a value for the effect based on rarity
                let value;
                if (effect.valueType === "flat") {
                    // For flat values (e.g., +1, +2, etc.)
                    const [min, max] = effect.valueRange;
                    value = min + Math.random() * (max - min);
                    // Apply quality multiplier based on rarity
                    value *= selectedRarity.effectQuality;
                    // Round to 1 decimal place
                    value = Math.round(value * 10) / 10;
                } else {
                    // For percentage values
                    const [min, max] = effect.valueRange;
                    value = min + Math.random() * (max - min);
                    // Apply quality multiplier based on rarity
                    value *= selectedRarity.effectQuality;
                    // Round to nearest integer
                    value = Math.round(value);
                }
                
                // Ensure value doesn't exceed maximum
                value = Math.min(value, effect.max);
                
                selectedEffects.push({
                    id: effect.id,
                    name: effect.name,
                    desc: effect.desc.replace('{value}', value),
                    value: value,
                    icon: effect.icon
                });
            }
            
            // Calculate cost based on rarity
            const baseCost = gameConfig.researchBaseCost * selectedRarity.costFactor;
            const finalCost = Math.round(baseCost);
            
            // Generate a unique ID
            const id = 'research_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            // Create the research object
            return {
                id: id,
                name: name,
                rarity: selectedRarity.id,
                rarityName: selectedRarity.name,
                colorClass: selectedRarity.colorClass,
                description: `A ${selectedRarity.name.toLowerCase()} research technology that ${selectedEffects.length === 1 ? 'enhances' : 'provides multiple improvements to'} your reading capabilities.`,
                effects: selectedEffects,
                researched: false,
                cost: finalCost,
                discoveryDate: Date.now()
            };
        }
        
        // Generate a random star system for the galaxy
        function generateRandomSystem() {
            // Generate random coordinates within exploration range
            let x, y, distance;
            const maxAttempts = 20;
            let attempts = 0;
            
            // Keep trying until we find coordinates that aren't too close to existing systems
            do {
                // Random angle
                const angle = Math.random() * Math.PI * 2;
                
                // Random distance within exploration range
                const randomFactor = 0.3 + Math.random() * 0.7; // 30-100% of max range
                distance = gameState.galaxy.explorationRange * randomFactor;
                
                // Calculate coordinates
                x = Math.round(Math.cos(angle) * distance * 10) / 10;
                y = Math.round(Math.sin(angle) * distance * 10) / 10;
                
                // Check if too close to existing systems
                const tooClose = Object.values(gameState.galaxy.discoveredSystems).some(system => {
                    const dx = system.coordinates.x - x;
                    const dy = system.coordinates.y - y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    return dist < 0.5; // Minimum distance between systems
                });
                
                if (!tooClose) break;
                attempts++;
            } while (attempts < maxAttempts);
            
            // Generate system properties
            const systemId = `system-${Date.now()}`;
            const systemType = weightedRandomChoice(gameConfig.galaxy.systemTypes);
            
            // Weighted random rarity
            const rarityChoice = weightedRandomFromArray(gameConfig.galaxy.systemRarities);
            
            // Generate system name
            const name = generateSystemName();
            
            // Determine number of celestial objects based on rarity
            const objectCounts = {
                'common': 1 + Math.floor(Math.random() * 2), // 1-2
                'uncommon': 2 + Math.floor(Math.random() * 2), // 2-3
                'rare': 3 + Math.floor(Math.random() * 2), // 3-4
                'legendary': 4 + Math.floor(Math.random() * 2), // 4-5
                'mythic': 5 + Math.floor(Math.random() * 2) // 5-6
            };
            
            const numObjects = objectCounts[rarityChoice];
            
            // Generate celestial objects
            const celestialObjects = [];
            for (let i = 0; i < numObjects; i++) {
                celestialObjects.push(generateCelestialObject(systemId, i, rarityChoice));
            }
            
            // Create system description based on type and rarity
            const typeDesc = gameConfig.galaxy.baseTypeDescriptions[systemType];
            const rarityDesc = gameConfig.galaxy.baseRarityDescriptions[rarityChoice];
            
            let description = `${rarityDesc} ${typeDesc}`;
            
            // Add variety based on distance
            if (distance > gameState.galaxy.explorationRange * 0.8) {
                description = `Located at the edges of known space, this ${description.toLowerCase()}`;
            } else if (distance < gameState.galaxy.explorationRange * 0.3) {
                description = `Situated relatively close to home, this ${description.toLowerCase()}`;
            }
            
            // Create the system object
            return {
                id: systemId,
                name: name,
                coordinates: { x, y },
                type: systemType,
                rarity: rarityChoice,
                discovered: true,
                outpostEstablished: false,
                description: description,
                celestialObjects: celestialObjects,
                discoveryDate: Date.now()
            };
        }
        
        // Generate a celestial object
        function generateCelestialObject(systemId, index, systemRarity) {
            // Determine the type of celestial object
            const objectType = weightedRandomChoice(gameConfig.galaxy.objectTypes, 'weight');
            
            // Generate object name
            const name = generateCelestialObjectName(objectType.type);
            
            // Generate bonuses based on object type and system rarity
            const bonuses = [];
            
            // Determine number of bonuses based on object type
            const bonusCount = Math.floor(Math.random() * 
                (objectType.bonusCount.max - objectType.bonusCount.min + 1)) 
                + objectType.bonusCount.min;
            
            // Bonus values are higher for rarer systems
            const bonusMultipliers = {
                'common': 0.7,
                'uncommon': 0.9,
                'rare': 1.1,
                'legendary': 1.3,
                'mythic': 1.5
            };
            
            const multiplier = bonusMultipliers[systemRarity] * objectType.bonusQuality;
            
            // Generate the bonuses
            const possibleBonusTypes = [...gameConfig.galaxy.celestialBonusTypes];
            
            for (let i = 0; i < bonusCount; i++) {
                if (possibleBonusTypes.length === 0) break;
                
                // Pick a random bonus type
                const randomIndex = Math.floor(Math.random() * possibleBonusTypes.length);
                const bonusType = possibleBonusTypes.splice(randomIndex, 1)[0];
                
                // Calculate a value for the bonus based on min/max and multiplier
                let value;
                
                if (bonusType.type.includes('passive_')) {
                    // For passive resource generation (uses decimals)
                    value = bonusType.minValue + Math.random() * (bonusType.maxValue - bonusType.minValue);
                    value *= multiplier;
                    value = Math.round(value * 10) / 10; // Round to 1 decimal
                    value = Math.max(0.1, Math.min(bonusType.max, value)); // Ensure within bounds
                } else {
                    // For percentage-based bonuses (uses integers)
                    value = bonusType.minValue + Math.random() * (bonusType.maxValue - bonusType.minValue);
                    value *= multiplier;
                    value = Math.round(value);
                    value = Math.max(1, Math.min(bonusType.max, value)); // Ensure within bounds
                }
                
                // For genre bonus, pick a random genre
                let genreType = null;
                if (bonusType.type === 'genre_bonus') {
                    const genres = ['sci-fi', 'fantasy', 'non-fiction', 'mystery', 'history', 'science', 'biography'];
                    genreType = genres[Math.floor(Math.random() * genres.length)];
                }
                
                bonuses.push({
                    type: bonusType.type,
                    name: bonusType.name,
                    desc: bonusType.desc.replace('{value}', value),
                    value: value,
                    genre: genreType
                });
            }
            
            // Generate a description based on the object type and bonuses
            let description = `A ${randomAdjectiveForObject(objectType.type)} ${objectType.name.toLowerCase()} `;
            
            if (bonuses.length === 0) {
                description += 'with undiscovered potential.';
            } else if (bonuses.length === 1) {
                description += `that provides ${bonuses[0].desc.toLowerCase()}.`;
            } else {
                description += 'that provides multiple bonuses to your reading empire.';
            }
            
            return {
                id: `${systemId}-object-${index}`,
                name: name,
                type: objectType.type,
                typeName: objectType.name,
                colonized: false,
                bonuses: bonuses,
                description: description
            };
        }
        
        // Generate a name for a celestial object
        function generateCelestialObjectName(type) {
            const prefixes = gameConfig.galaxy.objectNamePrefixes;
            const suffixes = gameConfig.galaxy.objectNameSuffixes;
            
            const prefix = getRandomFromArray(prefixes);
            const suffix = getRandomFromArray(suffixes);
            
            // 30% chance for a simple name with just a prefix and designation
            if (Math.random() < 0.3) {
                const number = Math.floor(Math.random() * 999) + 1;
                return `${prefix}-${number}`;
            }
            
            // Otherwise use prefix + suffix
            return `${prefix} ${suffix}`;
        }
        
        // Generate a random system name
        function generateSystemName() {
            const patterns = gameConfig.galaxy.systemNamePatterns;
            const pattern = getRandomFromArray(patterns);
            
            // Choose random prefix and suffix from literary themes
            const prefixOptions = [
                // Random cosmic prefixes
                "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Theta", "Kappa",
                "Nova", "Nebula", "Pulsar", "Orion", "Andromeda", "Lyra", "Pegasus", "Aquila",
                "Vega", "Polaris", "Sirius", "Arcturus", "Antares", "Canopus", "Rigel", "Procyon",
                "Aldebaran", "Castor", "Pollux", "Regulus", "Spica", "Altair", "Deneb", "Fomalhaut",
                // Literary-inspired prefixes
                "Quill", "Lexicon", "Codex", "Tome", "Saga", "Epic", "Fable", "Hymn",
                "Chronicle", "Verse", "Sonnet", "Stanza", "Lore", "Prose", "Rhyme", "Script",
                "Mythos", "Atlas", "Archive", "Grimoire", "Folio", "Scroll", "Libri", "Canon",
                "Opus", "Scribe", "Muse", "Poet", "Bard", "Logos", "Novella", "Compendium"
            ];
            
            const suffixOptions = [
                // Numeric and sector suffixes
                "Prime", "Major", "Minor", "Sector", "Quadrant", "Reach", "Expanse", "Void",
                "Cluster", "Nexus", "Core", "Rim", "Belt", "Cloud", "Stream", "Chain",
                // Literary-inspired suffixes
                "Archive", "Lexicon", "Library", "Repository", "Vault", "Sanctuary", "Academy", "Haven",
                "Athenaeum", "Collection", "Anthology", "Index", "Concordance", "Testament", "Compendium", "Tome"
            ];
            
            // Generate a few letters and numbers for patterns
            const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // A-Z
            const number = Math.floor(Math.random() * 999) + 1;
            
            // Replace placeholders in the pattern
            return pattern
                .replace('{prefix}', getRandomFromArray(prefixOptions))
                .replace('{suffix}', getRandomFromArray(suffixOptions))
                .replace('{letter}', letter)
                .replace('{number}', number);
        }
        
        // Generate a random adjective for celestial objects
        function randomAdjectiveForObject(type) {
            const typeAdjectives = {
                'planet': ["verdant", "arid", "frozen", "temperate", "humid", "barren", "lush", "volcanic", "ringed", "twin"],
                'moon': ["cratered", "desolate", "icy", "mysterious", "shadowed", "luminous", "silvery", "distant", "orbital"],
                'asteroid': ["dense", "metallic", "scattered", "crystalline", "mineral-rich", "ancient", "drifting", "chaotic"],
                'comet': ["blazing", "iridescent", "hyperbolic", "periodic", "trailing", "brilliant", "swift", "radiant"],
                'nebula': ["glowing", "gaseous", "ionized", "stellar", "fluorescent", "ethereal", "colorful", "vast"],
                'anomaly': ["pulsing", "unstable", "enigmatic", "paradoxical", "impossible", "reality-bending", "bizarre"]
            };
            
            const commonAdjectives = [
                "mysterious", "ancient", "magnificent", "cosmic", "notable", "remarkable", "intriguing", 
                "fascinating", "wondrous", "impressive", "captivating", "striking", "grand", "spectacular"
            ];
            
            // Use type-specific adjectives if available, otherwise use common ones
            const adjectivePool = typeAdjectives[type] || commonAdjectives;
            return getRandomFromArray(adjectivePool);
        }
        
        // Generate a galactic relic
        function generateRandomRelic() {
            // Choose a relic type with weighted probability
            const rarityRoll = Math.random();
            let selectedRelic = null;
            
            for (const relic of gameConfig.relicTypes) {
                if (rarityRoll <= relic.chance) {
                    selectedRelic = {...relic};
                    break;
                }
            }
            
            // If no relic was selected (improbable but possible), choose one randomly
            if (!selectedRelic) {
                selectedRelic = {...gameConfig.relicTypes[Math.floor(Math.random() * gameConfig.relicTypes.length)]};
            }
            
            // Generate a unique ID
            selectedRelic.id = 'relic_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            selectedRelic.discoveryDate = Date.now();
            
            return selectedRelic;
        }
        
        // Helper function: Choose random item from array
        function weightedRandomChoice(array, weightProperty = null) {
            if (weightProperty === null) {
                return array[Math.floor(Math.random() * array.length)];
            }
            
            // Calculate total weight
            const totalWeight = array.reduce((sum, item) => sum + item[weightProperty], 0);
            
            // Get a random weight value
            let randomWeight = Math.random() * totalWeight;
            
            // Find the item that corresponds to the random weight
            for (const item of array) {
                randomWeight -= item[weightProperty];
                if (randomWeight <= 0) {
                    return item;
                }
            }
            
            // Fallback
            return array[0];
        }
        
        // Helper function: Get weighted random item from array of {item, weight} objects
        function weightedRandomFromArray(weightedArray) {
            // Calculate total weight
            const totalWeight = weightedArray.reduce((sum, item) => sum + item.weight, 0);
            
            // Get a random weight value
            let randomWeight = Math.random() * totalWeight;
            
            // Find the item that corresponds to the random weight
            for (const item of weightedArray) {
                randomWeight -= item.weight;
                if (randomWeight <= 0) {
                    return item.rarity;
                }
            }
            
            // Fallback
            return weightedArray[0].rarity;
        }
        
        // ================================================
        // Game Core Logic
        // ================================================
        
        // Calculate total bonus for a specific effect type from all sources
        function calculateTotalBonus(effectType) {
            let totalBonus = 0;
            
            // Check all built facilities
            for (const facilityId in gameState.facilities) {
                const facility = gameState.facilities[facilityId];
                
                if (facility.built) {
                    for (const effect of facility.effects) {
                        if (effect.id === effectType) {
                            // Calculate scaled effect based on facility level
                            let scaledValue = effect.value * (1 + (facility.level * effect.scalingFactor));
                            totalBonus += scaledValue;
                        }
                    }
                }
            }
            
            // Check all researched technologies
            for (const researchId in gameState.research) {
                const research = gameState.research[researchId];
                
                // Skip core research types that aren't effect objects
                if (typeof research !== 'object' || research === null) continue;
                
                if (research.researched) {
                    for (const effect of research.effects || []) {
                        if (effect.id === effectType) {
                            totalBonus += effect.value;
                        }
                    }
                }
            }
            
            // Check active celestial objects
            for (const object of gameState.galaxy.activeCelestialObjects) {
                for (const bonus of object.bonuses || []) {
                    if (bonus.type === effectType) {
                        totalBonus += bonus.value;
                    }
                }
            }
            
            // Check permanent enlightenment upgrades
            for (const upgradeId in gameState.prestige.permanentUpgrades) {
                const upgrade = gameState.prestige.permanentUpgrades[upgradeId];
                
                // Check if this upgrade affects the requested effect type
                if (upgradeId === effectType || 
                    (upgradeId === 'resource_production' && 
                     (effectType.includes('_passive') || effectType.includes('_multiplier')))) {
                    totalBonus += upgrade.value;
                }
            }
            
            // Check galactic relics
            for (const relicId in gameState.relics) {
                const relic = gameState.relics[relicId];
                
                if (relic.effect.target === effectType || 
                    (relic.effect.target === 'all_resources' && 
                     (effectType.includes('_passive') || effectType.includes('_multiplier')))) {
                    if (relic.effect.type === 'multiplier') {
                        // Multiplier effects are applied differently
                        totalBonus *= relic.effect.value;
                    } else if (relic.effect.type === 'percentage') {
                        totalBonus += relic.effect.value;
                    } else if (relic.effect.type === 'flat' && relic.effect.target === effectType) {
                        totalBonus += relic.effect.value;
                    }
                }
            }
            
            return totalBonus;
        }
        
        // Calculate knowledge points for reading
        function calculateReadingKp(pages, minutes, difficulty) {
            let kpFromPages = pages * gameConfig.baseKpPerPage;
            let kpFromTime = minutes * gameConfig.baseKpPerMinute;
            
            // Apply difficulty multiplier
            let difficultyMultiplier = gameConfig.difficultyMultipliers[difficulty];
            let totalKp = (kpFromPages + kpFromTime) * difficultyMultiplier;
            
            // Apply kp_per_page bonus
            const pageBonus = calculateTotalBonus('kp_per_page');
            if (pageBonus > 0) {
                kpFromPages *= (1 + (pageBonus / 100));
            }
            
            // Apply kp_per_min bonus
            const timeBonus = calculateTotalBonus('kp_per_min');
            if (timeBonus > 0) {
                kpFromTime *= (1 + (timeBonus / 100));
            }
            
            // Apply reading_efficiency bonus from research
            const readingEfficiency = calculateTotalBonus('reading_efficiency');
            if (readingEfficiency > 0) {
                totalKp *= (1 + (readingEfficiency / 100));
            }
            
            // Apply kp_multiplier bonus from research
            const kpMultiplier = calculateTotalBonus('kp_multiplier');
            if (kpMultiplier > 0) {
                totalKp *= (1 + (kpMultiplier / 100));
            }
            
            return Math.floor(totalKp);
        }
        
        // Add experience points and check for level up
        function addExperience(amount) {
            // Apply XP bonuses
            const xpBonus = calculateTotalBonus('xp_bonus');
            if (xpBonus > 0) {
                amount *= (1 + (xpBonus / 100));
            }
            
            const xpMultiplier = calculateTotalBonus('xp_multiplier');
            if (xpMultiplier > 0) {
                amount *= (1 + (xpMultiplier / 100));
            }
            
            gameState.player.experiencePoints += amount;
            
            // Check for level up
            if (gameState.player.experiencePoints >= gameState.player.experienceToNextLevel) {
                gameState.player.experiencePoints -= gameState.player.experienceToNextLevel;
                gameState.player.level += 1;
                gameState.player.experienceToNextLevel = Math.floor(gameState.player.experienceToNextLevel * 1.5);
                
                showNotification(`Level up! You are now level ${gameState.player.level}`, 'success');
                
                // Check for new unlocks
                checkUnlocks();
            }
        }
        
        // Calculate passive resource generation
        function calculatePassiveResources(elapsedMs) {
            const minutes = elapsedMs / (60 * 1000); // Convert ms to minutes
            let kpGain = 0;
            let rpGain = 0;
            let influenceGain = 0;
            
            // Apply passive generation from facilities
            for (const facilityId in gameState.facilities) {
                const facility = gameState.facilities[facilityId];
                
                if (facility.built) {
                    for (const effect of facility.effects) {
                        // Calculate scaled effect based on facility level
                        let scaledValue = effect.value * (1 + (facility.level * effect.scalingFactor));
                        
                        if (effect.id === 'kp_passive') {
                            kpGain += scaledValue * minutes;
                        } else if (effect.id === 'rp_passive') {
                            rpGain += scaledValue * minutes;
                        } else if (effect.id === 'inf_passive') {
                            influenceGain += scaledValue * minutes;
                        }
                    }
                }
            }
            
            // Apply passive generation from celestial objects
            for (const object of gameState.galaxy.activeCelestialObjects) {
                for (const bonus of object.bonuses) {
                    if (bonus.type === 'passive_kp') {
                        kpGain += bonus.value * minutes;
                    } else if (bonus.type === 'passive_rp') {
                        rpGain += bonus.value * minutes;
                    } else if (bonus.type === 'passive_inf') {
                        influenceGain += bonus.value * minutes;
                    }
                }
            }
            
            // Apply resource multipliers
            const kpMultiplier = calculateTotalBonus('kp_multiplier');
            if (kpMultiplier > 0) {
                kpGain *= (1 + (kpMultiplier / 100));
            }
            
            const rpMultiplier = calculateTotalBonus('rp_multiplier');
            if (rpMultiplier > 0) {
                rpGain *= (1 + (rpMultiplier / 100));
            }
            
            const infMultiplier = calculateTotalBonus('inf_multiplier');
            if (infMultiplier > 0) {
                influenceGain *= (1 + (infMultiplier / 100));
            }
            
            return {
                knowledgePoints: Math.floor(kpGain),
                researchPoints: Math.floor(rpGain),
                influence: Math.floor(influenceGain)
            };
        }
        
        // Calculate offline progression
        function calculateOfflineProgression() {
            // Check if offline progression is enabled
            if (!gameState.settings.offlineProgression) return null;
            
            const now = Date.now();
            const lastOnline = gameState.lastOnline;
            const elapsedMs = now - lastOnline;
            
            // Don't calculate if less than a minute has passed
            if (elapsedMs < 60000) return null;
            
            // Get base resource generation
            let resources = calculatePassiveResources(elapsedMs);
            
            // Apply offline efficiency setting (default 50%)
            const baseEfficiency = gameState.settings.offlineEfficiency / 100;
            
            // Apply offline bonus from facilities, research, and enlightenment
            const offlineBonus = calculateTotalBonus('offline_bonus') / 100;
            const offlineProgress = calculateTotalBonus('offline_progress') / 100;
            
            // Calculate final efficiency (base + bonuses, capped at 100%)
            const finalEfficiency = Math.min(1, baseEfficiency + offlineBonus + offlineProgress);
            
            // Apply efficiency to resource gains
            resources.knowledgePoints = Math.floor(resources.knowledgePoints * finalEfficiency);
            resources.researchPoints = Math.floor(resources.researchPoints * finalEfficiency);
            resources.influence = Math.floor(resources.influence * finalEfficiency);
            
            // Format elapsed time for display
            let formattedTime = '';
            const hours = Math.floor(elapsedMs / (60 * 60 * 1000));
            const minutes = Math.floor((elapsedMs % (60 * 60 * 1000)) / (60 * 1000));
            
            if (hours > 0) {
                formattedTime = `${hours} hour${hours > 1 ? 's' : ''} ${minutes} minute${minutes > 1 ? 's' : ''}`;
            } else {
                formattedTime = `${minutes} minute${minutes > 1 ? 's' : ''}`;
            }
            
            return {
                resources: resources,
                time: formattedTime,
                efficiency: Math.round(finalEfficiency * 100)
            };
        }
        
        // Update UI with current game state
        function updateUI() {
            // Update resource displays
            document.getElementById('knowledge-points').textContent = Math.floor(gameState.resources.knowledgePoints);
            document.getElementById('research-points').textContent = Math.floor(gameState.resources.researchPoints);
            document.getElementById('influence').textContent = Math.floor(gameState.resources.influence);
            document.getElementById('galaxy-influence').textContent = Math.floor(gameState.resources.influence);
            
            // Update player stats
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('books-read').textContent = gameState.stats.booksCompleted;
            document.getElementById('prestige-level').textContent = gameState.prestige.level;
            
            // Calculate passive RP generation
            let passiveRP = 0;
            for (const facilityId in gameState.facilities) {
                const facility = gameState.facilities[facilityId];
                if (facility.built) {
                    for (const effect of facility.effects) {
                        if (effect.id === 'rp_passive') {
                            let scaledValue = effect.value * (1 + (facility.level * effect.scalingFactor));
                            passiveRP += scaledValue;
                        }
                    }
                }
            }
            
            // Add passive RP from celestial objects
            for (const object of gameState.galaxy.activeCelestialObjects) {
                for (const bonus of object.bonuses) {
                    if (bonus.type === 'passive_rp') {
                        passiveRP += bonus.value;
                    }
                }
            }
            
            // Apply RP multiplier
            const rpMultiplier = calculateTotalBonus('rp_multiplier');
            if (rpMultiplier > 0) {
                passiveRP *= (1 + (rpMultiplier / 100));
            }
            
            document.getElementById('passive-rp').textContent = passiveRP.toFixed(1);
            
            // Update enlightenment points
            document.getElementById('enlightenment-points').textContent = gameState.prestige.enlightenmentPoints;
            
            // Update stats tab
            document.getElementById('stat-total-books').textContent = gameState.stats.booksCompleted;
            document.getElementById('stat-total-pages').textContent = gameState.stats.pagesRead;
            document.getElementById('stat-total-minutes').textContent = gameState.stats.minutesRead;
            document.getElementById('stat-total-kp').textContent = Math.floor(gameState.stats.totalKpGenerated);
            
            // Update discovery stats
            document.getElementById('discovered-facilities').textContent = gameState.stats.facilitiesDiscovered;
            document.getElementById('discovered-research').textContent = gameState.stats.researchDiscovered;
            document.getElementById('discovered-systems').textContent = gameState.galaxy.stats.systemsDiscovered;
            document.getElementById('colonized-planets').textContent = gameState.galaxy.stats.objectsColonized;
            
            // Update genre distribution
            updateGenreDistribution();
            
            // Update achievement progress
            document.getElementById('bookworm-progress').textContent = Math.min(gameState.stats.booksCompleted, 3);
            document.getElementById('prolific-progress').textContent = Math.min(gameState.stats.pagesRead, 500);
            
            // Update prestige stats
            document.getElementById('lifetime-prestige').textContent = gameState.lifetimeStats.totalPrestiges;
            document.getElementById('lifetime-ep').textContent = gameState.lifetimeStats.totalEnlightenmentPoints;
            document.getElementById('max-level').textContent = gameState.lifetimeStats.maxLevel;
            document.getElementById('max-books').textContent = gameState.lifetimeStats.maxBooks;
            
            // Update current reading list
            updateCurrentReadingList();
            
            // Update facilities UI
            updateFacilitiesUI();
            
            // Update research UI
            updateResearchUI();
            
            // Update Galaxy UI
            updateGalaxyUI();
            
            // Update Enlightenment UI
            updateEnlightenmentUI();
            
            // Update core research buttons
            updateCoreResearchButtons();
            
            // Update facility discovery button cost
            const facilityDiscoveryCost = gameConfig.facilityBaseCost;
            const facilityDiscountBonus = calculateTotalBonus('facility_discount');
            const discountedCost = facilityDiscountBonus > 0 
                ? Math.floor(facilityDiscoveryCost * (1 - (facilityDiscountBonus / 100))) 
                : facilityDiscoveryCost;
            
            document.getElementById('discover-facility-btn').textContent = `Discover New Facility (${discountedCost} KP)`;
            
            // Update research discovery button cost
            const researchDiscoveryCost = gameConfig.researchBaseCost;
            const researchDiscountBonus = calculateTotalBonus('research_discount');
            const discountedResearchCost = researchDiscountBonus > 0 
                ? Math.floor(researchDiscoveryCost * (1 - (researchDiscountBonus / 100))) 
                : researchDiscoveryCost;
            
            document.getElementById('discover-research-btn').textContent = `Discover New Research (${discountedResearchCost} RP)`;
            
            // Update galaxy discovery button cost
            document.getElementById('discover-system-btn').textContent = `Explore (${gameState.galaxy.nextSystemCost} CI)`;
            
            // Save the game
            saveGame();
        }
        
        // Update genre distribution in stats tab
        function updateGenreDistribution() {
            const genreDistributionContainer = document.getElementById('genre-distribution');
            if (!genreDistributionContainer) return;
            
            // Clear the container
            genreDistributionContainer.innerHTML = '';
            
            // Get total books
            const totalBooks = gameState.stats.booksCompleted;
            if (totalBooks === 0) {
                genreDistributionContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No books completed yet.</div>';
                return;
            }
            
            // Add standard genres
            const standardGenres = [
                { key: 'sci-fi', name: 'Science Fiction' },
                { key: 'fantasy', name: 'Fantasy' },
                { key: 'non-fiction', name: 'Non-Fiction' },
                { key: 'mystery', name: 'Mystery/Thriller' },
                { key: 'history', name: 'History' },
                { key: 'science', name: 'Science' },
                { key: 'biography', name: 'Biography' }
            ];
            
            standardGenres.forEach(genre => {
                const count = gameState.stats.genreDistribution[genre.key] || 0;
                if (count > 0) {
                    addGenreBar(genre.name, count, totalBooks, genreDistributionContainer, 'blue-600');
                }
            });
            
            // Add custom genres
            const customGenres = gameState.stats.genreDistribution.custom;
            let colorIndex = 0;
            
            for (const [genreName, count] of Object.entries(customGenres)) {
                if (count > 0) {
                    const colorClass = gameConfig.genreColors[colorIndex % gameConfig.genreColors.length];
                    addGenreBar(genreName, count, totalBooks, genreDistributionContainer, colorClass);
                    colorIndex++;
                }
            }
        }
        
        // Helper function to add a genre bar to the distribution
        function addGenreBar(genreName, count, totalBooks, container, colorClass) {
            const genreDiv = document.createElement('div');
            genreDiv.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-700 dark:text-gray-300">${genreName}</span>
                    <span class="text-gray-700 dark:text-gray-300">${count} book${count !== 1 ? 's' : ''}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1">
                    <div class="bg-${colorClass} h-2.5 rounded-full" style="width: ${(count / totalBooks) * 100}%"></div>
                </div>
            `;
            container.appendChild(genreDiv);
        }
        
        // Update current reading list
        function updateCurrentReadingList() {
            const listElement = document.getElementById('current-reading-list');
            
            // Clear the list
            listElement.innerHTML = '';
            
            if (gameState.currentBooks.length === 0) {
                listElement.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>';
                return;
            }
            
            // Add each book to the list
            gameState.currentBooks.forEach((book, index) => {
                const bookElement = document.createElement('div');
                bookElement.className = 'p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                
                // Handle display of custom genre
                let displayGenre = book.genre;
                if (book.genre === 'custom' && book.customGenre) {
                    displayGenre = book.customGenre;
                } else {
                    // Convert genre key to display name
                    const genreMap = {
                        'sci-fi': 'Science Fiction',
                        'fantasy': 'Fantasy',
                        'non-fiction': 'Non-Fiction',
                        'mystery': 'Mystery/Thriller',
                        'history': 'History',
                        'science': 'Science',
                        'biography': 'Biography',
                        'other': 'Other'
                    };
                    displayGenre = genreMap[book.genre] || capitalizeFirstLetter(book.genre);
                }
                
                bookElement.innerHTML = `
                    <div class="flex justify-between">
                        <h4 class="font-medium text-gray-900 dark:text-dark-text">${book.title}</h4>
                        <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2 py-1 rounded-full">${displayGenre}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                        <span>Pages: ${book.pagesRead}</span>
                        <span>Reading Time: ${book.minutesRead} min</span>
                        <span>Difficulty: ${capitalizeFirstLetter(book.difficulty)}</span>
                    </div>
                `;
                
                listElement.appendChild(bookElement);
            });
        }
        
        // Update facilities UI
        function updateFacilitiesUI() {
            const facilitiesGrid = document.getElementById('facilities-grid');
            facilitiesGrid.innerHTML = '';
            
            // Sort facilities by discovery date (newest first)
            const sortedFacilities = Object.values(gameState.facilities).sort((a, b) => b.discoveryDate - a.discoveryDate);
            
            for (const facility of sortedFacilities) {
                const facilityCard = document.createElement('div');
                facilityCard.className = 'facility-card border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container';
                facilityCard.style.setProperty('--facility-color-1', facility.colors.primary);
                facilityCard.style.setProperty('--facility-color-2', facility.colors.secondary);
                
                // Create the card content based on whether the facility is built or not
                let cardContent = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <div class="facility-icon mr-3">
                                <span>${facility.effects[0]?.icon || '🏢'}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-dark-text">${facility.name}</h3>
                                <div class="text-xs px-2 py-0.5 rounded bg-${facility.colorClass} bg-opacity-20 text-${facility.colorClass} inline-block mt-1">
                                    ${facility.rarityName}
                                </div>
                            </div>
                        </div>
                `;
                
                if (facility.built) {
                    cardContent += `
                        <div class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                            Level ${facility.level}
                        </div>
                    `;
                } else {
                    cardContent += `
                        <div class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                            Not Built
                        </div>
                    `;
                }
                
                cardContent += `
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        ${facility.description}
                    </p>
                    <div class="space-y-2 mb-4">
                `;
                
                // Add effects
                for (const effect of facility.effects) {
                    // Calculate scaled effect value based on level
                    let scaledValue = effect.value;
                    if (facility.built && facility.level > 0) {
                        scaledValue = effect.value * (1 + (facility.level * effect.scalingFactor));
                        scaledValue = Math.round(scaledValue * 10) / 10; // Round to 1 decimal place
                    }
                    
                    const effectDesc = effect.desc.replace(/{value}/g, scaledValue);
                    
                    cardContent += `
                        <div class="flex items-center text-sm">
                            <span class="mr-2">${effect.icon}</span>
                            <span class="text-gray-700 dark:text-gray-300">${effectDesc}</span>
                        </div>
                    `;
                }
                
                cardContent += `
                    </div>
                `;
                
                // Add build/upgrade button
                if (facility.built) {
                    // Calculate upgrade cost with any discounts
                    let upgradeCost = Math.floor(facility.upgradeCost * Math.pow(facility.upgradeCostMultiplier, facility.level));
                    const facilityDiscountBonus = calculateTotalBonus('facility_discount');
                    const upgradeDiscountBonus = calculateTotalBonus('upgrade_discount');
                    const totalDiscount = facilityDiscountBonus + upgradeDiscountBonus;
                    
                    if (totalDiscount > 0) {
                        upgradeCost = Math.floor(upgradeCost * (1 - (totalDiscount / 100)));
                    }
                    
                    // Check if max level reached
                    if (facility.level >= facility.maxLevel) {
                        cardContent += `
                            <div class="flex items-center justify-between">
                                <div class="text-xs text-green-600 dark:text-green-400">Maximum level reached</div>
                                <button class="bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded cursor-not-allowed">
                                    Maxed
                                </button>
                            </div>
                        `;
                    } else {
                        // Add upgrade button
                        const canUpgrade = gameState.resources.knowledgePoints >= upgradeCost;
                        const buttonClass = canUpgrade 
                            ? "bg-primary hover:bg-blue-700 text-white" 
                            : "bg-gray-200 text-gray-500";
                        
                        cardContent += `
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Next level: +${Math.round(effect.value * effect.scalingFactor * 10) / 10} per effect</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">Cost: ${upgradeCost} KP</div>
                                </div>
                                <button class="${buttonClass} text-sm font-medium py-2 px-3 rounded transition-colors duration-200" 
                                        onclick="upgradeFacility('${facility.id}')" ${canUpgrade ? '' : 'disabled'}>
                                    Upgrade
                                </button>
                            </div>
                            <div class="mt-2 upgrade-progress">
                                <div class="upgrade-progress-bar" style="--progress-width: ${(facility.level / facility.maxLevel) * 100}%"></div>
                            </div>
                        `;
                    }
                } else {
                    // Calculate build cost with any discounts
                    let buildCost = facility.cost;
                    const facilityDiscountBonus = calculateTotalBonus('facility_discount');
                    
                    if (facilityDiscountBonus > 0) {
                        buildCost = Math.floor(buildCost * (1 - (facilityDiscountBonus / 100)));
                    }
                    
                    // Add build button
                    const canBuild = gameState.resources.knowledgePoints >= buildCost;
                    const buttonClass = canBuild 
                        ? "bg-primary hover:bg-blue-700 text-white" 
                        : "bg-gray-200 text-gray-500";
                    
                    cardContent += `
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-600 dark:text-gray-400">Cost: ${buildCost} KP</div>
                            <button class="${buttonClass} text-sm font-medium py-2 px-3 rounded transition-colors duration-200" 
                                    onclick="buildFacility('${facility.id}')" ${canBuild ? '' : 'disabled'}>
                                Build
                            </button>
                        </div>
                    `;
                }
                
                // Add tooltip
                cardContent += `
                    <div class="tooltip">
                        <div class="text-xs font-semibold mb-1">${facility.name}</div>
                        <div class="text-xs mb-1">${facility.rarityName} Facility</div>
                        <div class="text-xs mb-2">${facility.description}</div>
                        <div class="text-xs font-semibold">Effects:</div>
                        <ul class="list-disc list-inside text-xs">
                            ${facility.effects.map(effect => `<li>${effect.desc}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                // Add floating particles for decoration
                cardContent += `
                    <div class="facility-particle" style="top: 20%; left: 10%; animation-delay: 0s;"></div>
                    <div class="facility-particle" style="top: 30%; left: 80%; animation-delay: 0.5s;"></div>
                    <div class="facility-particle" style="top: 70%; left: 15%; animation-delay: 1s;"></div>
                    <div class="facility-particle" style="top: 60%; left: 75%; animation-delay: 1.5s;"></div>
                `;
                
                facilityCard.innerHTML = cardContent;
                facilitiesGrid.appendChild(facilityCard);
            }
            
            // Update the cost on the discover facility button
            const baseCost = gameConfig.facilityBaseCost;
            const facilityDiscountBonus = calculateTotalBonus('facility_discount');
            const discountedCost = facilityDiscountBonus > 0 
                ? Math.floor(baseCost * (1 - (facilityDiscountBonus / 100))) 
                : baseCost;
            
            document.getElementById('discover-facility-btn').textContent = `Discover New Facility (${discountedCost} KP)`;
            
            // Disable the button if not enough resources
            if (gameState.resources.knowledgePoints < discountedCost) {
                document.getElementById('discover-facility-btn').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('discover-facility-btn').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('discover-facility-btn').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('discover-facility-btn').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
        }
        
        // Build a facility
        function buildFacility(facilityId) {
            const facility = gameState.facilities[facilityId];
            if (!facility) return;
            
            // Calculate cost with any discounts
            let buildCost = facility.cost;
            const facilityDiscountBonus = calculateTotalBonus('facility_discount');
            
            if (facilityDiscountBonus > 0) {
                buildCost = Math.floor(buildCost * (1 - (facilityDiscountBonus / 100)));
            }
            
            // Check if enough resources
            if (gameState.resources.knowledgePoints < buildCost) {
                showNotification('Not enough Knowledge Points to build this facility.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.knowledgePoints -= buildCost;
            
            // Build the facility
            facility.built = true;
            facility.level = 1;
            
            // Show notification
            showNotification(`${facility.name} built successfully!`, 'success');
            
            // Update UI
            updateUI();
        }
        
        // Upgrade a facility
        function upgradeFacility(facilityId) {
            const facility = gameState.facilities[facilityId];
            if (!facility || !facility.built) return;
            
            // Check if max level reached
            if (facility.level >= facility.maxLevel) {
                showNotification('This facility is already at maximum level.', 'error');
                return;
            }
            
            // Calculate upgrade cost with any discounts
            let upgradeCost = Math.floor(facility.upgradeCost * Math.pow(facility.upgradeCostMultiplier, facility.level));
            const facilityDiscountBonus = calculateTotalBonus('facility_discount');
            const upgradeDiscountBonus = calculateTotalBonus('upgrade_discount');
            const totalDiscount = facilityDiscountBonus + upgradeDiscountBonus;
            
            if (totalDiscount > 0) {
                upgradeCost = Math.floor(upgradeCost * (1 - (totalDiscount / 100)));
            }
            
            // Check if enough resources
            if (gameState.resources.knowledgePoints < upgradeCost) {
                showNotification('Not enough Knowledge Points to upgrade this facility.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.knowledgePoints -= upgradeCost;
            
            // Upgrade the facility
            facility.level += 1;
            
            // Show notification
            showNotification(`${facility.name} upgraded to level ${facility.level}!`, 'success');
            
            // Update UI
            updateUI();
        }
        
        // Update research UI
        function updateResearchUI() {
            const researchGrid = document.getElementById('research-grid');
            researchGrid.innerHTML = '';
            
            // Filter out core research (enlightenmentStudies and stellarCartography)
            const procedualResearch = Object.values(gameState.research).filter(
                research => typeof research === 'object' && research !== null && 
                research.id !== 'enlightenmentStudies' && research.id !== 'stellarCartography'
            );
            
            // Sort research by discovery date (newest first)
            const sortedResearch = procedualResearch.sort((a, b) => b.discoveryDate - a.discoveryDate);
            
            for (const research of sortedResearch) {
                const researchCard = document.createElement('div');
                researchCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container';
                
                // Create the card content
                let cardContent = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">${research.name}</h3>
                            <div class="text-xs px-2 py-0.5 rounded bg-${research.colorClass} bg-opacity-20 text-${research.colorClass} inline-block mt-1">
                                ${research.rarityName}
                            </div>
                        </div>
                `;
                
                if (research.researched) {
                    cardContent += `
                        <div class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                            Researched
                        </div>
                    `;
                } else {
                    cardContent += `
                        <div class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                            Not Researched
                        </div>
                    `;
                }
                
                cardContent += `
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        ${research.description}
                    </p>
                    <div class="space-y-2 mb-4">
                `;
                
                // Add effects
                for (const effect of research.effects) {
                    cardContent += `
                        <div class="flex items-center text-sm">
                            <span class="mr-2">${effect.icon}</span>
                            <span class="text-gray-700 dark:text-gray-300">${effect.desc}</span>
                        </div>
                    `;
                }
                
                cardContent += `
                    </div>
                `;
                
                // Add research button or status
                if (research.researched) {
                    cardContent += `
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-green-600 dark:text-green-400">Research complete</div>
                            <button class="bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded cursor-not-allowed">
                                Researched
                            </button>
                        </div>
                    `;
                } else {
                    // Calculate research cost with any discounts
                    let researchCost = research.cost;
                    const researchDiscountBonus = calculateTotalBonus('research_discount');
                    
                    if (researchDiscountBonus > 0) {
                        researchCost = Math.floor(researchCost * (1 - (researchDiscountBonus / 100)));
                    }
                    
                    // Add research button
                    const canResearch = gameState.resources.researchPoints >= researchCost;
                    const buttonClass = canResearch 
                        ? "bg-primary hover:bg-blue-700 text-white" 
                        : "bg-gray-200 text-gray-500";
                    
                    cardContent += `
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-600 dark:text-gray-400">Cost: ${researchCost} RP</div>
                            <button class="${buttonClass} text-sm font-medium py-2 px-3 rounded transition-colors duration-200" 
                                    onclick="researchTechnology('${research.id}')" ${canResearch ? '' : 'disabled'}>
                                Research
                            </button>
                        </div>
                    `;
                }
                
                // Add tooltip
                cardContent += `
                    <div class="tooltip">
                        <div class="text-xs font-semibold mb-1">${research.name}</div>
                        <div class="text-xs mb-1">${research.rarityName} Research</div>
                        <div class="text-xs mb-2">${research.description}</div>
                        <div class="text-xs font-semibold">Effects:</div>
                        <ul class="list-disc list-inside text-xs">
                            ${research.effects.map(effect => `<li>${effect.desc}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                researchCard.innerHTML = cardContent;
                researchGrid.appendChild(researchCard);
            }
            
            // Update the cost on the discover research button
            const baseCost = gameConfig.researchBaseCost;
            const researchDiscountBonus = calculateTotalBonus('research_discount');
            const discountedCost = researchDiscountBonus > 0 
                ? Math.floor(baseCost * (1 - (researchDiscountBonus / 100))) 
                : baseCost;
            
            document.getElementById('discover-research-btn').textContent = `Discover New Research (${discountedCost} RP)`;
            
            // Disable the button if not enough resources
            if (gameState.resources.researchPoints < discountedCost) {
                document.getElementById('discover-research-btn').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('discover-research-btn').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('discover-research-btn').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('discover-research-btn').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
        }
        
        // Research a technology
        function researchTechnology(researchId) {
            const research = gameState.research[researchId];
            if (!research || research.researched) return;
            
            // Calculate cost with any discounts
            let researchCost = research.cost;
            const researchDiscountBonus = calculateTotalBonus('research_discount');
            
            if (researchDiscountBonus > 0) {
                researchCost = Math.floor(researchCost * (1 - (researchDiscountBonus / 100)));
            }
            
            // Check if enough resources
            if (gameState.resources.researchPoints < researchCost) {
                showNotification('Not enough Research Points for this technology.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.researchPoints -= researchCost;
            
            // Research the technology
            research.researched = true;
            
            // Show notification
            showNotification(`${research.name} researched successfully!`, 'success');
            
            // Update UI
            updateUI();
        }
        
        // Update core research buttons (Enlightenment Studies, Stellar Cartography)
        function updateCoreResearchButtons() {
            // Update Enlightenment Studies
            const enlightenmentStatus = document.getElementById('enlightenment-status');
            const researchEnlightenmentBtn = document.getElementById('research-enlightenment');
            
            enlightenmentStatus.textContent = gameState.research.enlightenmentStudies ? 'Researched' : 'Not Researched';
            
            if (gameState.research.enlightenmentStudies) {
                researchEnlightenmentBtn.classList.add('bg-gray-200', 'text-gray-500');
                researchEnlightenmentBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                researchEnlightenmentBtn.textContent = 'Researched';
                researchEnlightenmentBtn.disabled = true;
            } else {
                // Check requirements
                const meetsLevelReq = gameState.player.level >= gameConfig.prestigeRequirements.playerLevel;
                const meetsBooksReq = gameState.stats.booksCompleted >= gameConfig.prestigeRequirements.booksCompleted;
                const meetsRPReq = gameState.resources.researchPoints >= 500;
                
                if (meetsLevelReq && meetsBooksReq && meetsRPReq) {
                    researchEnlightenmentBtn.classList.remove('bg-gray-200', 'text-gray-500');
                    researchEnlightenmentBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    researchEnlightenmentBtn.disabled = false;
                } else {
                    researchEnlightenmentBtn.classList.add('bg-gray-200', 'text-gray-500');
                    researchEnlightenmentBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    researchEnlightenmentBtn.disabled = true;
                }
            }
            
            // Update Stellar Cartography
            const cartographyStatus = document.getElementById('cartography-status');
            const researchCartographyBtn = document.getElementById('research-cartography');
            
            cartographyStatus.textContent = gameState.research.stellarCartography ? 'Researched' : 'Not Researched';
            
            if (gameState.research.stellarCartography) {
                researchCartographyBtn.classList.add('bg-gray-200', 'text-gray-500');
                researchCartographyBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                researchCartographyBtn.textContent = 'Researched';
                researchCartographyBtn.disabled = true;
            } else {
                // Check requirements
                const meetsLevelReq = gameState.player.level >= 3;
                const meetsBooksReq = gameState.stats.booksCompleted >= 3;
                const meetsRPReq = gameState.resources.researchPoints >= 150;
                
                if (meetsLevelReq && meetsBooksReq && meetsRPReq) {
                    researchCartographyBtn.classList.remove('bg-gray-200', 'text-gray-500');
                    researchCartographyBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    researchCartographyBtn.disabled = false;
                } else {
                    researchCartographyBtn.classList.add('bg-gray-200', 'text-gray-500');
                    researchCartographyBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    researchCartographyBtn.disabled = true;
                }
            }
            
            // Update Galaxy UI status
            document.getElementById('galaxy-cartography-status').textContent = 
                gameState.research.stellarCartography ? 'Researched' : 'Not Researched';
        }
        
        // Update Galaxy UI
        function updateGalaxyUI() {
            // Update galaxy UI based on research status
            if (gameState.research.stellarCartography) {
                gameState.galaxy.unlocked = true;
                document.getElementById('galaxy-unlock-message').classList.add('hidden');
                document.getElementById('galaxy-interface').classList.remove('hidden');
                
                // Update galaxy stats
                document.getElementById('systems-discovered').textContent = gameState.galaxy.stats.systemsDiscovered;
                document.getElementById('outposts-established').textContent = gameState.galaxy.stats.outpostsEstablished;
                
                // Calculate total exploration range
                let baseRange = gameState.galaxy.explorationRange;
                const rangeBonus = calculateTotalBonus('exploration_bonus');
                const galaxyRangeBonus = calculateTotalBonus('galaxy_reach');
                
                baseRange += rangeBonus + galaxyRangeBonus;
                
                document.getElementById('exploration-range').textContent = baseRange.toFixed(1);
                document.getElementById('next-system-cost').textContent = gameState.galaxy.nextSystemCost;
                
                // Update outposts list
                updateOutpostsList();
                
                // Update expedition status if there's an active expedition
                updateExpeditionStatus();
                
                // Initialize galaxy map if needed
                if (!document.querySelector('#galaxy-map .star')) {
                    initializeGalaxyMap();
                }
            } else {
                document.getElementById('galaxy-unlock-message').classList.remove('hidden');
                document.getElementById('galaxy-interface').classList.add('hidden');
            }
            
            // Update establish outpost button if a system is selected
            const systemDetailsPanel = document.getElementById('system-details-panel');
            if (!systemDetailsPanel.classList.contains('hidden')) {
                const systemName = document.getElementById('selected-system-name').textContent;
                const system = Object.values(gameState.galaxy.discoveredSystems).find(s => s.name === systemName);
                
                if (system) {
                    const outpostBtn = document.getElementById('establish-outpost-btn');
                    
                    if (system.outpostEstablished) {
                        outpostBtn.textContent = 'Outpost Established';
                        outpostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        outpostBtn.classList.remove('bg-galaxy', 'hover:bg-indigo-700');
                        outpostBtn.disabled = true;
                    } else {
                        // Calculate cost with any discounts
                        let cost = calculateOutpostCost(system);
                        const galaxyEfficiencyBonus = calculateTotalBonus('galaxy_efficiency');
                        
                        if (galaxyEfficiencyBonus > 0) {
                            cost = Math.floor(cost * (1 - (galaxyEfficiencyBonus / 100)));
                        }
                        
                        outpostBtn.textContent = `Establish Outpost (${cost} CI)`;
                        
                        if (gameState.resources.influence >= cost) {
                            outpostBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            outpostBtn.classList.add('bg-galaxy', 'hover:bg-indigo-700');
                            outpostBtn.disabled = false;
                        } else {
                            outpostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                            outpostBtn.classList.remove('bg-galaxy', 'hover:bg-indigo-700');
                            outpostBtn.disabled = true;
                        }
                    }
                }
            }
            
            // Update discover system button cost
            document.getElementById('discover-system-btn').textContent = `Explore (${gameState.galaxy.nextSystemCost} CI)`;
            
            // Disable discover button if not enough influence
            if (gameState.resources.influence < gameState.galaxy.nextSystemCost) {
                document.getElementById('discover-system-btn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('discover-system-btn').classList.remove('bg-galaxy', 'hover:bg-indigo-700');
            } else {
                document.getElementById('discover-system-btn').classList.remove('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('discover-system-btn').classList.add('bg-galaxy', 'hover:bg-indigo-700');
            }
        }
        
        // Initialize Galaxy Map
        function initializeGalaxyMap() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            // Clear existing map elements
            mapContainer.innerHTML = '';
            
            // Create exploration radius indicator
            const radiusIndicator = document.createElement('div');
            radiusIndicator.id = 'exploration-radius';
            radiusIndicator.className = 'exploration-radius';
            mapContainer.appendChild(radiusIndicator);
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.id = 'star-tooltip';
            tooltip.className = 'star-tooltip';
            mapContainer.appendChild(tooltip);
            
            // Create galaxy controls
            const controls = document.createElement('div');
            controls.className = 'galaxy-controls';
            controls.innerHTML = `
                <button class="galaxy-control-btn" id="zoom-in">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="zoom-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="center-map">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
            `;
            mapContainer.appendChild(controls);
            
            // Add background stars
            addBackgroundStars();
            
            // Add home system if it doesn't exist
            if (!gameState.galaxy.discoveredSystems['home']) {
                gameState.galaxy.discoveredSystems['home'] = {
                    id: 'home',
                    name: 'Home System',
                    coordinates: { x: 0, y: 0 },
                    type: 'classic',
                    rarity: 'uncommon',
                    discovered: true,
                    outpostEstablished: true,
                    description: 'Your home system, where your reading journey began.',
                    celestialObjects: [
                        {
                            id: 'home-prime',
                            name: 'Bibliotheca Prime',
                            type: 'planet',
                            typeName: 'Planet',
                            colonized: true,
                            bonuses: [
                                { type: 'kp_per_page', value: 5, desc: '5% increase to Knowledge Points per page' }
                            ],
                            description: 'Your starting world, providing a solid foundation for your reading empire.'
                        }
                    ],
                    discoveryDate: Date.now()
                };
                gameState.galaxy.stats.systemsDiscovered = 1;
                gameState.galaxy.stats.outpostsEstablished = 1;
                gameState.galaxy.stats.objectsColonized = 1;
                
                // Add the home planet to active celestial objects
                gameState.galaxy.activeCelestialObjects.push({
                    systemId: 'home',
                    objectId: 'home-prime',
                    systemName: 'Home System',
                    objectName: 'Bibliotheca Prime',
                    bonuses: [
                        { type: 'kp_per_page', value: 5, desc: '5% increase to Knowledge Points per page' }
                    ]
                });
            }
            
            // Render known systems
            renderGalaxySystems();
            
            // Update exploration radius
            updateExplorationRadius();
            
            // Add event listeners for controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoomGalaxyMap(0.25); // Zoom in by 25%
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                zoomGalaxyMap(-0.25); // Zoom out by 25%
            });
            
            document.getElementById('center-map').addEventListener('click', () => {
                centerGalaxyMap();
            });
            
            // Add drag functionality to the map
            addMapDragFunctionality();
        }
        
        // Add background stars to the galaxy map
        function addBackgroundStars() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            
            // Generate between 50-100 stars based on map size
            const numStars = Math.floor(mapWidth * mapHeight / 1000);
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // Random size (0.5px to 2px)
                const size = 0.5 + Math.random() * 1.5;
                
                // Random opacity
                const opacity = 0.3 + Math.random() * 0.7;
                
                // Apply styles
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.opacity = opacity.toString();
                
                // Add animation with random delay
                star.style.animation = `twinkle 3s ease-in-out infinite alternate`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                
                mapContainer.appendChild(star);
            }
        }
        
        // Render star systems on the galaxy map
        function renderGalaxySystems() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Clear existing systems
            const existingSystems = mapContainer.querySelectorAll('.star-system');
            existingSystems.forEach(system => system.remove());
            
            // Calculate current view parameters
            const zoomFactor = gameState.galaxy.zoomLevel;
            const viewCenterX = gameState.galaxy.viewCenter.x;
            const viewCenterY = gameState.galaxy.viewCenter.y;
            
            // Render each discovered system
            for (const systemId in gameState.galaxy.discoveredSystems) {
                const system = gameState.galaxy.discoveredSystems[systemId];
                
                // Calculate screen position
                const scaledX = (system.coordinates.x - viewCenterX) * zoomFactor * 50 + centerX;
                const scaledY = (system.coordinates.y - viewCenterY) * zoomFactor * 50 + centerY;
                
                // Skip if outside visible area with padding
                const padding = 50; // Pixels
                if (scaledX < -padding || scaledX > mapWidth + padding || 
                    scaledY < -padding || scaledY > mapHeight + padding) {
                    continue;
                }
                
                // Create system element
                const systemElement = document.createElement('div');
                systemElement.className = 'star-system';
                systemElement.dataset.systemId = systemId;
                
                // Set position and size based on rarity
                systemElement.style.left = `${scaledX}px`;
                systemElement.style.top = `${scaledY}px`;
                
                const size = gameConfig.galaxy.starSizesByRarity[system.rarity] * zoomFactor;
                systemElement.style.width = `${size}px`;
                systemElement.style.height = `${size}px`;
                
                // Set color based on type
                systemElement.style.backgroundColor = gameConfig.galaxy.systemColors[system.type];
                
                // Add outpost indicator if established
                if (system.outpostEstablished) {
                    systemElement.style.border = '2px solid white';
                }
                
                // Add glow based on rarity
                systemElement.style.boxShadow = `0 0 ${size/2}px ${gameConfig.galaxy.rarityColors[system.rarity]}`;
                
                // Add event listeners
                systemElement.addEventListener('mouseover', (e) => {
                    showSystemTooltip(system, e);
                });
                
                systemElement.addEventListener('mouseout', () => {
                    hideSystemTooltip();
                });
                
                systemElement.addEventListener('click', () => {
                    selectGalaxySystem(system);
                });
                
                mapContainer.appendChild(systemElement);
            }
        }
        
        // Update the exploration radius indicator
        function updateExplorationRadius() {
            const radiusIndicator = document.getElementById('exploration-radius');
            if (!radiusIndicator) return;
            
            const mapContainer = document.getElementById('galaxy-map');
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Calculate radius based on exploration range and zoom
            let baseRange = gameState.galaxy.explorationRange;
            const rangeBonus = calculateTotalBonus('exploration_bonus');
            const galaxyRangeBonus = calculateTotalBonus('galaxy_reach');
            
            baseRange += rangeBonus + galaxyRangeBonus;
            
            const radius = baseRange * gameState.galaxy.zoomLevel * 50;
            
            // Position and size the indicator
            radiusIndicator.style.left = `${centerX - radius}px`;
            radiusIndicator.style.top = `${centerY - radius}px`;
            radiusIndicator.style.width = `${radius * 2}px`;
            radiusIndicator.style.height = `${radius * 2}px`;
        }
        
        // Show tooltip for a star system
        function showSystemTooltip(system, event) {
            const tooltip = document.getElementById('star-tooltip');
            if (!tooltip) return;
            
            // Set tooltip content
            tooltip.innerHTML = `
                <div class="font-bold text-sm mb-1">${system.name}</div>
                <div class="flex justify-between text-xs mb-1">
                    <span>${capitalizeFirstLetter(system.type)}</span>
                    <span>${capitalizeFirstLetter(system.rarity)}</span>
                </div>
                <div class="text-xs mb-1">Objects: ${system.celestialObjects.length}</div>
                <div class="text-xs">${system.outpostEstablished ? '✓ Outpost Established' : 'No Outpost'}</div>
            `;
            
            // Position tooltip near cursor
            const mapContainer = document.getElementById('galaxy-map');
            const rect = mapContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            tooltip.style.left = `${x + 15}px`;
            tooltip.style.top = `${y - 15}px`;
            
            // Show tooltip
            tooltip.style.opacity = '1';
        }
        
        // Hide system tooltip
        function hideSystemTooltip() {
            const tooltip = document.getElementById('star-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
            }
        }
        
        // Select a galaxy system to view details
        function selectGalaxySystem(system) {
            // Show system details panel
            const detailsPanel = document.getElementById('system-details-panel');
            detailsPanel.classList.remove('hidden');
            
            // Update system details
            document.getElementById('selected-system-name').textContent = system.name;
            document.getElementById('selected-system-type').textContent = capitalizeFirstLetter(system.type);
            document.getElementById('selected-system-description').textContent = system.description;
            document.getElementById('selected-system-coordinates').textContent = `(${system.coordinates.x}, ${system.coordinates.y})`;
            document.getElementById('selected-system-planets').textContent = system.celestialObjects.length;
            document.getElementById('selected-system-rarity').textContent = capitalizeFirstLetter(system.rarity);
            
            // Update establish outpost button
            const outpostBtn = document.getElementById('establish-outpost-btn');
            if (system.outpostEstablished) {
                outpostBtn.textContent = 'Outpost Established';
                outpostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.remove('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = true;
            } else {
                // Calculate cost with any discounts
                let cost = calculateOutpostCost(system);
                const galaxyEfficiencyBonus = calculateTotalBonus('galaxy_efficiency');
                
                if (galaxyEfficiencyBonus > 0) {
                    cost = Math.floor(cost * (1 - (galaxyEfficiencyBonus / 100)));
                }
                
                outpostBtn.textContent = `Establish Outpost (${cost} CI)`;
                outpostBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.add('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = false;
                
                // Add event listener
                outpostBtn.onclick = () => establishOutpost(system);
            }
            
            // Populate celestial objects list
            const objectsList = document.getElementById('system-planets-list');
            objectsList.innerHTML = '';
            
            system.celestialObjects.forEach(object => {
                const objectElement = document.createElement('div');
                objectElement.className = 'p-2 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600';
                
                let bonusText = '';
                if (object.bonuses && object.bonuses.length > 0) {
                    bonusText = object.bonuses.map(bonus => {
                        return bonus.desc;
                    }).join('<br>');
                }
                
                objectElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-medium text-gray-900 dark:text-gray-100">${object.name}</h5>
                            <div class="text-xs text-gray-600 dark:text-gray-400">${object.typeName}</div>
                        </div>
                        ${object.colonized ? 
                            '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-0.5 rounded">Colonized</span>' : 
                            system.outpostEstablished ? 
                                '<button class="text-xs bg-galaxy hover:bg-indigo-700 text-white px-2 py-0.5 rounded colonize-object-btn" data-object-id="' + object.id + '">Colonize</button>' :
                                '<span class="text-xs bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 px-2 py-0.5 rounded">Establish Outpost First</span>'
                        }
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${object.description}</p>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1">
                        <span class="font-medium">Bonuses:</span><br>
                        ${bonusText || 'None discovered yet'}
                    </div>
                `;
                
                objectsList.appendChild(objectElement);
            });
            
            // Add event listeners to colonize buttons
            document.querySelectorAll('.colonize-object-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const objectId = btn.dataset.objectId;
                    colonizeCelestialObject(system, objectId);
                });
            });
        }
        
        // Calculate the cost of establishing an outpost
        function calculateOutpostCost(system) {
            // Base cost
            let cost = gameState.galaxy.systemCosts.base;
            
            // Distance factor - further systems cost more
            const distance = Math.sqrt(
                Math.pow(system.coordinates.x, 2) + 
                Math.pow(system.coordinates.y, 2)
            );
            
            cost = Math.round(cost * Math.pow(gameState.galaxy.systemCosts.distanceMultiplier, distance));
            
            // Rarity factor - rarer systems cost more
            const rarityMultipliers = {
                'common': 1,
                'uncommon': 1.5,
                'rare': 2,
                'legendary': 3,
                'mythic': 5
            };
            
            cost = Math.round(cost * rarityMultipliers[system.rarity]);
            
            return Math.max(10, cost); // Minimum cost of 10
        }
        
        // Establish an outpost in a star system
        function establishOutpost(system) {
            // Calculate cost with any discounts
            let cost = calculateOutpostCost(system);
            const galaxyEfficiencyBonus = calculateTotalBonus('galaxy_efficiency');
            
            if (galaxyEfficiencyBonus > 0) {
                cost = Math.floor(cost * (1 - (galaxyEfficiencyBonus / 100)));
            }
            
            if (gameState.resources.influence < cost) {
                showNotification('Not enough Cosmic Influence to establish an outpost.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= cost;
            
            // Update system
            system.outpostEstablished = true;
            gameState.galaxy.stats.outpostsEstablished++;
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            renderGalaxySystems();
            
            showNotification(`Outpost established in ${system.name}!`, 'success');
            
            // Check for relic discovery (rare chance when establishing outposts)
            const relicRoll = Math.random();
            if (relicRoll < 0.05) { // 5% chance of finding a relic
                discoverRelic();
            }
        }
        
        // Colonize a celestial object
        function colonizeCelestialObject(system, objectId) {
            // Find the object
            const object = system.celestialObjects.find(o => o.id === objectId);
            if (!object) return;
            
            // Check if outpost is established
            if (!system.outpostEstablished) {
                showNotification('You must establish an outpost before colonizing celestial objects.', 'error');
                return;
            }
            
            // Update object status
            object.colonized = true;
            gameState.galaxy.stats.objectsColonized++;
            
            // Add object to active objects list
            gameState.galaxy.activeCelestialObjects.push({
                systemId: system.id,
                objectId: object.id,
                systemName: system.name,
                objectName: object.name,
                bonuses: object.bonuses || []
            });
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            updateOutpostsList();
            
            showNotification(`${object.name} colonized! You now receive its bonuses.`, 'success');
            
            // Check for relic discovery (higher chance when colonizing objects)
            const relicChance = object.type === 'anomaly' ? 0.25 : // 25% for anomalies
                              object.type === 'nebula' ? 0.15 : // 15% for nebulas
                              0.02; // 2% for other types
            
            const relicRoll = Math.random();
            if (relicRoll < relicChance) {
                discoverRelic();
            }
        }
        
        // Update outposts list
        function updateOutpostsList() {
            const outpostsList = document.getElementById('outposts-list');
            const noOutpostsMessage = document.getElementById('no-outposts-message');
            
            if (gameState.galaxy.stats.outpostsEstablished === 0) {
                noOutpostsMessage.classList.remove('hidden');
                outpostsList.classList.add('hidden');
                return;
            }
            
            noOutpostsMessage.classList.add('hidden');
            outpostsList.classList.remove('hidden');
            
            // Clear list
            outpostsList.innerHTML = '';
            
            // Get systems with outposts
            const outpostSystems = Object.values(gameState.galaxy.discoveredSystems)
                .filter(system => system.outpostEstablished);
            
            // Create outpost cards
            outpostSystems.forEach(system => {
                const outpostCard = document.createElement('div');
                outpostCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                
                // Get colonized objects in this system
                const colonizedObjects = system.celestialObjects.filter(object => object.colonized);
                
                // Build bonuses text
                let bonusesHtml = '';
                if (colonizedObjects.length > 0) {
                    colonizedObjects.forEach(object => {
                        if (object.bonuses && object.bonuses.length > 0) {
                            bonusesHtml += `<div class="mt-1"><span class="text-xs font-medium">${object.name}:</span>`;
                            bonusesHtml += '<ul class="text-xs list-disc list-inside ml-2">';
                            
                            object.bonuses.forEach(bonus => {
                                bonusesHtml += `<li>${bonus.desc}</li>`;
                            });
                            
                            bonusesHtml += '</ul></div>';
                        }
                    });
                }
                
                if (bonusesHtml === '') {
                    bonusesHtml = '<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">No active bonuses yet. Colonize celestial objects to receive bonuses.</div>';
                }
                
                outpostCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-900 dark:text-dark-text">${system.name}</h3>
                        <div class="text-xs px-2 py-1 rounded" style="background-color: ${gameConfig.galaxy.systemColors[system.type]}20; color: ${gameConfig.galaxy.systemColors[system.type]};">
                            ${capitalizeFirstLetter(system.type)}
                        </div>
                    </div>
                    <div class="flex space-x-4 text-xs text-gray-600 dark:text-gray-400 mb-2">
                        <div>${colonizedObjects.length}/${system.celestialObjects.length} Objects Colonized</div>
                        <div>${capitalizeFirstLetter(system.rarity)}</div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                        <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Active Bonuses:</div>
                        ${bonusesHtml}
                    </div>
                `;
                
                outpostsList.appendChild(outpostCard);
            });
        }
        
        // Zoom the galaxy map
        function zoomGalaxyMap(zoomChange) {
            // Update zoom level, keeping it within bounds
            gameState.galaxy.zoomLevel = Math.max(0.5, Math.min(3, gameState.galaxy.zoomLevel + zoomChange));
            
            // Re-render systems and update exploration radius
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Center the galaxy map on home
        function centerGalaxyMap() {
            gameState.galaxy.viewCenter = { x: 0, y: 0 };
            
            // Re-render systems
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Add drag functionality to the map
        function addMapDragFunctionality() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            let isDragging = false;
            let startX, startY;
            let startViewX, startViewY;
            
            mapContainer.addEventListener('mousedown', (e) => {
                // Only enable dragging with left mouse button
                if (e.button !== 0) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                // Change cursor
                mapContainer.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.style.cursor = 'default';
                }
            });
            
            // Prevent default behavior for right-click on the map
            mapContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Touch support for mobile devices
            mapContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return; // Only handle single touch
                
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.touches[0].clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.touches[0].clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // Explore a new star system
        function exploreSystem() {
            // Check if player has enough influence
            if (gameState.resources.influence < gameState.galaxy.nextSystemCost) {
                showNotification('Not enough Cosmic Influence to explore a new system.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= gameState.galaxy.nextSystemCost;
            
            // Start expedition
            gameState.galaxy.activeExpedition = {
                startTime: Date.now(),
                duration: 30000, // 30 seconds
                progress: 0
            };
            
            // Apply exploration speed bonus if available
            const speedBonus = calculateTotalBonus('galaxy_speed');
            if (speedBonus > 0) {
                gameState.galaxy.activeExpedition.duration = Math.floor(
                    gameState.galaxy.activeExpedition.duration * (1 - (speedBonus / 100))
                );
            }
            
            // Show expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.remove('hidden');
            
            // Start expedition progress
            updateExpeditionStatus();
            
            // Update UI
            updateUI();
            
            // Increase next system cost
            gameState.galaxy.nextSystemCost = Math.floor(gameState.galaxy.nextSystemCost * 1.1);
            
            showNotification('Expedition launched! Your literary explorers are venturing into the unknown...', 'info');
        }
        
        // Update expedition status
        function updateExpeditionStatus() {
            if (!gameState.galaxy.activeExpedition) return;
            
            const expeditionPanel = document.getElementById('expedition-panel');
            const expeditionProgress = document.getElementById('expedition-progress');
            const expeditionTime = document.getElementById('expedition-time');
            const expeditionMessage = document.getElementById('expedition-message');
            
            const now = Date.now();
            const elapsed = now - gameState.galaxy.activeExpedition.startTime;
            const duration = gameState.galaxy.activeExpedition.duration;
            const remaining = Math.max(0, duration - elapsed);
            
            // Calculate progress
            const progress = Math.min(100, (elapsed / duration) * 100);
            gameState.galaxy.activeExpedition.progress = progress;
            
            // Update progress bar
            expeditionProgress.style.width = `${progress}%`;
            
            // Update time remaining
            const seconds = Math.ceil(remaining / 1000);
            expeditionTime.textContent = `0:${seconds < 10 ? '0' + seconds : seconds}`;
            
            // Update message based on progress
            if (progress < 33) {
                expeditionMessage.textContent = 'Your literary expedition is exploring the cosmos...';
            } else if (progress < 66) {
                expeditionMessage.textContent = 'The expedition has detected intriguing narrative resonances...';
            } else if (progress < 100) {
                expeditionMessage.textContent = 'A new literary system is coming into focus...';
            }
            
            // Check if expedition is complete
            if (progress >= 100) {
                // Complete the expedition
                completeExpedition();
            } else {
                // Continue updating
                setTimeout(updateExpeditionStatus, 100);
            }
        }
        
        // Complete an expedition and discover a new system
        function completeExpedition() {
            // Clear active expedition
            gameState.galaxy.activeExpedition = null;
            
            // Hide expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.add('hidden');
            
            // Generate a new star system
            const newSystem = generateRandomSystem();
            
            // Add system to discovered systems
            gameState.galaxy.discoveredSystems[newSystem.id] = newSystem;
            gameState.galaxy.stats.systemsDiscovered++;
            
            // Update UI
            updateUI();
            renderGalaxySystems();
            
            // Show discovery modal
            showSystemDiscoveryModal(newSystem);
            
            // Check for relic discovery (small chance when discovering new systems)
            if (newSystem.rarity === 'legendary' || newSystem.rarity === 'mythic') {
                // Higher chance for legendary/mythic systems
                const relicRoll = Math.random();
                if (relicRoll < 0.15) { // 15% chance
                    setTimeout(() => {
                        discoverRelic();
                    }, 1500); // Delay to avoid overwhelming the user
                }
            }
        }
        
        // Show system discovery modal
        function showSystemDiscoveryModal(system) {
            // Update modal content
            document.getElementById('discovery-type').textContent = 'New Star System Discovered!';
            document.getElementById('discovery-name').textContent = system.name;
            document.getElementById('discovery-description').textContent = system.description;
            
            // Update details
            document.getElementById('discovery-details').innerHTML = `
                <div>
                    <span class="font-medium">Type:</span>
                    <span>${capitalizeFirstLetter(system.type)}</span>
                </div>
                <div>
                    <span class="font-medium">Objects:</span>
                    <span>${system.celestialObjects.length}</span>
                </div>
                <div>
                    <span class="font-medium">Rarity:</span>
                    <span>${capitalizeFirstLetter(system.rarity)}</span>
                </div>
            `;
            
            // Set button text
            document.getElementById('close-discovery-modal').textContent = 'Explore System';
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').onclick = () => {
                document.getElementById('discovery-modal').classList.add('hidden');
                
                // Select the discovered system
                selectGalaxySystem(system);
            };
        }
        
        // Update enlightenment UI
        function updateEnlightenmentUI() {
            // Update EP values
            document.getElementById('available-ep').textContent = gameState.prestige.enlightenmentPoints;
            
            // Update all enlightenment preview calculations
            updateEpPreview();
            
            // Update permanent upgrades display
            const upgradesContainer = document.getElementById('enlightenment-upgrades');
            upgradesContainer.innerHTML = '';
            
            // Create cards for each upgrade type
            for (const upgradeConfig of gameConfig.enlightenmentUpgrades) {
                // Get current upgrade data
                const upgrade = gameState.prestige.permanentUpgrades[upgradeConfig.id] || {
                    level: 0,
                    value: 0,
                    cost: upgradeConfig.baseCost
                };
                
                // Calculate next upgrade cost and values
                let nextCost = upgradeConfig.baseCost;
                if (upgrade && upgrade.level > 0) {
                    nextCost = Math.floor(upgradeConfig.baseCost * Math.pow(upgradeConfig.costScaling, upgrade.level));
                }
                
                // Create the upgrade card
                const card = document.createElement('div');
                card.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                
                // Format display of current bonus and next bonus
                let currentBonus, nextBonus;
                
                if (upgradeConfig.effect.type === 'percentage') {
                    currentBonus = `+${upgrade.value || 0}%`;
                    nextBonus = `+${upgradeConfig.effect.value}%`;
                } else if (upgradeConfig.effect.type === 'flat') {
                    if (upgradeConfig.id === 'starting_resources') {
                        currentBonus = `+${upgrade.kpBonus || 0} KP / +${upgrade.rpBonus || 0} RP / +${upgrade.infBonus || 0} CI`;
                        nextBonus = `+${upgradeConfig.effect.kp} KP / +${upgradeConfig.effect.rp} RP / +${upgradeConfig.effect.inf} CI`;
                    } else {
                        currentBonus = `+${upgrade.value || 0}`;
                        nextBonus = `+${upgradeConfig.effect.value}`;
                    }
                } else if (upgradeConfig.effect.type === 'level') {
                    currentBonus = `Level ${upgrade.level || 0}/${upgradeConfig.effect.cap}`;
                    
                    if (upgrade.level >= upgradeConfig.effect.cap) {
                        nextBonus = 'Max Level';
                    } else {
                        nextBonus = `Level ${(upgrade.level || 0) + 1}`;
                    }
                }
                
                // Display max level indicator if needed
                const isMaxed = upgradeConfig.effect.cap && upgrade.level >= upgradeConfig.effect.cap;
                
                // Create button based on available EP and max level
                let buttonHTML;
                if (isMaxed) {
                    buttonHTML = `
                        <button class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded cursor-not-allowed">
                            Maximum Level Reached
                        </button>
                    `;
                } else if (gameState.prestige.enlightenmentPoints >= nextCost) {
                    buttonHTML = `
                        <button class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200" 
                                onclick="purchaseEnlightenmentUpgrade('${upgradeConfig.id}')">
                            Upgrade (${nextCost} EP)
                        </button>
                    `;
                } else {
                    buttonHTML = `
                        <button class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded cursor-not-allowed">
                            Upgrade (${nextCost} EP)
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                        <span class="w-6 h-6 flex items-center justify-center mr-2 ${upgradeConfig.iconClass}">${upgradeConfig.iconSymbol}</span>
                        ${upgradeConfig.name}
                    </h3>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                        ${upgradeConfig.desc}
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                        <span>Current: ${currentBonus}</span>
                        <span>Next: ${nextBonus}</span>
                    </div>
                    ${buttonHTML}
                    ${isMaxed ? '' : `
                        <div class="mt-2 upgrade-progress">
                            <div class="upgrade-progress-bar" style="--progress-width: ${(upgrade.level / upgradeConfig.effect.cap) * 100}%"></div>
                        </div>
                    `}
                `;
                
                upgradesContainer.appendChild(card);
            }
            
            // Update galactic relics list
            updateRelicsList();
        }
        
        // Update relics list in the Enlightenment tab
        function updateRelicsList() {
            const relicsContainer = document.getElementById('relics-container');
            
            // Keep the placeholder if no relics
            if (Object.keys(gameState.relics).length === 0) return;
            
            // Clear any existing relics (except the placeholder)
            const existingRelics = relicsContainer.querySelectorAll('.relic-card');
            existingRelics.forEach(relic => relic.remove());
            
            // Add each relic
            for (const relicId in gameState.relics) {
                const relic = gameState.relics[relicId];
                
                const relicCard = document.createElement('div');
                relicCard.className = 'relic-card p-4 border border-gray-200 dark:border-gray-700 rounded-lg relative';
                
                // Create effect description based on effect type
                let effectDesc = '';
                if (relic.effect.type === 'multiplier') {
                    effectDesc = `Multiplies ${relic.effect.target.replace(/_/g, ' ')} by ${relic.effect.value}x`;
                } else if (relic.effect.type === 'percentage') {
                    effectDesc = `Increases ${relic.effect.target.replace(/_/g, ' ')} by ${relic.effect.value}%`;
                } else if (relic.effect.type === 'flat') {
                    effectDesc = `Adds ${relic.effect.value} to ${relic.effect.target.replace(/_/g, ' ')}`;
                }
                
                relicCard.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-2xl ${relic.color} mr-3">${relic.icon}</span>
                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-dark-text">${relic.name}</h4>
                            <div class="text-xs px-2 py-0.5 rounded inline-block ${relic.color} bg-opacity-20 mt-1">
                                ${capitalizeFirstLetter(relic.rarity)}
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${relic.desc}</p>
                    <div class="text-xs font-medium ${relic.color}">${effectDesc}</div>
                    
                    <div class="absolute top-0 right-0 w-full h-full pointer-events-none">
                        <div class="absolute top-3 right-3 w-4 h-4 rounded-full ${relic.color} opacity-50 cosmic-effect"></div>
                        <div class="absolute bottom-3 left-3 w-3 h-3 rounded-full ${relic.color} opacity-30 cosmic-effect" style="animation-delay: 0.5s"></div>
                    </div>
                `;
                
                relicsContainer.appendChild(relicCard);
            }
        }
        
        // Purchase an enlightenment upgrade
        function purchaseEnlightenmentUpgrade(upgradeId) {
            // Get the upgrade configuration
            const upgradeConfig = gameConfig.enlightenmentUpgrades.find(u => u.id === upgradeId);
            if (!upgradeConfig) return;
            
            // Get or initialize the upgrade in game state
            if (!gameState.prestige.permanentUpgrades[upgradeId]) {
                gameState.prestige.permanentUpgrades[upgradeId] = {
                    level: 0,
                    value: 0,
                    cost: upgradeConfig.baseCost
                };
                
                // Special case for starting resources
                if (upgradeId === 'starting_resources') {
                    gameState.prestige.permanentUpgrades[upgradeId].kpBonus = 0;
                    gameState.prestige.permanentUpgrades[upgradeId].rpBonus = 0;
                    gameState.prestige.permanentUpgrades[upgradeId].infBonus = 0;
                }
            }
            
            const upgrade = gameState.prestige.permanentUpgrades[upgradeId];
            
            // Check if at max level
            if (upgradeConfig.effect.cap && upgrade.level >= upgradeConfig.effect.cap) {
                showNotification('This upgrade is already at maximum level.', 'error');
                return;
            }
            
            // Calculate cost
            const cost = Math.floor(upgradeConfig.baseCost * Math.pow(upgradeConfig.costScaling, upgrade.level));
            
            // Check if enough EP
            if (gameState.prestige.enlightenmentPoints < cost) {
                showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                return;
            }
            
            // Deduct EP
            gameState.prestige.enlightenmentPoints -= cost;
            
            // Apply the upgrade
            upgrade.level += 1;
            
            // Update values based on effect type
            if (upgradeConfig.effect.type === 'percentage' || upgradeConfig.effect.type === 'flat') {
                if (upgradeId === 'starting_resources') {
                    upgrade.kpBonus += upgradeConfig.effect.kp;
                    upgrade.rpBonus += upgradeConfig.effect.rp;
                    upgrade.infBonus += upgradeConfig.effect.inf;
                } else {
                    upgrade.value += upgradeConfig.effect.value;
                }
            }
            
            // Update UI
            updateUI();
            
            showNotification(`${upgradeConfig.name} upgraded to level ${upgrade.level}!`, 'enlightenment');
        }
        
        // Update EP preview calculations
        function updateEpPreview() {
            // Calculate EP from player level
            const epFromLevel = Math.floor(gameState.player.level * gameConfig.epCalculation.levelFactor);
            document.getElementById('ep-from-level').textContent = epFromLevel;
            
            // Calculate EP from books completed
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameConfig.epCalculation.bookFactor);
            document.getElementById('ep-from-books').textContent = epFromBooks;
            
            // Calculate EP from discoveries (facilities, research, galaxy)
            let discoveryEP = 0;
            
            // From facilities
            let facilityLevels = 0;
            for (const facilityId in gameState.facilities) {
                const facility = gameState.facilities[facilityId];
                if (facility.built) {
                    facilityLevels += facility.level;
                }
            }
            discoveryEP += Math.floor(facilityLevels * gameConfig.epCalculation.facilityFactor);
            
            // From research (procedural + core)
            let researchCount = 0;
            for (const researchId in gameState.research) {
                const research = gameState.research[researchId];
                if (typeof research === 'object' && research !== null && research.researched) {
                    researchCount++;
                } else if (typeof research === 'boolean' && research === true) {
                    // Core research like enlightenmentStudies
                    researchCount++;
                }
            }
            discoveryEP += Math.floor(researchCount * gameConfig.epCalculation.researchFactor);
            
            // From galaxy discoveries
            const systemsDiscovered = gameState.galaxy.stats.systemsDiscovered;
            discoveryEP += Math.floor(systemsDiscovered * gameConfig.epCalculation.galaxyFactor);
            
            document.getElementById('ep-from-discoveries').textContent = discoveryEP;
            
            // Calculate total EP gain
            const totalEpGain = epFromLevel + epFromBooks + discoveryEP;
            document.getElementById('total-ep-gain').textContent = totalEpGain;
            document.getElementById('confirm-ep-gain').textContent = totalEpGain;
        }
        
        // Perform Ascension/Prestige
        function performAscension() {
            // Calculate EP to be earned
            const epFromLevel = Math.floor(gameState.player.level * gameConfig.epCalculation.levelFactor);
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameConfig.epCalculation.bookFactor);
            
            // Calculate EP from discoveries
            let discoveryEP = 0;
            
            // From facilities
            let facilityLevels = 0;
            for (const facilityId in gameState.facilities) {
                const facility = gameState.facilities[facilityId];
                if (facility.built) {
                    facilityLevels += facility.level;
                }
            }
            discoveryEP += Math.floor(facilityLevels * gameConfig.epCalculation.facilityFactor);
            
            // From research
            let researchCount = 0;
            for (const researchId in gameState.research) {
                const research = gameState.research[researchId];
                if (typeof research === 'object' && research !== null && research.researched) {
                    researchCount++;
                } else if (typeof research === 'boolean' && research === true) {
                    // Core research like enlightenmentStudies
                    researchCount++;
                }
            }
            discoveryEP += Math.floor(researchCount * gameConfig.epCalculation.researchFactor);
            
            // From galaxy discoveries
            const systemsDiscovered = gameState.galaxy.stats.systemsDiscovered;
            discoveryEP += Math.floor(systemsDiscovered * gameConfig.epCalculation.galaxyFactor);
            
            const totalEpGain = epFromLevel + epFromBooks + discoveryEP;
            
// Update lifetime stats
            gameState.lifetimeStats.totalPrestiges++;
            gameState.lifetimeStats.totalEnlightenmentPoints += totalEpGain;
            gameState.lifetimeStats.maxLevel = Math.max(gameState.lifetimeStats.maxLevel, gameState.player.level);
            gameState.lifetimeStats.maxBooks = Math.max(gameState.lifetimeStats.maxBooks, gameState.stats.booksCompleted);
            
            // Add EP to player
            gameState.prestige.enlightenmentPoints += totalEpGain;
            gameState.prestige.totalEnlightenmentEarned += totalEpGain;
            gameState.prestige.level++;
            
            // Remember permanent upgrades and relics
            const permanentUpgrades = {...gameState.prestige.permanentUpgrades};
            const relics = {...gameState.relics};
            const lifetimeStats = {...gameState.lifetimeStats};
            const prestigeInfo = {
                level: gameState.prestige.level,
                enlightenmentPoints: gameState.prestige.enlightenmentPoints,
                totalEnlightenmentEarned: gameState.prestige.totalEnlightenmentEarned,
                permanentUpgrades: permanentUpgrades
            };
            
            // Reset game state but keep enlightenment data
            gameState = {
                version: GAME_VERSION,
                lastSaved: Date.now(),
                lastOnline: Date.now(),
                player: {
                    level: 1,
                    experiencePoints: 0,
                    experienceToNextLevel: 100
                },
                resources: {
                    knowledgePoints: 50,
                    researchPoints: 0,
                    influence: 0
                },
                facilities: {},
                research: {
                    enlightenmentStudies: true, // Automatically researched after first prestige
                    stellarCartography: false
                },
                stats: {
                    booksCompleted: 0,
                    pagesRead: 0,
                    minutesRead: 0,
                    totalKpGenerated: 0,
                    facilitiesDiscovered: 0,
                    researchDiscovered: 0,
                    genreDistribution: {
                        'sci-fi': 0,
                        'fantasy': 0,
                        'non-fiction': 0,
                        'mystery': 0,
                        'history': 0,
                        'science': 0,
                        'biography': 0,
                        'custom': {}
                    }
                },
                currentBooks: [],
                prestige: {
                    unlocked: true,
                    level: prestigeInfo.level,
                    enlightenmentPoints: prestigeInfo.enlightenmentPoints,
                    totalEnlightenmentEarned: prestigeInfo.totalEnlightenmentEarned,
                    permanentUpgrades: permanentUpgrades
                },
                lifetimeStats: lifetimeStats,
                galaxy: {
                    unlocked: false,
                    discoveredSystems: {},
                    currentCoordinates: { x: 0, y: 0 },
                    viewCenter: { x: 0, y: 0 },
                    explorationRange: 3,
                    zoomLevel: 1,
                    nextSystemCost: 25,
                    systemCosts: {
                        base: 25,
                        distanceMultiplier: 1.2
                    },
                    activeCelestialObjects: [],
                    activeExpedition: null,
                    stats: {
                        systemsDiscovered: 0,
                        outpostsEstablished: 0,
                        objectsColonized: 0,
                        expeditionsCompleted: 0,
                        rareObjectsFound: 0
                    }
                },
                relics: relics,
                settings: {
                    offlineProgression: true,
                    offlineEfficiency: 50
                }
            };
            
            // Apply starting resources bonus from permanent upgrades
            if (permanentUpgrades.starting_resources) {
                gameState.resources.knowledgePoints += permanentUpgrades.starting_resources.kpBonus || 0;
                gameState.resources.researchPoints += permanentUpgrades.starting_resources.rpBonus || 0;
                gameState.resources.influence += permanentUpgrades.starting_resources.infBonus || 0;
            }
            
            // Apply facility retention if the upgrade exists
            if (permanentUpgrades.facility_retention && permanentUpgrades.facility_retention.level > 0) {
                // Generate initial facilities based on the level of retention
                const facilityLevel = permanentUpgrades.facility_retention.level;
                
                // Generate a research center
                if (facilityLevel >= 1) {
                    const researchCenter = generateRandomFacility();
                    researchCenter.name = "Quantum Research Center";
                    researchCenter.built = true;
                    researchCenter.level = 1;
                    researchCenter.effects = [
                        {
                            id: "rp_passive",
                            name: "Passive RP",
                            desc: "Generates 1.0 RP per minute",
                            value: 1.0,
                            icon: "🧪",
                            scalingFactor: 0.5
                        }
                    ];
                    gameState.facilities[researchCenter.id] = researchCenter;
                }
                
                // Generate a knowledge repository
                if (facilityLevel >= 2) {
                    const repository = generateRandomFacility();
                    repository.name = "Knowledge Repository";
                    repository.built = true;
                    repository.level = 1;
                    repository.effects = [
                        {
                            id: "kp_per_page",
                            name: "KP per Page",
                            desc: "Increases KP from pages by 8%",
                            value: 8,
                            icon: "📄",
                            scalingFactor: 0.5
                        }
                    ];
                    gameState.facilities[repository.id] = repository;
                }
                
                // Generate an observatory
                if (facilityLevel >= 3) {
                    const observatory = generateRandomFacility();
                    observatory.name = "Cosmic Observatory";
                    observatory.built = true;
                    observatory.level = 1;
                    observatory.effects = [
                        {
                            id: "exploration_bonus",
                            name: "Exploration Range",
                            desc: "Increases galaxy exploration range by 0.5",
                            value: 0.5,
                            icon: "🔭",
                            scalingFactor: 0.4
                        }
                    ];
                    gameState.facilities[observatory.id] = observatory;
                }
            }
            
            // Apply auto-research if upgrade exists
            if (permanentUpgrades.auto_research && permanentUpgrades.auto_research.level > 0) {
                // Generate and auto-research technologies based on level
                const autoResearchLevel = permanentUpgrades.auto_research.level;
                
                // Create utility array with research types to generate
                const researchTypes = [];
                
                // Each level unlocks a new auto-research type
                if (autoResearchLevel >= 1) {
                    // Speed Reading + Knowledge Efficiency
                    const speedReading = generateRandomResearch();
                    speedReading.name = "Speed Reading Techniques";
                    speedReading.effects = [
                        {
                            id: "kp_per_min",
                            name: "KP per Minute",
                            desc: "Increases KP from reading time by 15%",
                            value: 15,
                            icon: "⏱️"
                        }
                    ];
                    speedReading.researched = true;
                    gameState.research[speedReading.id] = speedReading;
                }
                
                if (autoResearchLevel >= 2) {
                    // Comprehension Techniques
                    const comprehension = generateRandomResearch();
                    comprehension.name = "Comprehension Algorithms";
                    comprehension.effects = [
                        {
                            id: "kp_per_page",
                            name: "KP per Page",
                            desc: "Increases KP from pages by 20%",
                            value: 20,
                            icon: "📄"
                        }
                    ];
                    comprehension.researched = true;
                    gameState.research[comprehension.id] = comprehension;
                }
                
                if (autoResearchLevel >= 3) {
                    // Facility discount
                    const construction = generateRandomResearch();
                    construction.name = "Advanced Construction";
                    construction.effects = [
                        {
                            id: "facility_discount",
                            name: "Building Discount",
                            desc: "Reduces facility cost by 15%",
                            value: 15,
                            icon: "🏗️"
                        }
                    ];
                    construction.researched = true;
                    gameState.research[construction.id] = construction;
                }
                
                if (autoResearchLevel >= 4) {
                    // Offline progression
                    const offlineProgress = generateRandomResearch();
                    offlineProgress.name = "Automated Collection";
                    offlineProgress.effects = [
                        {
                            id: "offline_bonus",
                            name: "Offline Efficiency",
                            desc: "Increases offline progression by 25%",
                            value: 25,
                            icon: "💤"
                        }
                    ];
                    offlineProgress.researched = true;
                    gameState.research[offlineProgress.id] = offlineProgress;
                }
                
                if (autoResearchLevel >= 5) {
                    // General facility boost
                    const optimization = generateRandomResearch();
                    optimization.name = "Facility Optimization";
                    optimization.effects = [
                        {
                            id: "facility_output",
                            name: "Facility Output",
                            desc: "Increases all facility outputs by 20%",
                            value: 20,
                            icon: "🏗️"
                        }
                    ];
                    optimization.researched = true;
                    gameState.research[optimization.id] = optimization;
                }
            }
            
            // Show notification
            showNotification(`Ascension successful! You gained ${totalEpGain} Enlightenment Points.`, 'enlightenment');
            
            // Update UI
            updateUI();
            
            // Hide the ascension modal
            document.getElementById('ascension-modal').classList.add('hidden');
        }
        
        // Discover a facility
        function discoverFacility() {
            // Calculate cost with any discounts
            let cost = gameConfig.facilityBaseCost;
            const facilityDiscountBonus = calculateTotalBonus('facility_discount');
            
            if (facilityDiscountBonus > 0) {
                cost = Math.floor(cost * (1 - (facilityDiscountBonus / 100)));
            }
            
            // Check if enough KP
            if (gameState.resources.knowledgePoints < cost) {
                showNotification('Not enough Knowledge Points to discover a new facility.', 'error');
                return;
            }
            
            // Deduct KP
            gameState.resources.knowledgePoints -= cost;
            
            // Generate a new facility
            const newFacility = generateRandomFacility();
            
            // Add to game state
            gameState.facilities[newFacility.id] = newFacility;
            
            // Update stats
            gameState.stats.facilitiesDiscovered++;
            
            // Show discovery modal
            showFacilityDiscoveryModal(newFacility);
            
            // Update UI
            updateUI();
        }
        
        // Discover a research technology
        function discoverResearch() {
            // Calculate cost with any discounts
            let cost = gameConfig.researchBaseCost;
            const researchDiscountBonus = calculateTotalBonus('research_discount');
            
            if (researchDiscountBonus > 0) {
                cost = Math.floor(cost * (1 - (researchDiscountBonus / 100)));
            }
            
            // Check if enough RP
            if (gameState.resources.researchPoints < cost) {
                showNotification('Not enough Research Points to discover a new technology.', 'error');
                return;
            }
            
            // Deduct RP
            gameState.resources.researchPoints -= cost;
            
            // Generate a new research
            const newResearch = generateRandomResearch();
            
            // Add to game state
            gameState.research[newResearch.id] = newResearch;
            
            // Update stats
            gameState.stats.researchDiscovered++;
            
            // Show discovery modal
            showResearchDiscoveryModal(newResearch);
            
            // Update UI
            updateUI();
        }
        
        // Show facility discovery modal
        function showFacilityDiscoveryModal(facility) {
            // Update modal content
            document.getElementById('discovery-type').textContent = 'New Facility Discovered!';
            document.getElementById('discovery-name').textContent = facility.name;
            document.getElementById('discovery-description').textContent = facility.description;
            
            // Update details with facility effects
            let detailsHTML = '';
            facility.effects.forEach(effect => {
                detailsHTML += `
                    <div class="flex items-center text-sm">
                        <span class="mr-2">${effect.icon}</span>
                        <span>${effect.desc}</span>
                    </div>
                `;
            });
            
            document.getElementById('discovery-details').innerHTML = `
                <div class="text-xs px-2 py-0.5 rounded bg-${facility.colorClass} bg-opacity-20 text-${facility.colorClass} inline-block">
                    ${facility.rarityName} Facility
                </div>
                <div class="mt-2 space-y-1">
                    ${detailsHTML}
                </div>
            `;
            
            // Set button text
            document.getElementById('close-discovery-modal').textContent = 'Awesome!';
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').onclick = () => {
                document.getElementById('discovery-modal').classList.add('hidden');
            };
        }
        
        // Show research discovery modal
        function showResearchDiscoveryModal(research) {
            // Update modal content
            document.getElementById('discovery-type').textContent = 'New Research Technology Discovered!';
            document.getElementById('discovery-name').textContent = research.name;
            document.getElementById('discovery-description').textContent = research.description;
            
            // Update details with research effects
            let detailsHTML = '';
            research.effects.forEach(effect => {
                detailsHTML += `
                    <div class="flex items-center text-sm">
                        <span class="mr-2">${effect.icon}</span>
                        <span>${effect.desc}</span>
                    </div>
                `;
            });
            
            document.getElementById('discovery-details').innerHTML = `
                <div class="text-xs px-2 py-0.5 rounded bg-${research.colorClass} bg-opacity-20 text-${research.colorClass} inline-block">
                    ${research.rarityName} Research
                </div>
                <div class="mt-2 space-y-1">
                    ${detailsHTML}
                </div>
            `;
            
            // Set button text
            document.getElementById('close-discovery-modal').textContent = 'Awesome!';
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').onclick = () => {
                document.getElementById('discovery-modal').classList.add('hidden');
            };
        }
        
        // Discover a galactic relic
        function discoverRelic() {
            // Generate a new relic
            const newRelic = generateRandomRelic();
            
            // Add to game state
            gameState.relics[newRelic.id] = newRelic;
            
            // Show discovery modal
            showRelicDiscoveryModal(newRelic);
            
            // Update UI
            updateUI();
        }
        
        // Show relic discovery modal
        function showRelicDiscoveryModal(relic) {
            // Update modal content
            document.getElementById('discovery-type').textContent = 'Ancient Galactic Relic Discovered!';
            document.getElementById('discovery-name').textContent = relic.name;
            document.getElementById('discovery-description').textContent = relic.desc;
            
            // Create effect description based on effect type
            let effectDesc = '';
            if (relic.effect.type === 'multiplier') {
                effectDesc = `Multiplies ${relic.effect.target.replace(/_/g, ' ')} by ${relic.effect.value}x`;
            } else if (relic.effect.type === 'percentage') {
                effectDesc = `Increases ${relic.effect.target.replace(/_/g, ' ')} by ${relic.effect.value}%`;
            } else if (relic.effect.type === 'flat') {
                effectDesc = `Adds ${relic.effect.value} to ${relic.effect.target.replace(/_/g, ' ')}`;
            }
            
            document.getElementById('discovery-details').innerHTML = `
                <div class="text-3xl ${relic.color} mb-2">${relic.icon}</div>
                <div class="text-xs px-2 py-0.5 rounded bg-opacity-20 ${relic.color} inline-block">
                    ${capitalizeFirstLetter(relic.rarity)} Relic
                </div>
                <div class="mt-3 font-medium ${relic.color}">${effectDesc}</div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    This relic will persist across prestige resets.
                </div>
            `;
            
            // Set button text
            document.getElementById('close-discovery-modal').textContent = 'Collect Relic';
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').onclick = () => {
                document.getElementById('discovery-modal').classList.add('hidden');
            };
        }
        
        // Check for unlocks based on player level and other criteria
        function checkUnlocks() {
            // Check for enlightenment unlock
            if (gameState.player.level >= gameConfig.prestigeRequirements.playerLevel && 
                gameState.stats.booksCompleted >= gameConfig.prestigeRequirements.booksCompleted &&
                gameState.research.enlightenmentStudies) {
                gameState.prestige.unlocked = true;
            }
        }
        
        // Log reading session
        function logReadingSession() {
            const bookTitle = document.getElementById('book-title').value.trim();
            let bookGenre = document.getElementById('book-genre').value;
            const bookDifficulty = document.getElementById('book-difficulty').value;
            const pagesRead = parseInt(document.getElementById('pages-read').value) || 0;
            const minutesRead = parseInt(document.getElementById('reading-minutes').value) || 0;
            
            // Validate input
            if (!bookTitle) {
                showNotification('Please enter a book title.', 'error');
                return;
            }
            
            if (pagesRead <= 0) {
                showNotification('Pages read must be greater than 0.', 'error');
                return;
            }
            
            if (minutesRead <= 0) {
                showNotification('Reading minutes must be greater than 0.', 'error');
                return;
            }
            
            // Handle custom genre
            let customGenre = '';
            if (bookGenre === 'custom') {
                customGenre = document.getElementById('custom-genre').value.trim();
                if (!customGenre) {
                    showNotification('Please enter a custom genre.', 'error');
                    return;
                }
            }
            
            // Calculate knowledge points earned
            const kpEarned = calculateReadingKp(pagesRead, minutesRead, bookDifficulty);
            
            // Add experience based on reading (10% of KP earned)
            const xpEarned = Math.ceil(kpEarned * 0.1);
            addExperience(xpEarned);
            
            // Update resources
            gameState.resources.knowledgePoints += kpEarned;
            gameState.stats.totalKpGenerated += kpEarned;
            
            // Update reading stats
            gameState.stats.pagesRead += pagesRead;
            gameState.stats.minutesRead += minutesRead;
            
            // Find existing book or add a new one
            let existingBook = gameState.currentBooks.find(book => book.title.toLowerCase() === bookTitle.toLowerCase());
            
            if (existingBook) {
                existingBook.pagesRead += pagesRead;
                existingBook.minutesRead += minutesRead;
            } else {
                gameState.currentBooks.push({
                    title: bookTitle,
                    genre: bookGenre,
                    customGenre: customGenre,
                    difficulty: bookDifficulty,
                    pagesRead: pagesRead,
                    minutesRead: minutesRead
                });
            }
            
            // Show notification
            showNotification(`Reading session logged! Earned ${kpEarned} Knowledge Points.`, 'success');
            
            // Update UI
            updateUI();
            
            // Animate KP gain
            animateResourceGain('Knowledge Points', kpEarned);
        }
        
        // Complete a book
        function completeBook() {
            const bookTitle = document.getElementById('book-title').value.trim();
            let bookGenre = document.getElementById('book-genre').value;
            let customGenre = '';
            
            if (bookGenre === 'custom') {
                customGenre = document.getElementById('custom-genre').value.trim();
            }
            
            // Validate input
            if (!bookTitle) {
                showNotification('Please enter a book title.', 'error');
                return;
            }
            
            // Check if the book exists in current books
            const bookIndex = gameState.currentBooks.findIndex(book => book.title.toLowerCase() === bookTitle.toLowerCase());
            
            if (bookIndex === -1) {
                showNotification('You need to log some reading sessions for this book first.', 'error');
                return;
            }
            
            const book = gameState.currentBooks[bookIndex];
            
            // Calculate completion bonus (20% of total KP earned from the book)
            const bookKp = calculateReadingKp(book.pagesRead, book.minutesRead, book.difficulty);
            let completionBonus = Math.floor(bookKp * gameConfig.completionBonus);
            
            // Apply completion bonus modifiers
            const completionBonusModifier = calculateTotalBonus('completion_bonus');
            if (completionBonusModifier > 0) {
                completionBonus = Math.floor(completionBonus * (1 + (completionBonusModifier / 100)));
            }
            
            // Apply completion boost from research
            const completionBoost = calculateTotalBonus('completion_boost');
            if (completionBoost > 0) {
                completionBonus = Math.floor(completionBonus * (1 + (completionBoost / 100)));
            }
            
            // Generate research points (10% of completion bonus)
            const rpEarned = Math.floor(completionBonus * 0.1);
            
            // Generate influence (5% of completion bonus)
            let influenceEarned = Math.floor(completionBonus * 0.05);
            
            // Apply influence gain modifiers
            const influenceGainModifier = calculateTotalBonus('influence_gain');
            if (influenceGainModifier > 0) {
                influenceEarned = Math.floor(influenceEarned * (1 + (influenceGainModifier / 100)));
            }
            
            // Add the resources
            gameState.resources.knowledgePoints += completionBonus;
            gameState.resources.researchPoints += rpEarned;
            gameState.resources.influence += influenceEarned;
            gameState.stats.totalKpGenerated += completionBonus;
            
            // Update genre distribution
            if (book.genre === 'custom') {
                if (!gameState.stats.genreDistribution.custom[book.customGenre]) {
                    gameState.stats.genreDistribution.custom[book.customGenre] = 0;
                }
                gameState.stats.genreDistribution.custom[book.customGenre]++;
            } else {
                gameState.stats.genreDistribution[book.genre]++;
            }
            
            // Remove the book from current books
            gameState.currentBooks.splice(bookIndex, 1);
            
            // Increment completed books count
            gameState.stats.booksCompleted++;
            
            // Add significant experience for completing a book
            const xpEarned = Math.ceil(completionBonus * 0.2);
            addExperience(xpEarned);
            
            // Show notification
            showNotification(`Book completed! Earned ${completionBonus} KP, ${rpEarned} RP, and ${influenceEarned} CI.`, 'success');
            
            // Check for rare discovery chance
            const discoveryChance = calculateTotalBonus('discovery_chance') / 100;
            if (Math.random() < (0.01 + discoveryChance)) { // Base 1% chance plus bonuses
                const roll = Math.random();
                if (roll < 0.6) { // 60% chance for facility
                    setTimeout(() => {
                        const newFacility = generateRandomFacility();
                        gameState.facilities[newFacility.id] = newFacility;
                        gameState.stats.facilitiesDiscovered++;
                        showFacilityDiscoveryModal(newFacility);
                        updateUI();
                    }, 1000);
                } else if (roll < 0.9) { // 30% chance for research
                    setTimeout(() => {
                        const newResearch = generateRandomResearch();
                        gameState.research[newResearch.id] = newResearch;
                        gameState.stats.researchDiscovered++;
                        showResearchDiscoveryModal(newResearch);
                        updateUI();
                    }, 1000);
                } else { // 10% chance for relic
                    setTimeout(() => {
                        discoverRelic();
                    }, 1000);
                }
            }
            
            // Clear the form
            document.getElementById('book-title').value = '';
            if (book.genre === 'custom') {
                document.getElementById('custom-genre').value = '';
                document.getElementById('custom-genre-container').classList.add('hidden');
            }
            document.getElementById('book-genre').value = 'sci-fi';
            document.getElementById('book-difficulty').value = 'medium';
            
            // Update UI
            updateUI();
            
            // Animate resource gains
            animateResourceGain('Knowledge Points', completionBonus);
            animateResourceGain('Research Points', rpEarned);
            animateResourceGain('Cosmic Influence', influenceEarned);
            
            // Check for unlocks based on books read
            checkUnlocks();
        }
        
        // Animate resource gain
        function animateResourceGain(resourceType, amount) {
            // Determine which resource icon to animate from
            let sourceElement;
            switch (resourceType) {
                case 'Knowledge Points':
                    sourceElement = document.querySelector('.resource-icon.bg-blue-100');
                    break;
                case 'Research Points':
                    sourceElement = document.querySelector('.resource-icon.bg-purple-100');
                    break;
                case 'Cosmic Influence':
                    sourceElement = document.querySelector('.resource-icon.bg-yellow-100');
                    break;
                default:
                    return;
            }
            
            if (!sourceElement) return;
            
            // Create the animation element
            const animElement = document.createElement('div');
            animElement.className = 'absolute text-sm font-bold text-primary';
            animElement.textContent = `+${amount}`;
            
            // Position the element at the source
            const rect = sourceElement.getBoundingClientRect();
            animElement.style.left = `${rect.left + rect.width/2}px`;
            animElement.style.top = `${rect.top}px`;
            
            // Add to document
            document.body.appendChild(animElement);
            
            // Start animation
            animElement.style.transition = 'all 1s ease-out';
            setTimeout(() => {
                animElement.style.transform = 'translateY(-20px)';
                animElement.style.opacity = '0';
            }, 50);
            
            // Remove after animation
            setTimeout(() => {
                document.body.removeChild(animElement);
            }, 1050);
        }
        
        // Show a notification
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification flex items-center mb-2 shadow-lg opacity-0 transition-opacity duration-300';
            
            // Set color based on type
            let bgColor, textColor, iconSvg;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-800';
                    textColor = 'text-green-800 dark:text-green-100';
                    iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>`;
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-800';
                    textColor = 'text-red-800 dark:text-red-100';
                    iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>`;
                    break;
                case 'enlightenment':
                    bgColor = 'bg-red-50 dark:bg-red-900';
                    textColor = 'text-enlightenment';
                    iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>`;
                    break;
                default: // info
                    bgColor = 'bg-blue-100 dark:bg-blue-800';
                    textColor = 'text-blue-800 dark:text-blue-100';
                    iconSvg = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
            }
            
            notification.classList.add(bgColor, textColor);
            
            // Add content
            notification.innerHTML = `
                ${iconSvg}
                <span>${message}</span>
            `;
            
            // Add to notification area
            notificationArea.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.classList.add('opacity-100');
            }, 10);
            
            // Remove after a delay
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                setTimeout(() => {
                    notificationArea.removeChild(notification);
                }, 300);
            }, 4000);
        }
        
        // Helper function: Capitalize first letter
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Save game to localStorage
        function saveGame() {
            try {
                // Update last saved timestamp
                gameState.lastSaved = Date.now();
                
                // Convert the game state to a JSON string
                const saveData = JSON.stringify(gameState);
                
                // Save to localStorage
                localStorage.setItem('stellarBibliophile', saveData);
                
                return true;
            } catch (error) {
                console.error('Error saving game:', error);
                return false;
            }
        }
        
        // Load game from localStorage
        function loadGame() {
            try {
                // Get the saved data from localStorage
                const saveData = localStorage.getItem('stellarBibliophile');
                
                if (!saveData) return false;
                
                // Parse the JSON data
                const loadedState = JSON.parse(saveData);
                
                // Check version and handle migrations if needed
                if (loadedState.version !== GAME_VERSION) {
                    // Simple migration - just keep the game state as is
                    // In a full game, you'd add version-specific migrations here
                }
                
                // Update the game state
                gameState = loadedState;
                
                // Check for offline progress
                checkOfflineProgress();
                
                return true;
            } catch (error) {
                console.error('Error loading game:', error);
                return false;
            }
        }
        
        // Check for offline progress when the game loads
        function checkOfflineProgress() {
            const offlineProgress = calculateOfflineProgression();
            
            if (offlineProgress) {
                // Update last online time
                gameState.lastOnline = Date.now();
                
                // Show the offline progress modal
                document.getElementById('offline-kp').textContent = offlineProgress.resources.knowledgePoints;
                document.getElementById('offline-rp').textContent = offlineProgress.resources.researchPoints;
                document.getElementById('offline-influence').textContent = offlineProgress.resources.influence;
                document.getElementById('offline-time').textContent = offlineProgress.time;
                document.getElementById('offline-progress-efficiency').textContent = offlineProgress.efficiency;
                
                document.getElementById('offline-progress-modal').classList.remove('hidden');
                
                // Add event listener to claim button
                document.getElementById('claim-offline-progress').addEventListener('click', () => {
                    // Add resources
                    gameState.resources.knowledgePoints += offlineProgress.resources.knowledgePoints;
                    gameState.resources.researchPoints += offlineProgress.resources.researchPoints;
                    gameState.resources.influence += offlineProgress.resources.influence;
                    
                    // Hide modal
                    document.getElementById('offline-progress-modal').classList.add('hidden');
                    
                    // Update UI
                    updateUI();
                    
                    // Show notification
                    showNotification('Offline resources claimed!', 'success');
                });
            }
        }
        
        // Export save data to a string
        function exportSaveData() {
            try {
                const saveData = JSON.stringify(gameState);
                const encodedData = btoa(saveData);
                return encodedData;
            } catch (error) {
                console.error('Error exporting save data:', error);
                return null;
            }
        }
        
        // Import save data from a string
        function importSaveData(encodedData) {
            try {
                const saveData = atob(encodedData);
                const loadedState = JSON.parse(saveData);
                
                // Check if it's valid game data
                if (!loadedState.version) {
                    showNotification('Invalid save data.', 'error');
                    return false;
                }
                
                // Update the game state
                gameState = loadedState;
                
                // Update UI
                updateUI();
                
                showNotification('Game imported successfully!', 'success');
                return true;
            } catch (error) {
                console.error('Error importing save data:', error);
                showNotification('Error importing save data.', 'error');
                return false;
            }
        }
        
        // Reset the game
        function resetGame() {
            // Confirm with user
            if (!confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                return;
            }
            
            // Reset game state
            gameState = {
                version: GAME_VERSION,
                lastSaved: Date.now(),
                lastOnline: Date.now(),
                player: {
                    level: 1,
                    experiencePoints: 0,
                    experienceToNextLevel: 100
                },
                resources: {
                    knowledgePoints: 100,
                    researchPoints: 0,
                    influence: 0
                },
                facilities: {},
                research: {
                    enlightenmentStudies: false,
                    stellarCartography: false
                },
                stats: {
                    booksCompleted: 0,
                    pagesRead: 0,
                    minutesRead: 0,
                    totalKpGenerated: 0,
                    facilitiesDiscovered: 0,
                    researchDiscovered: 0,
                    genreDistribution: {
                        'sci-fi': 0,
                        'fantasy': 0,
                        'non-fiction': 0,
                        'mystery': 0,
                        'history': 0,
                        'science': 0,
                        'biography': 0,
                        'custom': {}
                    }
                },
                currentBooks: [],
                prestige: {
                    unlocked: false,
                    level: 0,
                    enlightenmentPoints: 0,
                    totalEnlightenmentEarned: 0,
                    permanentUpgrades: {}
                },
                lifetimeStats: {
                    totalPrestiges: 0,
                    maxLevel: 1,
                    maxBooks: 0,
                    totalEnlightenmentPoints: 0
                },
                galaxy: {
                    unlocked: false,
                    discoveredSystems: {},
                    currentCoordinates: { x: 0, y: 0 },
                    viewCenter: { x: 0, y: 0 },
                    explorationRange: 3,
                    zoomLevel: 1,
                    nextSystemCost: 25,
                    systemCosts: {
                        base: 25,
                        distanceMultiplier: 1.2
                    },
                    activeCelestialObjects: [],
                    activeExpedition: null,
                    stats: {
                        systemsDiscovered: 0,
                        outpostsEstablished: 0,
                        objectsColonized: 0,
                        expeditionsCompleted: 0,
                        rareObjectsFound: 0
                    }
                },
                relics: {},
                settings: {
                    offlineProgression: true,
                    offlineEfficiency: 50
                }
            };
            
            // Update UI
            updateUI();
            
            // Clear localStorage
            localStorage.removeItem('stellarBibliophile');
            
            showNotification('Game reset successfully.', 'success');
        }
        
        // Set up UI event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-link').forEach(t => {
                        t.classList.remove('active', 'border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('active', 'border-primary', 'text-primary');
                    tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    
                    // Handle enlightenment tab specially
                    if (tab.getAttribute('data-tab') === 'enlightenment') {
                        tab.classList.add('text-enlightenment');
                        tab.classList.remove('text-primary');
                        
                        // Update EP preview calculations
                        updateEpPreview();
                    }
                    
                    // Update genre distribution if on stats tab
                    if (tab.getAttribute('data-tab') === 'stats') {
                        updateGenreDistribution();
                    }
                    
                    // Initialize galaxy map if on galaxy tab
                    if (tab.getAttribute('data-tab') === 'galaxy') {
                        updateGalaxyUI();
                        if (gameState.galaxy.unlocked) {
                            initializeGalaxyMap();
                        }
                    }
                    
                    // Hide all tab panes
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.add('hidden');
                        pane.classList.remove('active');
                    });
                    
                    // Show the target tab pane
                    const tabName = tab.getAttribute('data-tab');
                    const tabPane = document.getElementById(tabName + '-tab');
                    tabPane.classList.remove('hidden');
                    tabPane.classList.add('active');
                });
            });
            
            // Custom Genre Selection
            document.getElementById('book-genre').addEventListener('change', function() {
                const customGenreContainer = document.getElementById('custom-genre-container');
                if (this.value === 'custom') {
                    customGenreContainer.classList.remove('hidden');
                } else {
                    customGenreContainer.classList.add('hidden');
                }
            });
            
            // Reading form buttons
            document.getElementById('log-reading').addEventListener('click', logReadingSession);
            document.getElementById('complete-book').addEventListener('click', completeBook);
            
            // Offline progression toggle
            document.getElementById('offline-progression').addEventListener('change', function() {
                gameState.settings.offlineProgression = this.checked;
                
                // Update slider position
                const slider = document.getElementById('offline-slider');
                if (this.checked) {
                    slider.classList.add('translate-x-6');
                    slider.classList.remove('translate-x-0');
                } else {
                    slider.classList.remove('translate-x-6');
                    slider.classList.add('translate-x-0');
                }
                
                saveGame();
            });
            
            // Discover facility button
            document.getElementById('discover-facility-btn').addEventListener('click', discoverFacility);
            
            // Discover research button
            document.getElementById('discover-research-btn').addEventListener('click', discoverResearch);
            
            // Discover galaxy system button
            document.getElementById('discover-system-btn').addEventListener('click', exploreSystem);
            
            // Core research buttons
            document.getElementById('research-enlightenment').addEventListener('click', function() {
                if (gameState.research.enlightenmentStudies) return;
                
                if (gameState.resources.researchPoints < 500) {
                    showNotification('Not enough Research Points to research Enlightenment Studies.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 500;
                gameState.research.enlightenmentStudies = true;
                gameState.prestige.unlocked = true;
                
                showNotification('Enlightenment Studies researched! You can now ascend for Enlightenment Points.', 'enlightenment');
                
                updateUI();
            });
            
            document.getElementById('research-cartography').addEventListener('click', function() {
                if (gameState.research.stellarCartography) return;
                
                if (gameState.resources.researchPoints < 150) {
                    showNotification('Not enough Research Points to research Stellar Cartography.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 150;
                gameState.research.stellarCartography = true;
                gameState.galaxy.unlocked = true;
                
                showNotification('Stellar Cartography researched! You can now explore the Literary Galaxy.', 'success');
                
                updateUI();
            });
            
            // Ascension buttons
            document.getElementById('ascend-button').addEventListener('click', function() {
                // Show confirmation modal
                document.getElementById('ascension-modal').classList.remove('hidden');
                
                // Update EP preview
                updateEpPreview();
            });
            
            document.getElementById('prestige-button').addEventListener('click', function() {
                // Show confirmation modal
                document.getElementById('ascension-modal').classList.remove('hidden');
                
                // Update EP preview
                updateEpPreview();
            });
            
            document.getElementById('confirm-ascension').addEventListener('click', performAscension);
            document.getElementById('cancel-ascension').addEventListener('click', function() {
                document.getElementById('ascension-modal').classList.add('hidden');
            });
            
            // Save/Load functions
            document.getElementById('export-save').addEventListener('click', function() {
                const saveData = exportSaveData();
                if (saveData) {
                    document.getElementById('export-save-text').value = saveData;
                    document.getElementById('save-export-modal').classList.remove('hidden');
                } else {
                    showNotification('Error exporting save data.', 'error');
                }
            });
            
            document.getElementById('copy-save').addEventListener('click', function() {
                const saveData = exportSaveData();
                if (saveData) {
                    navigator.clipboard.writeText(saveData)
                        .then(() => {
                            showNotification('Save data copied to clipboard!', 'success');
                        })
                        .catch(err => {
                            showNotification('Error copying to clipboard.', 'error');
                        });
                } else {
                    showNotification('Error exporting save data.', 'error');
                }
            });
            
            document.getElementById('copy-save-modal').addEventListener('click', function() {
                const saveText = document.getElementById('export-save-text');
                saveText.select();
                document.execCommand('copy');
                showNotification('Save data copied to clipboard!', 'success');
            });
            
            document.getElementById('close-export-modal').addEventListener('click', function() {
                document.getElementById('save-export-modal').classList.add('hidden');
            });
            
            document.getElementById('import-save').addEventListener('click', function() {
                const saveData = document.getElementById('import-save-data').value.trim();
                if (saveData) {
                    importSaveData(saveData);
                } else {
                    showNotification('Please enter save data to import.', 'error');
                }
            });
            
            document.getElementById('import-file-btn').addEventListener('click', function() {
                document.getElementById('import-save-file').click();
            });
            
            document.getElementById('import-save-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const contents = e.target.result;
                        importSaveData(contents);
                    } catch (error) {
                        showNotification('Error loading save file.', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Update the file name display
                document.getElementById('file-name').textContent = file.name;
            });
            
            document.getElementById('download-save').addEventListener('click', function() {
                const saveData = exportSaveData();
                if (!saveData) {
                    showNotification('Error creating save file.', 'error');
                    return;
                }
                
                // Create a blob and download link
                const blob = new Blob([saveData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'stellar_bibliophile_save.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Reset game button
            document.getElementById('reset-game').addEventListener('click', resetGame);
        }
        
        // Resource generation interval
        function startResourceGeneration() {
            setInterval(() => {
                // Calculate passive resources generated since last tick
                const resources = calculatePassiveResources(gameConfig.resourceInterval);
                
                // Add resources
                gameState.resources.knowledgePoints += resources.knowledgePoints;
                gameState.resources.researchPoints += resources.researchPoints;
                gameState.resources.influence += resources.influence;
                
                // Update stats
                gameState.stats.totalKpGenerated += resources.knowledgePoints;
                
                // Update UI
                updateUI();
            }, gameConfig.resourceInterval);
        }
        
        // Initialize the game
        function init() {
            // Try to load saved game
            const loaded = loadGame();
            
            if (!loaded) {
                // First time setup - generate initial facilities
                const initialFacility = generateRandomFacility();
                initialFacility.name = "Basic Research Center";
                initialFacility.rarity = "common";
                initialFacility.rarityName = "Common";
                initialFacility.colorClass = "blue-500";
                initialFacility.effects = [
                    {
                        id: "rp_passive",
                        name: "Passive RP",
                        desc: "Generates 0.5 RP per minute",
                        value: 0.5,
                        icon: "🧪",
                        scalingFactor: 0.5
                    }
                ];
                
                gameState.facilities[initialFacility.id] = initialFacility;
                gameState.stats.facilitiesDiscovered = 1;
                
                // Save initial state
                saveGame();
            }
            
            // Set up UI event listeners
            setupEventListeners();
            
            // Start resource generation
            startResourceGeneration();
            
            // Update the UI
            updateUI();
            
            // Set up autosave
            setInterval(saveGame, 60000); // Save every minute
            
            // Update last online time when the window is closed/refreshed
            window.addEventListener('beforeunload', () => {
                gameState.lastOnline = Date.now();
                saveGame();
            });
        }
        
        // Make helper functions globally available
        window.buildFacility = buildFacility;
        window.upgradeFacility = upgradeFacility;
        window.researchTechnology = researchTechnology;
        window.purchaseEnlightenmentUpgrade = purchaseEnlightenmentUpgrade;
        window.exploreSystem = exploreSystem;
        window.establishOutpost = establishOutpost;
        window.colonizeCelestialObject = colonizeCelestialObject;
        
        // Initialize the game when the document is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
