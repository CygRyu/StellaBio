<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Bibliophile 2.0: Reading Strategy Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#34D399',
                        cosmic: '#805AD5',
                        danger: '#F87171',
                        warning: '#FBBF24',
                        info: '#60A5FA',
                        enlightenment: '#FF6B6B',
                        galaxy: '#4F46E5',
                        dark: {
                            bg: '#181818',
                            card: '#252525',
                            text: '#E5E5E5'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'space-twinkle': 'twinkle 3s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        glow: {
                            '0%': { textShadow: '0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B' },
                            '100%': { textShadow: '0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B' }
                        },
                        twinkle: {
                            '0%': { opacity: '0.5' },
                            '50%': { opacity: '1' },
                            '100%': { opacity: '0.7' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .resource-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        /* Progress bar animations */
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .progress-animation {
            animation: progress 30s linear infinite;
        }
        
        /* Dark mode support */
        .dark .dark\:bg-dark-bg { background-color: #181818; }
        .dark .dark\:bg-dark-card { background-color: #252525; }
        .dark .dark\:text-dark-text { color: #E5E5E5; }
        .dark .dark\:border-gray-700 { border-color: #4B5563; }
        
        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 240px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
        }
        
        /* Enlightenment glow effect */
        .enlightenment-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B; }
            100% { text-shadow: 0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B; }
        }
        
        /* Galaxy map styling */
        .galaxy-map {
            position: relative;
            overflow: hidden;
            background-color: #070b19;
            border-radius: 8px;
        }
        
        .star {
            position: absolute;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .star-system:hover {
            transform: scale(1.2);
        }
        
        .star-system.discovered {
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system.unexplored {
            opacity: 0.6;
            filter: grayscale(70%);
        }
        
        .exploration-radius {
            position: absolute;
            border: 2px dashed rgba(93, 92, 222, 0.4);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .star-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            z-index: 20;
            min-width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Galaxy controls */
        .galaxy-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(5px);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .galaxy-control-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .galaxy-control-btn:hover {
            background-color: rgba(93, 92, 222, 0.6);
        }
        
        /* Relic styling */
        .relic-card {
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .relic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .relic-border {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            pointer-events: none;
            z-index: 2;
        }
        
        .relic-common {
            box-shadow: 0 0 10px 2px rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .relic-uncommon {
            box-shadow: 0 0 10px 2px rgba(52, 211, 153, 0.3);
            border: 1px solid rgba(52, 211, 153, 0.5);
        }
        
        .relic-rare {
            box-shadow: 0 0 10px 2px rgba(96, 165, 250, 0.3);
            border: 1px solid rgba(96, 165, 250, 0.5);
        }
        
        .relic-epic {
            box-shadow: 0 0 10px 2px rgba(128, 90, 213, 0.3);
            border: 1px solid rgba(128, 90, 213, 0.5);
        }
        
        .relic-legendary {
            box-shadow: 0 0 10px 2px rgba(248, 113, 113, 0.3);
            border: 1px solid rgba(248, 113, 113, 0.5);
        }
        
        /* Floating animation */
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        /* Modal animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms, transform 200ms;
        }
        
        /* Notification system */
        .notification-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            max-width: 100%;
            width: 320px;
        }
        
        .notification {
            margin-top: 0.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Building glow effect */
        .building-glow {
            transition: box-shadow 0.3s ease;
        }
        
        .building-glow:hover {
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.5);
        }
        
        /* Quick stats */
        .quick-stats {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            backdrop-filter: blur(5px);
            display: none;
        }
        
        /* Resource acquisition animation */
        @keyframes resource-gain {
            0% { opacity: 0; transform: translateY(0); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .resource-gain {
            position: absolute;
            pointer-events: none;
            animation: resource-gain 1.5s ease-out forwards;
            font-weight: bold;
            z-index: 30;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg min-h-screen transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-dark-text mb-2">Stellar Bibliophile 2.0</h1>
            <p class="text-gray-600 dark:text-gray-400">Reading Tracker with Procedural Strategy Elements</p>
            <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">v2.0.0</div>
        </header>

        <!-- Resources Bar -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200" id="resources-container">
            <div class="grid grid-cols-3 md:grid-cols-5 gap-2 md:gap-4">
                <div class="flex items-center">
                    <div class="resource-icon bg-blue-100 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Knowledge Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="knowledge-points">0</span> KP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-purple-100 text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Research Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="research-points">0</span> RP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-yellow-100 text-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Influence</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="influence">0</span> INF</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-green-100 text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Quantum Fragments</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="quantum-fragments">0</span> QF</div>
                    </div>
                </div>
                <div id="enlightenment-container" class="flex items-center">
                    <div class="resource-icon bg-red-100 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Enlightenment</div>
                        <div class="font-bold text-enlightenment"><span id="enlightenment-points">0</span> EP</div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex justify-between">
                <div>Level: <span id="player-level" class="font-medium">1</span></div>
                <div>Passive RP: <span id="passive-rp" class="font-medium">0</span>/min</div>
                <div>Books Read: <span id="books-read" class="font-medium">0</span></div>
                <div>Relics Found: <span id="relics-found" class="font-medium">0</span></div>
                <div id="prestige-level-container">Prestige: <span id="prestige-level" class="font-medium">0</span></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <a href="#" class="tab-link active inline-block p-4 border-b-2 border-primary text-primary dark:text-primary rounded-t-lg" data-tab="reading">Reading Tracker</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="facilities">Facilities</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="research">Research</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="galaxy">Galaxy</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="relics">Relics</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="stats">Stats</a>
                </li>
                <li id="enlightenment-tab-li">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg enlightenment-text" data-tab="enlightenment">Ascension</a>
                </li>
                <li>
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="settings">Settings</a>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Reading Tracker Tab -->
            <div id="reading-tab" class="tab-pane active">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Track Your Reading</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Book Title</label>
                        <input type="text" id="book-title" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter book title">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Genre</label>
                            <select id="book-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="sci-fi">Science Fiction</option>
                                <option value="fantasy">Fantasy</option>
                                <option value="non-fiction">Non-Fiction</option>
                                <option value="mystery">Mystery/Thriller</option>
                                <option value="history">History</option>
                                <option value="science">Science</option>
                                <option value="biography">Biography</option>
                                <option value="philosophy">Philosophy</option>
                                <option value="poetry">Poetry</option>
                                <option value="comic">Comic/Graphic Novel</option>
                                <option value="custom">Other (Custom)</option>
                            </select>
                            <div id="custom-genre-container" class="mt-2 hidden">
                                <input type="text" id="custom-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter custom genre">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Difficulty</label>
                            <select id="book-difficulty" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="easy">Easy (x1.0 KP)</option>
                                <option value="medium" selected>Medium (x1.5 KP)</option>
                                <option value="hard">Hard (x2.0 KP)</option>
                                <option value="expert">Expert (x3.0 KP)</option>
                                <option value="legendary">Legendary (x5.0 KP)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pages Read</label>
                            <input type="number" id="pages-read" min="1" value="10" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reading Minutes</label>
                            <input type="number" id="reading-minutes" min="1" value="30" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="log-reading" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200 flex-grow">
                            Log Reading Session
                        </button>
                        <button id="complete-book" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                            Complete Book
                        </button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Current Reading</h2>
                    <div id="current-reading-list" class="space-y-3">
                        <div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>
                    </div>
                </div>
            </div>

            <!-- Facilities Tab -->
            <div id="facilities-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Your Facilities</h2>
                        <button id="discover-facility-btn" class="text-sm bg-primary hover:bg-blue-700 text-white py-1 px-3 rounded">
                            Discover New Facility
                        </button>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Build and upgrade procedurally generated facilities to boost your reading journey.</p>
                    
                    <div id="facility-discovery-cost" class="text-xs text-gray-600 dark:text-gray-400 mb-4">
                        Next facility discovery cost: <span id="next-facility-cost">100</span> KP and <span id="next-facility-rp-cost">20</span> RP
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative" id="facilities-grid">
                        <!-- Facilities will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Research Tab -->
            <div id="research-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-4 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Research Technologies</h2>
                        <button id="generate-research-btn" class="text-sm bg-primary hover:bg-blue-700 text-white py-1 px-3 rounded">
                            Generate New Research
                        </button>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Discover and research new technologies to enhance your capabilities.</p>
                    
                    <div id="research-generation-cost" class="text-xs text-gray-600 dark:text-gray-400 mb-4">
                        Next research generation cost: <span id="next-research-cost">75</span> RP
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="research-projects-container">
                    <!-- Research projects will be generated here -->
                </div>
            </div>

            <!-- Galaxy Tab -->
            <div id="galaxy-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Literary Galaxy</h2>
                        <div class="flex items-center">
                            <div class="resource-icon bg-yellow-100 text-yellow-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </div>
                            <span class="font-medium text-gray-700 dark:text-gray-300"><span id="galaxy-influence">0</span> INF</span>
                        </div>
                    </div>
                    
                    <div id="galaxy-unlock-message" class="py-8 text-center">
                        <div class="text-4xl mb-4">ðŸ”­</div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Unlock the Literary Galaxy</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4 max-w-lg mx-auto">
                            Build a Research Observatory or similar facility to explore the vast Literary Galaxy, discover star systems, and establish reading outposts for powerful bonuses.
                        </p>
                        <button id="force-unlock-galaxy" class="bg-primary hover:bg-blue-700 text-white text-sm py-2 px-4 rounded">
                            Unlock Galaxy (100 INF)
                        </button>
                    </div>
                    
                    <div id="galaxy-interface" class="hidden">
                        <div class="mb-4">
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
                                Explore the Literary Galaxy to discover star systems and establish reading outposts. Each system provides unique bonuses to your reading journey.
                            </p>
                            
                            <div class="flex flex-wrap gap-4 mb-4">
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Systems Discovered</div>
                                    <div class="text-2xl font-bold text-galaxy" id="systems-discovered">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Outposts Established</div>
                                    <div class="text-2xl font-bold text-galaxy" id="outposts-established">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exploration Range</div>
                                    <div class="text-2xl font-bold text-galaxy" id="exploration-range">3</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Next System Cost</div>
                                    <div class="text-2xl font-bold text-galaxy" id="next-system-cost">25</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="galaxy-map-container">
                            <div class="galaxy-map w-full h-[400px] relative mb-4" id="galaxy-map">
                                <!-- Background stars (added via JS) -->
                                <!-- Star systems (added via JS) -->
                                <!-- Exploration radius visualization -->
                                <div class="exploration-radius" id="exploration-radius"></div>
                                
                                <!-- Galaxy map controls -->
                                <div class="galaxy-controls">
                                    <button class="galaxy-control-btn" id="zoom-in">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="zoom-out">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="center-map">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="explore-system">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Star system tooltip (shown when hovering over a system) -->
                                <div class="star-tooltip" id="star-tooltip"></div>
                            </div>
                        </div>
                        
                        <!-- Selected System Details Panel -->
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 hidden" id="system-details-panel">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text" id="selected-system-name">System Name</h3>
                                <div class="text-sm px-2 py-1 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" id="selected-system-type">Star Type</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" id="selected-system-description">
                                        System description will appear here.
                                    </p>
                                    <div class="flex space-x-6 text-sm">
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Coordinates:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-coordinates">(0, 0)</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Planets:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-planets">0</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Rarity:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-rarity">Common</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end items-center">
                                    <button id="establish-outpost-btn" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Establish Outpost (25 INF)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">Planets</h4>
                                <div id="system-planets-list" class="space-y-2">
                                    <!-- Planets will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expedition Status Panel -->
                        <div id="expedition-panel" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 overflow-hidden hidden">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-medium text-blue-800 dark:text-blue-200">Expedition in Progress</h3>
                                <span class="text-sm text-blue-600 dark:text-blue-300" id="expedition-time">0:30</span>
                            </div>
                            <p class="text-sm text-blue-600 dark:text-blue-300 mb-2" id="expedition-message">
                                Your literary expedition is exploring the cosmos...
                            </p>
                            <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2 overflow-hidden">
                                <div id="expedition-progress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Outposts Panel -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Active Reading Outposts</h2>
                    
                    <div id="no-outposts-message" class="py-8 text-center">
                        <p class="text-gray-600 dark:text-gray-400">
                            You haven't established any reading outposts yet. Explore the galaxy to find star systems and establish outposts.
                        </p>
                    </div>
                    
                    <div id="outposts-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- Active outposts will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Relics Tab -->
            <div id="relics-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-2">Galactic Relics</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Discover and collect powerful artifacts that persist across ascensions, providing permanent bonuses to your reading journey.</p>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            <span class="font-medium">Relics Found:</span> <span id="relics-count">0</span> / <span id="total-relics">24</span>
                        </div>
                        <div>
                            <button id="discover-relic-btn" class="bg-primary hover:bg-blue-700 text-white text-sm py-1 px-3 rounded">
                                Search for Relic (50 QF)
                            </button>
                        </div>
                    </div>
                    
                    <div id="no-relics-message" class="py-8 text-center">
                        <p class="text-gray-600 dark:text-gray-400">
                            You haven't discovered any relics yet. Complete books, explore the galaxy, and use Quantum Fragments to search for these powerful artifacts.
                        </p>
                    </div>
                    
                    <div id="relics-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 hidden">
                        <!-- Relics will be dynamically added here -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-2">Relic Collections</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Complete relic sets to unlock powerful synergy bonuses.</p>
                    
                    <div id="relic-collections-container" class="space-y-4">
                        <!-- Collection progress will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Reading Statistics</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-books">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Books Completed</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-pages">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Pages Read</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-minutes">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Reading Minutes</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-kp">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">KP Generated</div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Genre Distribution</h3>
                    <div id="genre-distribution" class="space-y-3 mb-6">
                        <!-- Genre bars will be generated dynamically -->
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Achievements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Bookworm</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Complete 5 books</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="bookworm-progress">0</span>/5</div>
                            </div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Prolific Reader</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Read 1000 pages</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="prolific-progress">0</span>/1000</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Discovery Stats Section -->
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Discovery Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-primary"><span id="stat-facilities">0</span></div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Facilities Built</div>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-primary"><span id="stat-research">0</span></div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Research Completed</div>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-primary"><span id="stat-systems">0</span></div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Star Systems</div>
                            </div>
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-enlightenment"><span id="stat-relics">0</span></div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Relics Found</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prestige Stats Section -->
                    <div id="prestige-stats-section" class="mt-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Prestige Statistics</h3>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-prestige">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Prestiges</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-ep">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total EP Earned</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-level">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Highest Level</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-books">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Most Books Read</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enlightenment Tab -->
            <div id="enlightenment-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-enlightenment">Enlightenment</h2>
                        <div class="text-enlightenment font-bold">EP Available: <span id="available-ep">0</span></div>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Unlock permanent upgrades with Enlightenment Points. These bonuses persist through prestige resets.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="enlightenment-upgrades-container">
                        <!-- Enlightenment upgrades will be dynamically added here -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-enlightenment mb-4">Ascension</h2>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Ascending will reset your progress, but reward you with Enlightenment Points (EP) based on your achievements. These points can be spent on permanent upgrades.
                        </p>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-gray-900 dark:text-white mb-2">Enlightenment Points Preview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Level:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-level">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Books:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-books">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Research:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-research">0</span> EP</span>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total EP to be gained:</span>
                                <span class="text-2xl font-bold text-enlightenment ml-2"><span id="total-ep-gain">0</span> EP</span>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2">Persistent Items</h3>
                            <p class="text-yellow-700 dark:text-yellow-300 text-sm mb-2">
                                These items will be retained after ascension:
                            </p>
                            <ul class="list-disc list-inside text-yellow-600 dark:text-yellow-400 text-sm">
                                <li>All discovered Relics and their bonuses</li>
                                <li>All Enlightenment upgrades</li>
                                <li>Quantum Fragments (75% retained)</li>
                                <li><span id="persisting-facilities-count">0</span> Facilities (based on Enlightenment upgrades)</li>
                            </ul>
                        </div>
                        
                        <div class="flex justify-center">
                            <button id="ascend-button" class="bg-enlightenment hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 text-center flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                Ascend
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Game Settings</h2>
                    
                    <div class="space-y-6">
                        <!-- Game Options -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Game Options</h3>
                            <div class="space-y-3 mb-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto-save" class="rounded text-primary focus:ring-primary h-4 w-4">
                                    <label for="auto-save" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Auto-save game (every 60 seconds)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="show-notifications" class="rounded text-primary focus:ring-primary h-4 w-4" checked>
                                    <label for="show-notifications" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Show notifications</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="offline-progress" class="rounded text-primary focus:ring-primary h-4 w-4" checked>
                                    <label for="offline-progress" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Calculate offline progress</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="animation-effects" class="rounded text-primary focus:ring-primary h-4 w-4" checked>
                                    <label for="animation-effects" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Show animation effects</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save/Load Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Save/Load Game</h3>
                            <div class="space-y-3">
                                <div>
                                    <button id="save-game" class="bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Save Game Manually
                                    </button>
                                    <span id="last-saved" class="ml-2 text-xs text-gray-500 dark:text-gray-400">Last saved: Never</span>
                                </div>
                                <div>
                                    <button id="export-save" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Export Save Data
                                    </button>
                                    <button id="copy-save" class="ml-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Copy to Clipboard
                                    </button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import Save Data</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="import-save-data" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Paste save data here">
                                        <button id="import-save" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                            Import
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prestige Section -->
                        <div id="prestige-settings-section">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Prestige</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">You can ascend to gain Enlightenment Points. This will reset your progress but unlock permanent bonuses.</p>
                            <button id="prestige-button" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Ascend for Enlightenment Points
                            </button>
                        </div>
                        
                        <!-- Reset Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Reset Game</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">This will reset all progress. Make sure to export your save first!</p>
                            <button id="reset-game" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Reset All Progress
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- About & Support -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">About & Support</h2>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">About Stellar Bibliophile 2.0</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Stellar Bibliophile 2.0 is a procedurally generated reading tracker with grand strategy elements. Track your reading progress, earn resources, discover unique facilities, research technologies, and ascend for permanent bonuses.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Game Features</h3>
                        <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-400 space-y-1">
                            <li>Procedurally generated facilities, research, and galactic objects</li>
                            <li>Endless upgrades with incrementing costs</li>
                            <li>Prestige system with permanent bonuses</li>
                            <li>Collectible relics that persist across resets</li>
                            <li>Offline progression and local save system</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-xs text-gray-500 dark:text-gray-500 py-4">
            <p>Stellar Bibliophile v2.0.0 | Science Fiction-inspired Reading Tracker</p>
            <p class="mt-1">Track your reading journey with procedurally generated strategy elements</p>
        </footer>
        
        <!-- Notification Container -->
        <div id="notification-container" class="notification-container"></div>
        
        <!-- Save Data Export Modal -->
        <div id="save-export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 modal-enter">
                <h3 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Export Game Save</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Copy the text below to save your game progress. You can import this later to restore your game.
                </p>
                <textarea id="export-save-text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-xs font-mono" rows="5" readonly></textarea>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="copy-save-modal" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Copy to Clipboard
                    </button>
                    <button id="close-export-modal" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ascension Confirmation Modal -->
        <div id="ascension-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 modal-enter">
                <h3 class="text-xl font-bold text-enlightenment mb-4">Confirm Ascension</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    You are about to ascend and reset your progress. You will gain <span id="confirm-ep-gain" class="font-bold text-enlightenment">0</span> Enlightenment Points.
                </p>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    The following will be RESET:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-4">
                    <li>Player level and most resources (except Quantum Fragments)</li>
                    <li>Most facilities (except those retained via upgrades)</li>
                    <li>Research projects (except those retained)</li>
                    <li>Current books and reading progress</li>
                    <li>Galaxy exploration progress (except discovered relics)</li>
                </ul>
                <p class="text-gray-600 dark:text-gray-400 mb-6">
                    The following will be KEPT:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-6">
                    <li>All discovered Relics and their bonuses</li>
                    <li>Enlightenment Points and all permanent upgrades</li>
                    <li>75% of your Quantum Fragments</li>
                    <li>Lifetime statistics and achievements</li>
                    <li>Prestige level and unlocked features</li>
                </ul>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-ascension" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirm-ascension" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Ascend
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Discovery Modal -->
        <div id="discovery-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center modal-enter">
                <div class="text-4xl mb-2">âœ¨</div>
                <h3 class="text-xl font-bold text-galaxy mb-3">New Star System Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="discovered-system-name">System Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="discovered-system-description">
                    System description will appear here.
                </p>
                <div class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <div>
                        <span class="font-medium">Type:</span>
                        <span id="discovered-system-type">Unknown</span>
                    </div>
                    <div>
                        <span class="font-medium">Planets:</span>
                        <span id="discovered-system-planets">0</span>
                    </div>
                    <div>
                        <span class="font-medium">Rarity:</span>
                        <span id="discovered-system-rarity">Common</span>
                    </div>
                </div>
                <button id="close-discovery-modal" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Explore System
                </button>
            </div>
        </div>
        
        <!-- New Facility Modal -->
        <div id="new-facility-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center modal-enter">
                <div class="text-4xl mb-2">ðŸ—ï¸</div>
                <h3 class="text-xl font-bold text-primary mb-3">New Facility Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="new-facility-name">Facility Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="new-facility-description">
                    Facility description will appear here.
                </p>
                <div class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <div>
                        <span class="font-medium">Type:</span>
                        <span id="new-facility-type">Unknown</span>
                    </div>
                    <div>
                        <span class="font-medium">Rarity:</span>
                        <span id="new-facility-rarity">Common</span>
                    </div>
                </div>
                <div class="space-y-2 mb-6">
                    <h5 class="font-medium text-gray-800 dark:text-gray-200">Effects:</h5>
                    <div id="new-facility-effects" class="text-sm text-gray-600 dark:text-gray-400">
                        Effects will be listed here
                    </div>
                </div>
                <button id="close-facility-modal" class="bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Add to Available Facilities
                </button>
            </div>
        </div>
        
        <!-- New Research Modal -->
        <div id="new-research-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center modal-enter">
                <div class="text-4xl mb-2">ðŸ”¬</div>
                <h3 class="text-xl font-bold text-cosmic mb-3">New Research Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="new-research-name">Research Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="new-research-description">
                    Research description will appear here.
                </p>
                <div class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <div>
                        <span class="font-medium">Type:</span>
                        <span id="new-research-type">Unknown</span>
                    </div>
                    <div>
                        <span class="font-medium">Rarity:</span>
                        <span id="new-research-rarity">Common</span>
                    </div>
                    <div>
                        <span class="font-medium">Cost:</span>
                        <span id="new-research-cost">0</span> RP
                    </div>
                </div>
                <div class="space-y-2 mb-6">
                    <h5 class="font-medium text-gray-800 dark:text-gray-200">Benefits:</h5>
                    <div id="new-research-effects" class="text-sm text-gray-600 dark:text-gray-400">
                        Benefits will be listed here
                    </div>
                </div>
                <button id="close-research-modal" class="bg-cosmic hover:bg-purple-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Add to Research Options
                </button>
            </div>
        </div>
        
        <!-- New Relic Modal -->
        <div id="new-relic-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center modal-enter">
                <div class="text-4xl mb-2">ðŸº</div>
                <h3 class="text-xl font-bold text-enlightenment mb-3">Ancient Relic Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="new-relic-name">Relic Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="new-relic-description">
                    Relic description will appear here.
                </p>
                <div class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <div>
                        <span class="font-medium">Collection:</span>
                        <span id="new-relic-collection">Unknown</span>
                    </div>
                    <div>
                        <span class="font-medium">Rarity:</span>
                        <span id="new-relic-rarity">Common</span>
                    </div>
                </div>
                <div class="space-y-2 mb-6">
                    <h5 class="font-medium text-gray-800 dark:text-gray-200">Permanent Effects:</h5>
                    <div id="new-relic-effects" class="text-sm text-gray-600 dark:text-gray-400">
                        Effects will be listed here
                    </div>
                </div>
                <button id="close-relic-modal" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Add to Collection
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // GAME INITIALIZATION & CONFIGURATION
        // ==========================================
        
        // Game version
        const GAME_VERSION = "2.0.0";
        
        // Game state
        const gameState = {
            version: GAME_VERSION,
            lastSaved: null,
            lastPlayed: Date.now(),
            settings: {
                autoSave: true,
                showNotifications: true,
                offlineProgress: true,
                animationEffects: true
            },
            player: {
                level: 1,
                experiencePoints: 0,
                experienceToNextLevel: 100
            },
            resources: {
                knowledgePoints: 50,
                researchPoints: 0,
                influence: 0,
                quantumFragments: 0
            },
            facilities: {
                available: [], // List of discovered but not yet built facilities
                built: [], // List of built facilities
                discoveryCount: 0,
                nextDiscoveryCost: { kp: 100, rp: 20 },
                costMultiplier: 1.2 // Cost increases by 20% for each new discovery
            },
            research: {
                available: [], // List of discovered but not yet researched projects
                completed: [], // List of completed research projects
                discoveryCount: 0,
                nextDiscoveryCost: 75,
                costMultiplier: 1.25 // Cost increases by 25% for each new discovery
            },
            stats: {
                booksCompleted: 0,
                pagesRead: 0,
                minutesRead: 0,
                totalKpGenerated: 0,
                facilitiesBuilt: 0,
                researchCompleted: 0,
                systemsDiscovered: 0,
                relicsFound: 0,
                genreDistribution: {
                    'sci-fi': 0,
                    'fantasy': 0,
                    'non-fiction': 0,
                    'mystery': 0,
                    'history': 0,
                    'science': 0,
                    'biography': 0,
                    'philosophy': 0,
                    'poetry': 0,
                    'comic': 0,
                    'custom': {}
                }
            },
            currentBooks: [],
            // Galaxy exploration system data
            galaxy: {
                unlocked: false,
                discoveredSystems: {},
                currentCoordinates: { x: 0, y: 0 },
                viewCenter: { x: 0, y: 0 },
                explorationRange: 3,
                zoomLevel: 1,
                nextSystemCost: 25,
                systemCosts: {
                    base: 25,
                    distanceMultiplier: 1.2
                },
                activePlanets: [],
                activeExpedition: null,
                stats: {
                    systemsDiscovered: 0,
                    outpostsEstablished: 0,
                    planetsColonized: 0,
                    expeditionsCompleted: 0,
                    rarePlanetsFound: 0
                }
            },
            // Relics system
            relics: {
                discovered: [], // List of discovered relics
                collections: {
                    "Scholar's Artifacts": { 
                        total: 4, 
                        discovered: 0, 
                        bonus: "Increases Knowledge Points gained by 25%"
                    },
                    "Cosmic Archives": { 
                        total: 5, 
                        discovered: 0, 
                        bonus: "Increases Research Points generation by 30%"
                    },
                    "Astral Fragments": { 
                        total: 3, 
                        discovered: 0, 
                        bonus: "Increases Influence gained by 20%"
                    },
                    "Temporal Paradoxes": { 
                        total: 4, 
                        discovered: 0, 
                        bonus: "Increases Quantum Fragment acquisition by 40%"
                    },
                    "Lost Library": { 
                        total: 5, 
                        discovered: 0, 
                        bonus: "Gain 2 Knowledge Points per second passively"
                    },
                    "Interdimensional Tomes": { 
                        total: 3, 
                        discovered: 0, 
                        bonus: "Retain an additional facility after ascension"
                    }
                }
            },
            // New prestige-related properties
            prestige: {
                unlocked: true, // Start with prestige unlocked for easier testing
                level: 0,
                enlightenmentPoints: 0,
                totalEnlightenmentEarned: 0,
                // Permanent upgrades that persist across prestige resets
                permanentUpgrades: [
                    {
                        id: "resource_production",
                        name: "Resource Production",
                        description: "Permanently increases all resource production rates.",
                        level: 0,
                        maxLevel: Infinity,
                        baseCost: 5,
                        costMultiplier: 1.5,
                        effect: {
                            type: "production_multiplier",
                            value: 10, // Each level gives +10% production
                            diminishingReturns: {
                                threshold: 10,
                                factor: 0.5 // After level 10, each level adds only 5%
                            }
                        }
                    },
                    {
                        id: "starting_resources",
                        name: "Starting Resources",
                        description: "Begin each prestige run with more resources.",
                        level: 0,
                        maxLevel: Infinity,
                        baseCost: 5,
                        costMultiplier: 1.4,
                        effect: {
                            type: "starting_resources",
                            kp: 25, // Each level gives +25 starting KP
                            rp: 10, // Each level gives +10 starting RP
                            diminishingReturns: {
                                threshold: 10,
                                factor: 0.75 // After level 10, each level adds 75% of the normal amount
                            }
                        }
                    },
                    {
                        id: "reading_efficiency",
                        name: "Reading Efficiency",
                        description: "Permanently increases knowledge gained from reading.",
                        level: 0,
                        maxLevel: Infinity,
                        baseCost: 10,
                        costMultiplier: 1.4,
                        effect: {
                            type: "reading_efficiency",
                            value: 15, // Each level gives +15% reading efficiency
                            diminishingReturns: {
                                threshold: 8,
                                factor: 0.7 // After level 8, each level adds 70% of the normal amount
                            }
                        }
                    },
                    {
                        id: "xp_boost",
                        name: "Experience Boost",
                        description: "Permanently increases experience gained from all sources.",
                        level: 0,
                        maxLevel: Infinity,
                        baseCost: 8,
                        costMultiplier: 1.5,
                        effect: {
                            type: "xp_boost",
                            value: 12, // Each level gives +12% XP
                            diminishingReturns: {
                                threshold: 10,
                                factor: 0.6 // After level 10, each level adds 60% of the normal amount
                            }
                        }
                    },
                    {
                        id: "auto_research",
                        name: "Auto Research",
                        description: "Automatically research basic technologies after prestige.",
                        level: 0,
                        maxLevel: 10,
                        baseCost: 15,
                        costMultiplier: 1.6,
                        effect: {
                            type: "auto_research",
                            value: 1 // Each level gives 1 automatic research
                        }
                    },
                    {
                        id: "facility_retention",
                        name: "Facility Retention",
                        description: "Retain facilities after prestige.",
                        level: 0,
                        maxLevel: 10,
                        baseCost: 20,
                        costMultiplier: 1.8,
                        effect: {
                            type: "facility_retention",
                            value: 1 // Each level lets you keep 1 facility
                        }
                    },
                    {
                        id: "quantum_efficiency",
                        name: "Quantum Efficiency",
                        description: "Retain more Quantum Fragments after prestige.",
                        level: 0,
                        maxLevel: 5,
                        baseCost: 12,
                        costMultiplier: 2.0,
                        effect: {
                            type: "quantum_retention",
                            value: 5 // Each level gives +5% retention (on top of base 75%)
                        }
                    },
                    {
                        id: "enlightened_reading",
                        name: "Enlightened Reading",
                        description: "Gain Quantum Fragments while reading.",
                        level: 0,
                        maxLevel: Infinity,
                        baseCost: 18,
                        costMultiplier: 1.7,
                        effect: {
                            type: "reading_quantum",
                            value: 0.1, // Each level gives 0.1 QF per minute of reading
                            diminishingReturns: {
                                threshold: 5,
                                factor: 0.8 // After level 5, each level adds 80% of the normal amount
                            }
                        }
                    }
                ]
            },
            // Lifetime stats that persist across prestiges
            lifetimeStats: {
                totalPrestiges: 0,
                maxLevel: 1,
                maxBooks: 0,
                totalEnlightenmentPoints: 0
            }
        };
        
        // Game constants and configuration
        const gameConfig = {
            // Resource generation
            baseKpPerPage: 1,
            baseKpPerMinute: 0.5,
            difficultyMultipliers: {
                'easy': 1.0,
                'medium': 1.5,
                'hard': 2.0,
                'expert': 3.0,
                'legendary': 5.0
            },
            completionBonus: 0.2, // 20% bonus for completing a book
            resourceInterval: 30000, // Generate resources every 30 seconds
            
            // Procedural generation parameters
            facilityTypes: [
                "observatory", "repository", "archive", "nexus", "library", "academy", 
                "laboratory", "sanctuary", "memorial", "beacon", "codex", "citadel"
            ],
            facilityAdjectives: [
                "quantum", "celestial", "temporal", "ethereal", "cosmic", "astral", 
                "neural", "prismatic", "harmonic", "dimensional", "spectral", "arcane"
            ],
            facilityNouns: [
                "matrix", "array", "singularity", "confluence", "archive", "projection", 
                "resonance", "paradigm", "lattice", "continuum", "catalyst", "manifold"
            ],
            researchTypes: [
                "cognitive", "theoretical", "applied", "experimental", "analytical", "quantum", 
                "temporal", "neural", "cosmic", "dimensional", "fundamental", "practical"
            ],
            researchFields: [
                "physics", "metaphysics", "computation", "cognition", "perception", "linguistics", 
                "chronology", "harmonics", "dynamics", "resonance", "topology", "synthesis"
            ],
            effectTypes: [
                { type: "kp_per_page", name: "Knowledge per Page", desc: "+{value}% Knowledge Points per page read", max: 25, isPercentage: true },
                { type: "kp_per_minute", name: "Knowledge per Minute", desc: "+{value}% Knowledge Points per minute read", max: 25, isPercentage: true },
                { type: "rp_generation", name: "Research Generation", desc: "+{value}% Research Point generation", max: 30, isPercentage: true },
                { type: "inf_gain", name: "Influence Gain", desc: "+{value}% Influence gained from books", max: 30, isPercentage: true },
                { type: "xp_gain", name: "Experience Gain", desc: "+{value}% Experience Points from all sources", max: 20, isPercentage: true },
                { type: "qf_gain", name: "Quantum Fragment Gain", desc: "+{value}% Quantum Fragment acquisition", max: 25, isPercentage: true },
                { type: "completion_bonus", name: "Completion Bonus", desc: "+{value}% bonus when completing books", max: 40, isPercentage: true },
                { type: "offline_progress", name: "Offline Progress", desc: "+{value}% resources while offline", max: 50, isPercentage: true },
                { type: "passive_kp", name: "Passive Knowledge", desc: "Generate {value} Knowledge Points per minute", max: 5, isPercentage: false },
                { type: "passive_rp", name: "Passive Research", desc: "Generate {value} Research Points per minute", max: 3, isPercentage: false },
                { type: "passive_inf", name: "Passive Influence", desc: "Generate {value} Influence per minute", max: 2, isPercentage: false },
                { type: "passive_qf", name: "Passive Quantum", desc: "Generate {value} Quantum Fragments per minute", max: 1, isPercentage: false },
                { type: "facility_cost", name: "Facility Cost Reduction", desc: "-{value}% facility build costs", max: 30, isPercentage: true },
                { type: "research_cost", name: "Research Cost Reduction", desc: "-{value}% research costs", max: 30, isPercentage: true },
                { type: "genre_bonus", name: "Genre Specialization", desc: "+{value}% bonus for a random genre", max: 50, isPercentage: true },
                { type: "exploration_range", name: "Exploration Range", desc: "+{value} to galactic exploration range", max: 3, isPercentage: false },
                { type: "system_cost", name: "System Cost Reduction", desc: "-{value}% cost for exploring new systems", max: 35, isPercentage: true },
                { type: "relic_chance", name: "Relic Discovery", desc: "+{value}% chance to find relics", max: 25, isPercentage: true }
            ],
            rarities: [
                { name: "common", weight: 50, color: "gray", multiplier: 1.0, minEffects: 1, maxEffects: 1 },
                { name: "uncommon", weight: 30, color: "green", multiplier: 1.5, minEffects: 1, maxEffects: 2 },
                { name: "rare", weight: 15, color: "blue", multiplier: 2.0, minEffects: 2, maxEffects: 2 },
                { name: "epic", weight: 4, color: "purple", multiplier: 3.0, minEffects: 2, maxEffects: 3 },
                { name: "legendary", weight: 1, color: "orange", multiplier: 5.0, minEffects: 3, maxEffects: 3 }
            ],
            
            // Galaxy exploration settings
            galaxy: {
                systemColors: {
                    fiction: "#FFD700", // Yellow - Fiction literature
                    academic: "#FFFFFF", // White - Academic literature
                    historical: "#60A5FA", // Blue - Historical literature
                    experimental: "#F87171", // Red - Experimental literature
                    metaphysical: "#34D399" // Green - Metaphysical fiction
                },
                rarityColors: {
                    common: "#FFFFFF",
                    uncommon: "#34D399",
                    rare: "#60A5FA",
                    epic: "#805AD5",
                    legendary: "#F87171"
                },
                starSizesByRarity: {
                    common: 4,
                    uncommon: 6,
                    rare: 8,
                    epic: 10,
                    legendary: 12
                },
                systemTypes: [
                    "fiction", "academic", "historical", "experimental", "metaphysical"
                ],
                systemRarities: [
                    { rarity: "common", weight: 60 },
                    { rarity: "uncommon", weight: 25 },
                    { rarity: "rare", weight: 10 },
                    { rarity: "epic", weight: 4 },
                    { rarity: "legendary", weight: 1 }
                ]
            },
            
            // Relic System
            relics: {
                relicRarities: [
                    { name: "common", weight: 45, color: "gray-400", minEffects: 1, maxEffects: 1, cssClass: "relic-common" },
                    { name: "uncommon", weight: 30, color: "green-400", minEffects: 1, maxEffects: 2, cssClass: "relic-uncommon" },
                    { name: "rare", weight: 15, color: "blue-400", minEffects: 2, maxEffects: 2, cssClass: "relic-rare" },
                    { name: "epic", weight: 8, color: "purple-400", minEffects: 2, maxEffects: 3, cssClass: "relic-epic" },
                    { name: "legendary", weight: 2, color: "red-400", minEffects: 3, maxEffects: 3, cssClass: "relic-legendary" }
                ],
                relicCollections: [
                    "Scholar's Artifacts",
                    "Cosmic Archives",
                    "Astral Fragments",
                    "Temporal Paradoxes",
                    "Lost Library",
                    "Interdimensional Tomes"
                ],
                relicNamePrefixes: [
                    "Ancient", "Arcane", "Celestial", "Cosmic", "Crystalline", "Dimensional", 
                    "Eldritch", "Ephemeral", "Ethereal", "Forgotten", "Harmonic", "Impossibly", 
                    "Infinite", "Luminous", "Mythical", "Oracular", "Prismatic", "Quantum", 
                    "Resonant", "Spectral", "Temporal", "Timeless", "Uncanny", "Void-Touched"
                ],
                relicNameObjects: [
                    "Amulet", "Bookmark", "Codex", "Compass", "Cube", "Crystal", "Device",
                    "Dial", "Echo", "Fragment", "Gem", "Glyph", "Hourglass", "Key", "Lens", 
                    "Map", "Mirror", "Monolith", "Orb", "Page", "Pendant", "Prism",
                    "Ring", "Rune", "Sextant", "Shard", "Sigil", "Singularity", "Sphere", 
                    "Tablet", "Tome", "Veil"
                ],
                relicNameSuffixes: [
                    "of Ages", "of Awakening", "of Binding", "of Clarity", "of Cosmos", 
                    "of Dimensions", "of Echoes", "of Enlightenment", "of Eternity", 
                    "of Illumination", "of Infinite Pages", "of Knowledge", "of Lost Words", 
                    "of Memory", "of Paradox", "of Possibility", "of Reflection", "of Resonance", 
                    "of Secrets", "of the Void", "of Thought", "of Time", "of Transcendence",
                    "of Truth", "of Understanding", "of Unmaking", "of Whispers", "of Wisdom"
                ],
                relicEffects: [
                    { type: "kp_boost", desc: "+{value}% Knowledge Points from all sources", max: 15 },
                    { type: "rp_boost", desc: "+{value}% Research Points from all sources", max: 15 },
                    { type: "inf_boost", desc: "+{value}% Influence from all sources", max: 15 },
                    { type: "qf_boost", desc: "+{value}% Quantum Fragments from all sources", max: 15 },
                    { type: "xp_boost", desc: "+{value}% Experience gain", max: 10 },
                    { type: "reading_speed", desc: "+{value}% effective reading speed", max: 20 },
                    { type: "passive_kp", desc: "Generate {value} Knowledge Points per minute", max: 3 },
                    { type: "passive_rp", desc: "Generate {value} Research Points per minute", max: 2 },
                    { type: "passive_inf", desc: "Generate {value} Influence per minute", max: 1 },
                    { type: "passive_qf", desc: "Generate {value} Quantum Fragments per minute", max: 0.5 },
                    { type: "offline_multiplier", desc: "+{value}% resources while offline", max: 25 },
                    { type: "facility_discount", desc: "-{value}% facility costs", max: 15 },
                    { type: "research_discount", desc: "-{value}% research costs", max: 15 },
                    { type: "galaxy_range", desc: "+{value} to exploration range", max: 2 },
                    { type: "discovery_chance", desc: "+{value}% chance to discover rare systems", max: 20 },
                    { type: "starting_kp", desc: "+{value} starting Knowledge Points after prestige", max: 100 },
                    { type: "starting_rp", desc: "+{value} starting Research Points after prestige", max: 50 },
                    { type: "starting_inf", desc: "+{value} starting Influence after prestige", max: 25 },
                    { type: "starting_qf", desc: "+{value} starting Quantum Fragments after prestige", max: 10 },
                    { type: "upgrade_discount", desc: "-{value}% Enlightenment upgrade costs", max: 10 },
                    { type: "ep_bonus", desc: "+{value}% Enlightenment Points from prestige", max: 15 },
                    { type: "relic_chance", desc: "+{value}% chance to find relics", max: 15 }
                ]
            },
            
            // Prestige settings
            prestigeRequirements: {
                playerLevel: 10,
                booksCompleted: 8 // Reduced from 25
            },
            // EP calculation factors
            epCalculation: {
                levelFactor: 0.5,     // Each level gives 0.5 EP
                bookFactor: 0.2,      // Each book gives 0.2 EP
                researchFactor: 1.0,   // Each research gives 1.0 EP
                facilityFactor: 0.5    // Each facility level gives 0.5 EP
            },
            
            // Genre colors for UI
            genreColors: [
                'blue-600',
                'purple-600',
                'green-600',
                'yellow-600',
                'red-600',
                'pink-600',
                'indigo-600',
                'teal-600',
                'orange-600'
            ],
            
            // Auto-save interval (in ms)
            autoSaveInterval: 60000
        };
        
        // Check for dark mode preference
        function checkDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        }
        
        checkDarkMode();
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // ==========================================
        // GAME SYSTEM FUNCTIONS
        // ==========================================
        
        // Generate a random name for facilities
        function generateFacilityName() {
            const adjective = getRandomElement(gameConfig.facilityAdjectives);
            const type = getRandomElement(gameConfig.facilityTypes);
            const capitalize = str => str.charAt(0).toUpperCase() + str.slice(1);
            return `${capitalize(adjective)} ${capitalize(type)}`;
        }
        
        // Generate a random description for facilities
        function generateFacilityDescription(type, rarity) {
            const descriptions = {
                observatory: [
                    "Observes cosmic phenomena and translates them into literary knowledge.",
                    "Maps the relationship between stellar bodies and narrative structures.",
                    "Scans the universe for literary parallels and symbolic resonances."
                ],
                repository: [
                    "Stores and categorizes accumulated knowledge for efficient retrieval.",
                    "Preserves literary insights in a dimensionally-compressed format.",
                    "Houses a collection of thought-crystals containing distilled wisdom."
                ],
                archive: [
                    "Archives literary phenomena across multiple realities and dimensions.",
                    "Preserves literary works from both existing and theoretical timelines.",
                    "Catalogs narratives across the full spectrum of possible universes."
                ],
                nexus: [
                    "Forms connections between disparate literary concepts and traditions.",
                    "Creates a convergence point for intellectual currents from various sources.",
                    "Establishes a network of narrative threads spanning countless worlds."
                ],
                library: [
                    "Contains books that exist beyond conventional space and time.",
                    "Houses volumes that rewrite themselves based on the reader's thoughts.",
                    "Stores knowledge in a non-linear format accessible through intuition."
                ],
                academy: [
                    "Trains specialists in the art of extracting meaning from complex texts.",
                    "Educates researchers in advanced theoretical narrative structures.",
                    "Prepares scholars to navigate the deepest layers of literary reality."
                ],
                laboratory: [
                    "Experiments with the fundamental particles of literary creation.",
                    "Tests hypotheses about the underlying structure of narrative reality.",
                    "Conducts research into the quantum mechanics of storytelling."
                ],
                sanctuary: [
                    "Provides a perfect environment for deep literary contemplation.",
                    "Creates a protected space where reading transcends ordinary limitations.",
                    "Establishes a haven where mind and text can achieve perfect resonance."
                ],
                memorial: [
                    "Preserves the essence of forgotten texts and lost literary traditions.",
                    "Maintains echoes of narratives that might otherwise fade from existence.",
                    "Commemorates the infinite stories that shape our understanding of reality."
                ],
                beacon: [
                    "Broadcasts literary insights across vast intellectual distances.",
                    "Transmits understanding to other readers throughout the cosmos.",
                    "Projects a guiding light for those navigating complex textual labyrinths."
                ],
                codex: [
                    "Encodes literary knowledge in a format transcending ordinary language.",
                    "Translates narrative patterns into universal archetypes and constants.",
                    "Compresses vast libraries of wisdom into singular, dense configurations."
                ],
                citadel: [
                    "Fortifies literary insights against the erosion of time and forgetting.",
                    "Establishes an unassailable foundation for intellectual expansion.",
                    "Creates a stronghold where knowledge can be defended and preserved."
                ]
            };
            
            // Get descriptions for this type, or use generic ones if type not found
            const typeDescriptions = descriptions[type] || [
                "Processes literary information through advanced cognitive algorithms.",
                "Transforms reading experiences into quantifiable knowledge resources.",
                "Enhances your understanding of textual patterns and narrative structures."
            ];
            
            // Get a random description based on the facility type
            let baseDescription = getRandomElement(typeDescriptions);
            
            // Add rarity-specific enhancement to the description
            const rarityEnhancements = {
                common: "It provides basic functionality for your reading endeavors.",
                uncommon: "This improved model offers enhanced efficiency and capabilities.",
                rare: "A sophisticated installation with advanced features and optimization.",
                epic: "This extraordinary facility operates at levels beyond conventional understanding.",
                legendary: "A truly remarkable achievement of literary-technological integration that defies traditional limits."
            };
            
            return `${baseDescription} ${rarityEnhancements[rarity] || ""}`;
        }
        
        // Generate a random research name
        function generateResearchName() {
            const type = getRandomElement(gameConfig.researchTypes);
            const field = getRandomElement(gameConfig.researchFields);
            const capitalize = str => str.charAt(0).toUpperCase() + str.slice(1);
            return `${capitalize(type)} ${capitalize(field)}`;
        }
        
        // Generate a random research description
        function generateResearchDescription(type, field, rarity) {
            const typeDescriptions = {
                cognitive: [
                    "Explores how the mind processes and assimilates literary information.",
                    "Analyzes the neurological pathways activated during reading.",
                    "Maps the cognitive architecture that supports text comprehension."
                ],
                theoretical: [
                    "Develops abstract models for understanding narrative structures.",
                    "Proposes new frameworks for conceptualizing literary experience.",
                    "Establishes foundational principles for literary-cognitive integration."
                ],
                applied: [
                    "Implements practical methods to enhance reading efficiency.",
                    "Develops techniques for optimizing knowledge extraction from texts.",
                    "Creates systems for applying literary insights to resource generation."
                ],
                experimental: [
                    "Tests novel approaches to literary-cognitive enhancement.",
                    "Conducts controlled studies on reading method optimization.",
                    "Explores unproven but promising techniques for knowledge acquisition."
                ],
                analytical: [
                    "Breaks down complex texts into their constituent components.",
                    "Examines the fundamental structures underlying literary works.",
                    "Deconstructs narrative patterns to identify optimizable elements."
                ],
                quantum: [
                    "Investigates reading as a phenomenon existing in multiple states simultaneously.",
                    "Explores the probabilistic nature of textual interpretation.",
                    "Applies quantum principles to literary information processing."
                ],
                temporal: [
                    "Studies how reading experiences unfold across time.",
                    "Analyzes the chronological aspects of narrative comprehension.",
                    "Explores methods for manipulating the temporal dimension of reading."
                ],
                neural: [
                    "Maps and optimizes the brain's literary processing networks.",
                    "Develops methods for enhancing neural pathways involved in reading.",
                    "Creates interfaces between textual input and cognitive architecture."
                ],
                cosmic: [
                    "Explores the relationship between universal structures and narrative patterns.",
                    "Studies reading as a phenomenon connected to cosmic organization.",
                    "Investigates texts as manifestations of transcendent ordering principles."
                ],
                dimensional: [
                    "Examines texts as gateways to alternative cognitive spaces.",
                    "Explores reading as navigation through multiple layers of reality.",
                    "Maps the dimensional topography of narrative experience."
                ],
                fundamental: [
                    "Investigates the basic building blocks of literary comprehension.",
                    "Studies the irreducible elements of text-mind interaction.",
                    "Establishes core principles governing knowledge extraction."
                ],
                practical: [
                    "Focuses on immediately applicable reading enhancement techniques.",
                    "Develops straightforward methods for improving resource generation.",
                    "Creates accessible systems for optimizing literary productivity."
                ]
            };
            
            const fieldDescriptions = {
                physics: "the fundamental forces governing literary information",
                metaphysics: "the transcendent aspects of reading experiences",
                computation: "algorithmic processing of textual information",
                cognition: "mental structures involved in literary comprehension",
                perception: "sensory and extrasensory reception of narrative information",
                linguistics: "language structures as conduits for knowledge",
                chronology: "temporal aspects of reading and comprehension",
                harmonics: "resonance patterns between texts and consciousness",
                dynamics: "interactive forces between reader and narrative",
                resonance: "sympathetic vibrations between mind and text",
                topology: "spatial relationships within literary structures",
                synthesis: "integration of disparate textual elements"
            };
            
            // Get description elements
            const typeDescription = getRandomElement(typeDescriptions[type] || ["Explores advanced reading methodologies."]);
            const fieldElement = fieldDescriptions[field] || "various aspects of reading optimization";
            
            // Add rarity-specific enhancement
            const rarityEnhancements = {
                common: "This research provides basic improvements to your reading framework.",
                uncommon: "A notable advancement in literary science with solid practical applications.",
                rare: "This sophisticated research represents a significant breakthrough.",
                epic: "A revolutionary development that fundamentally transforms your approach to reading.",
                legendary: "This paradigm-shifting research transcends conventional understanding of literary cognition."
            };
            
            return `${typeDescription} Focuses on ${fieldElement}. ${rarityEnhancements[rarity] || ""}`;
        }
        
        // Generate a random relic name
        function generateRelicName() {
            const prefix = getRandomElement(gameConfig.relics.relicNamePrefixes);
            const object = getRandomElement(gameConfig.relics.relicNameObjects);
            const suffix = Math.random() > 0.3 ? getRandomElement(gameConfig.relics.relicNameSuffixes) : "";
            
            return suffix ? `${prefix} ${object} ${suffix}` : `${prefix} ${object}`;
        }
        
        // Generate a random relic description
        function generateRelicDescription(rarity, collection) {
            const ageDescriptions = [
                "Dating back to the dawn of cosmic literature",
                "Created in an era before conventional language",
                "Formed during the primordial age of narrative",
                "Discovered in the ruins of an interdimensional library",
                "Recovered from a pocket dimension of pure text",
                "Salvaged from the wreckage of a thought-ship",
                "Extracted from crystallized memory structures",
                "Unearthed from the foundations of the first university",
                "Retrieved from the void between narrative universes",
                "Manifested during a momentary alignment of literary planes"
            ];
            
            const powerDescriptions = {
                common: [
                    "it retains a modest reservoir of literary energy",
                    "it emanates a subtle aura of conceptual resonance",
                    "it occasionally hums with cognitive potential",
                    "it retains a connection to the tapestry of stories"
                ],
                uncommon: [
                    "it pulses with the rhythm of forgotten narratives",
                    "it shimmers with the light of condensed knowledge",
                    "it vibrates in harmony with certain profound texts",
                    "it resonates with echoes of literary enlightenment"
                ],
                rare: [
                    "it channels currents of pure conceptual energy",
                    "it bends the local rules of cognitive physics",
                    "it creates a field of accelerated understanding",
                    "it emits harmonics that enhance mental processes"
                ],
                epic: [
                    "it warps the very fabric of literary comprehension",
                    "it creates a localized zone of transcendent cognition",
                    "it periodically phases between multiple states of literary existence",
                    "it generates waves of insight that ripple through conscious and unconscious mind"
                ],
                legendary: [
                    "it represents a nexus point where all possible narratives converge",
                    "it exists simultaneously in multiple cognitive dimensions",
                    "it rewrites the fundamental relationship between reader and text",
                    "it contains within it the essence of stories that have yet to be told"
                ]
            };
            
            const collectionDescriptions = {
                "Scholar's Artifacts": "Part of the legendary Scholar's Artifacts collection, said to have belonged to the first readers who discovered the power of narrative.",
                "Cosmic Archives": "One of the scattered pieces from the Cosmic Archives, a repository of knowledge that existed before time itself.",
                "Astral Fragments": "A shard of the Astral Fragments collection, remnants of a celestial library that orbited the edges of reality.",
                "Temporal Paradoxes": "An element of the Temporal Paradoxes set, objects that simultaneously exist at all points in literary history.",
                "Lost Library": "A recovered item from the Lost Library collection, salvaged from a repository that vanished between dimensions.",
                "Interdimensional Tomes": "An artifact from the Interdimensional Tomes collection, objects that bridge the gap between reality and fiction."
            };
            
            // Get random descriptions
            const ageDesc = getRandomElement(ageDescriptions);
            const powerDesc = getRandomElement(powerDescriptions[rarity] || powerDescriptions.common);
            const collectionDesc = collectionDescriptions[collection] || "Part of an ancient collection of literary artifacts with mysterious properties.";
            
            return `${ageDesc}, ${powerDesc}. ${collectionDesc}`;
        }
        
        // Generate random effects based on type and rarity
        function generateEffects(type, rarity, isRelic = false) {
            // Determine effect pool
            const effectPool = isRelic ? gameConfig.relics.relicEffects : gameConfig.effectTypes;
            
            // Determine how many effects to generate
            const rarityData = isRelic ? 
                gameConfig.relics.relicRarities.find(r => r.name === rarity) : 
                gameConfig.rarities.find(r => r.name === rarity);
            
            if (!rarityData) return [];
            
            const minEffects = rarityData.minEffects;
            const maxEffects = rarityData.maxEffects;
            const numEffects = Math.floor(Math.random() * (maxEffects - minEffects + 1)) + minEffects;
            
            // Copy the effect pool to avoid modifying the original
            const availableEffects = [...effectPool];
            const effects = [];
            
            // Generate the effects
            for (let i = 0; i < numEffects; i++) {
                if (availableEffects.length === 0) break;
                
                // Pick a random effect
                const effectIndex = Math.floor(Math.random() * availableEffects.length);
                const effect = availableEffects.splice(effectIndex, 1)[0];
                
                // Calculate the effect value
                let baseValue;
                if (effect.isPercentage !== undefined && effect.isPercentage) {
                    // For percentage effects, use a range from 40-100% of max
                    baseValue = Math.floor((0.4 + Math.random() * 0.6) * effect.max);
                } else {
                    // For non-percentage effects, some might be small decimal values
                    if (effect.max < 1) {
                        baseValue = Math.round((0.3 + Math.random() * 0.7) * effect.max * 10) / 10;
                    } else {
                        baseValue = Math.floor((0.3 + Math.random() * 0.7) * effect.max);
                    }
                }
                
                // Apply rarity multiplier
                const multiplier = rarityData.multiplier || 1;
                let value = Math.round(baseValue * multiplier * 10) / 10;
                
                // Add the effect to the list
                effects.push({
                    type: effect.type,
                    value: value,
                    description: effect.desc.replace('{value}', value)
                });
            }
            
            return effects;
        }
        
        // Generate a random, procedural facility
        function generateFacility() {
            // Pick a random facility type and rarity
            const type = getRandomElement(gameConfig.facilityTypes);
            const rarity = weightedRandomFromArray(gameConfig.rarities);
            
            // Generate name, description, and effects
            const name = generateFacilityName();
            const description = generateFacilityDescription(type, rarity);
            const effects = generateEffects(type, rarity);
            
            // Calculate base costs based on rarity
            const rarityData = gameConfig.rarities.find(r => r.name === rarity) || gameConfig.rarities[0];
            const baseKpCost = Math.floor(50 * rarityData.multiplier);
            const baseRpCost = Math.floor(20 * rarityData.multiplier);
            
            // Generate the facility object
            return {
                id: `facility-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                name: name,
                type: type,
                rarity: rarity,
                description: description,
                effects: effects,
                level: 0,
                maxLevel: Infinity,
                baseCost: {
                    kp: baseKpCost,
                    rp: baseRpCost
                },
                currentCost: {
                    kp: baseKpCost,
                    rp: baseRpCost
                },
                costMultiplier: 1.5,
                output: 0,
                discovered: Date.now()
            };
        }
        
        // Generate a random research project
        function generateResearch() {
            // Pick a random research type and field
            const type = getRandomElement(gameConfig.researchTypes);
            const field = getRandomElement(gameConfig.researchFields);
            const rarity = weightedRandomFromArray(gameConfig.rarities);
            
            // Generate name, description, and effects
            const name = generateResearchName();
            const description = generateResearchDescription(type, field, rarity);
            const effects = generateEffects(type, rarity);
            
            // Calculate base cost based on rarity
            const rarityData = gameConfig.rarities.find(r => r.name === rarity) || gameConfig.rarities[0];
            const baseCost = Math.floor(75 * rarityData.multiplier);
            
            // Generate the research object
            return {
                id: `research-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                name: name,
                type: type,
                field: field,
                rarity: rarity,
                description: description,
                effects: effects,
                cost: baseCost,
                discovered: Date.now(),
                completed: false,
                completionDate: null
            };
        }
        
        // Generate a random relic
        function generateRelic() {
            // Pick a random rarity using weighted algorithm
            const rarity = weightedRandomFromArray(gameConfig.relics.relicRarities);
            
            // Pick a random collection
            const collection = getRandomElement(gameConfig.relics.relicCollections);
            
            // Generate name, description, and effects
            const name = generateRelicName();
            const description = generateRelicDescription(rarity, collection);
            const effects = generateEffects("relic", rarity, true);
            
            // Generate the relic object
            return {
                id: `relic-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                name: name,
                rarity: rarity,
                collection: collection,
                description: description,
                effects: effects,
                discovered: Date.now()
            };
        }
        
        // Helper function: Choose random item from array
        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // Helper function: Get weighted random item from array of {name, weight} objects
        function weightedRandomFromArray(weightedArray) {
            // Calculate total weight
            const totalWeight = weightedArray.reduce((sum, item) => sum + item.weight, 0);
            
            // Get a random weight value
            let randomWeight = Math.random() * totalWeight;
            
            // Find the item that corresponds to the random weight
            for (const item of weightedArray) {
                randomWeight -= item.weight;
                if (randomWeight <= 0) {
                    return item.name;
                }
            }
            
            // Fallback
            return weightedArray[0].name;
        }
        
        // Calculate knowledge points for reading
        function calculateReadingKp(pages, minutes, difficulty) {
            // Base calculations
            let kpFromPages = pages * gameConfig.baseKpPerPage;
            let kpFromTime = minutes * gameConfig.baseKpPerMinute;
            
            // Apply difficulty multiplier
            let difficultyMultiplier = gameConfig.difficultyMultipliers[difficulty] || 1;
            let totalKp = (kpFromPages + kpFromTime) * difficultyMultiplier;
            
            // Apply reading efficiency permanent bonus
            if (gameState.prestige.unlocked) {
                const readingEfficiencyUpgrade = gameState.prestige.permanentUpgrades.find(u => u.id === "reading_efficiency");
                if (readingEfficiencyUpgrade && readingEfficiencyUpgrade.level > 0) {
                    let bonus = readingEfficiencyUpgrade.effect.value * readingEfficiencyUpgrade.level;
                    
                    // Apply diminishing returns if applicable
                    if (readingEfficiencyUpgrade.effect.diminishingReturns && 
                        readingEfficiencyUpgrade.level > readingEfficiencyUpgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = readingEfficiencyUpgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = readingEfficiencyUpgrade.level - normalLevels;
                        bonus = (readingEfficiencyUpgrade.effect.value * normalLevels) + 
                                (readingEfficiencyUpgrade.effect.value * diminishedLevels * 
                                 readingEfficiencyUpgrade.effect.diminishingReturns.factor);
                    }
                    
                    totalKp *= (1 + (bonus / 100));
                }
            }
            
            // Apply resource production bonus if unlocked
            if (gameState.prestige.unlocked) {
                const productionUpgrade = gameState.prestige.permanentUpgrades.find(u => u.id === "resource_production");
                if (productionUpgrade && productionUpgrade.level > 0) {
                    let bonus = productionUpgrade.effect.value * productionUpgrade.level;
                    
                    // Apply diminishing returns if applicable
                    if (productionUpgrade.effect.diminishingReturns && 
                        productionUpgrade.level > productionUpgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = productionUpgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = productionUpgrade.level - normalLevels;
                        bonus = (productionUpgrade.effect.value * normalLevels) + 
                                (productionUpgrade.effect.value * diminishedLevels * 
                                 productionUpgrade.effect.diminishingReturns.factor);
                    }
                    
                    totalKp *= (1 + (bonus / 100));
                }
            }
            
            // Apply facility effects
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        // Apply percentage-based KP effects
                        if (effect.type === 'kp_per_page') {
                            totalKp += kpFromPages * (effect.value / 100);
                        }
                        
                        if (effect.type === 'kp_per_minute') {
                            totalKp += kpFromTime * (effect.value / 100);
                        }
                    });
                }
            });
            
            // Apply research effects
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        // Apply percentage-based KP effects
                        if (effect.type === 'kp_per_page') {
                            totalKp += kpFromPages * (effect.value / 100);
                        }
                        
                        if (effect.type === 'kp_per_minute') {
                            totalKp += kpFromTime * (effect.value / 100);
                        }
                    });
                }
            });
            
            // Apply relic effects
            gameState.relics.discovered.forEach(relic => {
                if (relic.effects) {
                    relic.effects.forEach(effect => {
                        if (effect.type === 'kp_boost') {
                            totalKp *= (1 + (effect.value / 100));
                        }
                    });
                }
            });
            
            // Apply galaxy active planet bonuses
            if (gameState.galaxy.activePlanets && gameState.galaxy.activePlanets.length > 0) {
                gameState.galaxy.activePlanets.forEach(planet => {
                    if (planet.bonuses) {
                        planet.bonuses.forEach(bonus => {
                            // Apply kp_per_page bonus
                            if (bonus.type === 'kp_per_page') {
                                totalKp += kpFromPages * (bonus.value / 100);
                            }
                            
                            // Apply kp_per_minute bonus
                            if (bonus.type === 'kp_per_minute') {
                                totalKp += kpFromTime * (bonus.value / 100);
                            }
                        });
                    }
                });
            }
            
            return totalKp;
        }
        
        // Add experience points and check for level up
        function addExperience(amount) {
            // Apply permanent experience boost if unlocked
            if (gameState.prestige.unlocked) {
                const xpBoost = gameState.prestige.permanentUpgrades.find(u => u.id === "xp_boost");
                if (xpBoost && xpBoost.level > 0) {
                    let bonus = xpBoost.effect.value * xpBoost.level;
                    
                    // Apply diminishing returns if applicable
                    if (xpBoost.effect.diminishingReturns && 
                        xpBoost.level > xpBoost.effect.diminishingReturns.threshold) {
                        const normalLevels = xpBoost.effect.diminishingReturns.threshold;
                        const diminishedLevels = xpBoost.level - normalLevels;
                        bonus = (xpBoost.effect.value * normalLevels) + 
                                (xpBoost.effect.value * diminishedLevels * 
                                 xpBoost.effect.diminishingReturns.factor);
                    }
                    
                    amount *= (1 + (bonus / 100));
                }
            }
            
            // Apply facility effects
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'xp_gain') {
                            amount *= (1 + (effect.value / 100));
                        }
                    });
                }
            });
            
            // Apply research effects
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'xp_gain') {
                            amount *= (1 + (effect.value / 100));
                        }
                    });
                }
            });
            
            // Apply relic effects
            gameState.relics.discovered.forEach(relic => {
                if (relic.effects) {
                    relic.effects.forEach(effect => {
                        if (effect.type === 'xp_boost') {
                            amount *= (1 + (effect.value / 100));
                        }
                    });
                }
            });
            
            // Add the experience
            gameState.player.experiencePoints += amount;
            
            // Check for level up
            if (gameState.player.experiencePoints >= gameState.player.experienceToNextLevel) {
                gameState.player.experiencePoints -= gameState.player.experienceToNextLevel;
                gameState.player.level += 1;
                gameState.player.experienceToNextLevel = Math.floor(gameState.player.experienceToNextLevel * 1.5);
                
                showNotification(`Level up! You are now level ${gameState.player.level}`, 'success');
                
                // Check for new unlocks
                checkUnlocks();
            }
        }
        
        // Generate passive resources based on buildings, research, etc.
        function generatePassiveResources() {
            let kpGain = 0;
            let rpGain = 0.25;  // Base 0.5 RP/min (0.25 per 30s interval)
            let infGain = 0;
            let qfGain = 0;
            
            // Apply facility effects
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value / 2; // Divide by 2 as the interval is 30s
                        if (effect.type === 'passive_rp') rpGain += effect.value / 2;
                        if (effect.type === 'passive_inf') infGain += effect.value / 2;
                        if (effect.type === 'passive_qf') qfGain += effect.value / 2;
                        
                        if (effect.type === 'rp_generation' && facility.output) {
                            rpGain += (facility.output / 2) * (effect.value / 100);
                        }
                    });
                }
            });
            
            // Apply research effects
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value / 2;
                        if (effect.type === 'passive_rp') rpGain += effect.value / 2;
                        if (effect.type === 'passive_inf') infGain += effect.value / 2;
                        if (effect.type === 'passive_qf') qfGain += effect.value / 2;
                    });
                }
            });
            
            // Apply relic effects
            gameState.relics.discovered.forEach(relic => {
                if (relic.effects) {
                    relic.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value / 2;
                        if (effect.type === 'passive_rp') rpGain += effect.value / 2;
                        if (effect.type === 'passive_inf') infGain += effect.value / 2;
                        if (effect.type === 'passive_qf') qfGain += effect.value / 2;
                    });
                }
            });
            
            // Apply galaxy bonuses from active planets
            gameState.galaxy.activePlanets.forEach(planet => {
                if (planet.bonuses) {
                    planet.bonuses.forEach(bonus => {
                        if (bonus.type === 'passive_kp') kpGain += bonus.value / 2;
                        if (bonus.type === 'passive_rp') rpGain += bonus.value / 2;
                        if (bonus.type === 'passive_inf') infGain += bonus.value / 2;
                        if (bonus.type === 'passive_qf') qfGain += bonus.value / 2;
                    });
                }
            });
            
            // Apply production multiplier from permanent upgrades
            if (gameState.prestige.unlocked) {
                const productionUpgrade = gameState.prestige.permanentUpgrades.find(u => u.id === "resource_production");
                if (productionUpgrade && productionUpgrade.level > 0) {
                    let bonus = productionUpgrade.effect.value * productionUpgrade.level;
                    
                    // Apply diminishing returns if applicable
                    if (productionUpgrade.effect.diminishingReturns && 
                        productionUpgrade.level > productionUpgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = productionUpgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = productionUpgrade.level - normalLevels;
                        bonus = (productionUpgrade.effect.value * normalLevels) + 
                                (productionUpgrade.effect.value * diminishedLevels * 
                                 productionUpgrade.effect.diminishingReturns.factor);
                    }
                    
                    kpGain *= (1 + (bonus / 100));
                    rpGain *= (1 + (bonus / 100));
                    infGain *= (1 + (bonus / 100));
                    qfGain *= (1 + (bonus / 100));
                }
            }
            
            // If we gained resources, add them and update the UI
            if (kpGain > 0 || rpGain > 0 || infGain > 0 || qfGain > 0) {
                gameState.resources.knowledgePoints += kpGain;
                gameState.resources.researchPoints += rpGain;
                gameState.resources.influence += infGain;
                gameState.resources.quantumFragments += qfGain;
                
                // Update UI
                updateUI();
            }
        }
        
        // Calculate collection completion and apply bonuses
        function updateRelicCollections() {
            const collections = gameState.relics.collections;
            
            // Reset discovered counts
            Object.keys(collections).forEach(collection => {
                collections[collection].discovered = 0;
            });
            
            // Count discovered relics by collection
            gameState.relics.discovered.forEach(relic => {
                if (collections[relic.collection]) {
                    collections[relic.collection].discovered += 1;
                }
            });
            
            // TODO: Apply collection bonuses when a collection is complete
        }
        
        // Calculate offline progress
        function calculateOfflineProgress() {
            // If offline progress is disabled, return
            if (!gameState.settings.offlineProgress) return;
            
            // If this is the first time opening the app, don't calculate offline progress
            if (!gameState.lastPlayed) return;
            
            const now = Date.now();
            const timeDiff = now - gameState.lastPlayed;
            
            // If less than 1 minute has passed, don't calculate offline progress
            if (timeDiff < 60000) return;
            
            // Calculate how many minutes have passed
            const minutesOffline = Math.floor(timeDiff / 60000);
            
            // Calculate resource generation
            let kpGain = 0;
            let rpGain = 0;
            let infGain = 0;
            let qfGain = 0;
            
            // Calculate passive resource generation from facilities
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_rp') rpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_inf') infGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_qf') qfGain += effect.value * minutesOffline;
                    });
                }
            });
            
            // Apply research effects
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_rp') rpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_inf') infGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_qf') qfGain += effect.value * minutesOffline;
                        
                        // Apply offline progress bonus
                        if (effect.type === 'offline_progress') {
                            const offlineBonus = effect.value / 100;
                            kpGain *= (1 + offlineBonus);
                            rpGain *= (1 + offlineBonus);
                            infGain *= (1 + offlineBonus);
                            qfGain *= (1 + offlineBonus);
                        }
                    });
                }
            });
            
            // Apply relic effects
            gameState.relics.discovered.forEach(relic => {
                if (relic.effects) {
                    relic.effects.forEach(effect => {
                        if (effect.type === 'passive_kp') kpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_rp') rpGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_inf') infGain += effect.value * minutesOffline;
                        if (effect.type === 'passive_qf') qfGain += effect.value * minutesOffline;
                        
                        if (effect.type === 'offline_multiplier') {
                            const offlineBonus = effect.value / 100;
                            kpGain *= (1 + offlineBonus);
                            rpGain *= (1 + offlineBonus);
                            infGain *= (1 + offlineBonus);
                            qfGain *= (1 + offlineBonus);
                        }
                    });
                }
            });
            
            // Apply production multiplier from permanent upgrades
            if (gameState.prestige.unlocked) {
                const productionUpgrade = gameState.prestige.permanentUpgrades.find(u => u.id === "resource_production");
                if (productionUpgrade && productionUpgrade.level > 0) {
                    let bonus = productionUpgrade.effect.value * productionUpgrade.level;
                    
                    // Apply diminishing returns if applicable
                    if (productionUpgrade.effect.diminishingReturns && 
                        productionUpgrade.level > productionUpgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = productionUpgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = productionUpgrade.level - normalLevels;
                        bonus = (productionUpgrade.effect.value * normalLevels) + 
                                (productionUpgrade.effect.value * diminishedLevels * 
                                 productionUpgrade.effect.diminishingReturns.factor);
                    }
                    
                    kpGain *= (1 + (bonus / 100));
                    rpGain *= (1 + (bonus / 100));
                    infGain *= (1 + (bonus / 100));
                    qfGain *= (1 + (bonus / 100));
                }
            }
            
            // Cap the gains to avoid excessive resources
            const MAX_OFFLINE_MINUTES = 24 * 60; // 24 hours max
            const capMultiplier = Math.min(1, MAX_OFFLINE_MINUTES / minutesOffline);
            kpGain *= capMultiplier;
            rpGain *= capMultiplier;
            infGain *= capMultiplier;
            qfGain *= capMultiplier;
            
            // Add the resources
            gameState.resources.knowledgePoints += kpGain;
            gameState.resources.researchPoints += rpGain;
            gameState.resources.influence += infGain;
            gameState.resources.quantumFragments += qfGain;
            
            // Show notification with offline progress
            if (kpGain > 0 || rpGain > 0 || infGain > 0 || qfGain > 0) {
                const formattedTime = minutesOffline >= 60 
                    ? `${Math.floor(minutesOffline / 60)}h ${minutesOffline % 60}m`
                    : `${minutesOffline}m`;
                
                showNotification(`Welcome back! You gained ${Math.floor(kpGain)} KP, ${Math.floor(rpGain)} RP, ${Math.floor(infGain)} INF, and ${Math.floor(qfGain)} QF while away for ${formattedTime}.`, 'info');
            }
            
            // Update last played time
            gameState.lastPlayed = now;
        }
        
        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        
        // Update genre distribution in stats tab
        function updateGenreDistribution() {
            const genreDistributionContainer = document.getElementById('genre-distribution');
            if (!genreDistributionContainer) return;
            
            // Clear the container
            genreDistributionContainer.innerHTML = '';
            
            // Get total books
            const totalBooks = gameState.stats.booksCompleted;
            if (totalBooks === 0) {
                genreDistributionContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No books completed yet.</div>';
                return;
            }
            
            // Add standard genres
            const standardGenres = [
                { key: 'sci-fi', name: 'Science Fiction' },
                { key: 'fantasy', name: 'Fantasy' },
                { key: 'non-fiction', name: 'Non-Fiction' },
                { key: 'mystery', name: 'Mystery/Thriller' },
                { key: 'history', name: 'History' },
                { key: 'science', name: 'Science' },
                { key: 'biography', name: 'Biography' },
                { key: 'philosophy', name: 'Philosophy' },
                { key: 'poetry', name: 'Poetry' },
                { key: 'comic', name: 'Comic/Graphic Novel' }
            ];
            
            standardGenres.forEach(genre => {
                const count = gameState.stats.genreDistribution[genre.key] || 0;
                if (count > 0) {
                    addGenreBar(genre.name, count, totalBooks, genreDistributionContainer, 'blue-600');
                }
            });
            
            // Add custom genres
            const customGenres = gameState.stats.genreDistribution.custom;
            let colorIndex = 0;
            
            for (const [genreName, count] of Object.entries(customGenres)) {
                if (count > 0) {
                    const colorClass = gameConfig.genreColors[colorIndex % gameConfig.genreColors.length];
                    addGenreBar(genreName, count, totalBooks, genreDistributionContainer, colorClass);
                    colorIndex++;
                }
            }
        }
        
        // Helper function to add a genre bar to the distribution
        function addGenreBar(genreName, count, totalBooks, container, colorClass) {
            const genreDiv = document.createElement('div');
            genreDiv.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-700 dark:text-gray-300">${genreName}</span>
                    <span class="text-gray-700 dark:text-gray-300">${count} book${count !== 1 ? 's' : ''}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1">
                    <div class="bg-${colorClass} h-2.5 rounded-full" style="width: ${(count / totalBooks) * 100}%"></div>
                </div>
            `;
            container.appendChild(genreDiv);
        }
        
        // Update Enlightenment UI
        function updateEnlightenmentUI() {
            // Update available EP
            document.getElementById('available-ep').textContent = gameState.prestige.enlightenmentPoints;
            
            // Update EP preview
            updateEpPreview();
            
            // Update enlightenment upgrades container
            const container = document.getElementById('enlightenment-upgrades-container');
            container.innerHTML = '';
            
            // Add each permanent upgrade
            gameState.prestige.permanentUpgrades.forEach(upgrade => {
                const upgradeElement = createEnlightenmentUpgradeElement(upgrade);
                container.appendChild(upgradeElement);
            });
            
            // Update persisting facilities count
            const facilityRetention = gameState.prestige.permanentUpgrades.find(u => u.id === "facility_retention");
            document.getElementById('persisting-facilities-count').textContent = facilityRetention ? facilityRetention.level : 0;
        }
        
        // Create an enlightenment upgrade element
        function createEnlightenmentUpgradeElement(upgrade) {
            const div = document.createElement('div');
            div.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
            
            // Calculate current effect value and next level effect
            let currentEffect = '';
            let nextEffect = '';
            let cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
            
            // Common percentage-based effects
            if (['production_multiplier', 'reading_efficiency', 'xp_boost'].includes(upgrade.effect.type)) {
                let currentValue = upgrade.effect.value * upgrade.level;
                let nextValue = upgrade.effect.value * (upgrade.level + 1);
                
                // Apply diminishing returns if applicable
                if (upgrade.effect.diminishingReturns) {
                    if (upgrade.level > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = upgrade.level - normalLevels;
                        currentValue = (upgrade.effect.value * normalLevels) + 
                                      (upgrade.effect.value * diminishedLevels * 
                                       upgrade.effect.diminishingReturns.factor);
                    }
                    
                    if (upgrade.level + 1 > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = (upgrade.level + 1) - normalLevels;
                        nextValue = (upgrade.effect.value * normalLevels) + 
                                   (upgrade.effect.value * diminishedLevels * 
                                    upgrade.effect.diminishingReturns.factor);
                    }
                }
                
                currentEffect = `+${currentValue.toFixed(1)}%`;
                nextEffect = `+${nextValue.toFixed(1)}%`;
            }
            // Starting resources
            else if (upgrade.effect.type === 'starting_resources') {
                let currentKP = upgrade.effect.kp * upgrade.level;
                let currentRP = upgrade.effect.rp * upgrade.level;
                let nextKP = upgrade.effect.kp * (upgrade.level + 1);
                let nextRP = upgrade.effect.rp * (upgrade.level + 1);
                
                // Apply diminishing returns if applicable
                if (upgrade.effect.diminishingReturns) {
                    if (upgrade.level > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = upgrade.level - normalLevels;
                        currentKP = (upgrade.effect.kp * normalLevels) + 
                                   (upgrade.effect.kp * diminishedLevels * 
                                    upgrade.effect.diminishingReturns.factor);
                        currentRP = (upgrade.effect.rp * normalLevels) + 
                                   (upgrade.effect.rp * diminishedLevels * 
                                    upgrade.effect.diminishingReturns.factor);
                    }
                    
                    if (upgrade.level + 1 > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = (upgrade.level + 1) - normalLevels;
                        nextKP = (upgrade.effect.kp * normalLevels) + 
                                (upgrade.effect.kp * diminishedLevels * 
                                 upgrade.effect.diminishingReturns.factor);
                        nextRP = (upgrade.effect.rp * normalLevels) + 
                                (upgrade.effect.rp * diminishedLevels * 
                                 upgrade.effect.diminishingReturns.factor);
                    }
                }
                
                currentEffect = `+${Math.floor(currentKP)} KP, +${Math.floor(currentRP)} RP`;
                nextEffect = `+${Math.floor(nextKP)} KP, +${Math.floor(nextRP)} RP`;
            }
            // Auto research
            else if (upgrade.effect.type === 'auto_research') {
                currentEffect = `${upgrade.level} automatic researches`;
                nextEffect = `${upgrade.level + 1} automatic researches`;
            }
            // Facility retention
            else if (upgrade.effect.type === 'facility_retention') {
                currentEffect = `Retain ${upgrade.level} facilities`;
                nextEffect = `Retain ${upgrade.level + 1} facilities`;
            }
            // Quantum retention
            else if (upgrade.effect.type === 'quantum_retention') {
                let currentValue = 75 + (upgrade.effect.value * upgrade.level);
                let nextValue = 75 + (upgrade.effect.value * (upgrade.level + 1));
                currentEffect = `${currentValue}% QF retained`;
                nextEffect = `${nextValue}% QF retained`;
            }
            // Reading quantum
            else if (upgrade.effect.type === 'reading_quantum') {
                let currentValue = upgrade.effect.value * upgrade.level;
                let nextValue = upgrade.effect.value * (upgrade.level + 1);
                
                // Apply diminishing returns if applicable
                if (upgrade.effect.diminishingReturns) {
                    if (upgrade.level > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = upgrade.level - normalLevels;
                        currentValue = (upgrade.effect.value * normalLevels) + 
                                      (upgrade.effect.value * diminishedLevels * 
                                       upgrade.effect.diminishingReturns.factor);
                    }
                    
                    if (upgrade.level + 1 > upgrade.effect.diminishingReturns.threshold) {
                        const normalLevels = upgrade.effect.diminishingReturns.threshold;
                        const diminishedLevels = (upgrade.level + 1) - normalLevels;
                        nextValue = (upgrade.effect.value * normalLevels) + 
                                   (upgrade.effect.value * diminishedLevels * 
                                    upgrade.effect.diminishingReturns.factor);
                    }
                }
                
                currentEffect = `+${currentValue.toFixed(2)} QF per reading minute`;
                nextEffect = `+${nextValue.toFixed(2)} QF per reading minute`;
            }
            
            // Max level check
            const isMaxLevel = upgrade.maxLevel !== Infinity && upgrade.level >= upgrade.maxLevel;
            const canAfford = gameState.prestige.enlightenmentPoints >= cost;
            
            // Create the button text and classes
            let buttonText = isMaxLevel ? 
                "Maximum Level" : 
                `Upgrade (${cost} EP)`;
            
            let buttonClasses = "w-full text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200";
            
            if (isMaxLevel) {
                buttonClasses += " bg-gray-200 text-gray-500";
            } else if (!canAfford) {
                buttonClasses += " bg-gray-200 text-gray-500";
            } else {
                buttonClasses += " bg-enlightenment hover:bg-red-600 text-white";
            }
            
            div.innerHTML = `
                <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                    <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    ${upgrade.name}
                </h3>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                    ${upgrade.description}
                </div>
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                    <span>Current: ${currentEffect}</span>
                    <span>Level: ${upgrade.level}${upgrade.maxLevel !== Infinity ? '/' + upgrade.maxLevel : ''}</span>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                    <span>Next Level: ${nextEffect}</span>
                </div>
                <button class="${buttonClasses}" data-upgrade-id="${upgrade.id}" ${isMaxLevel || !canAfford ? 'disabled' : ''}>
                    ${buttonText}
                </button>
            `;
            
            return div;
        }
        
        // Update EP Preview Calculations
        function updateEpPreview() {
            // Calculate EP from player level
            const epFromLevel = Math.floor(gameState.player.level * gameConfig.epCalculation.levelFactor);
            document.getElementById('ep-from-level').textContent = epFromLevel;
            
            // Calculate EP from books completed
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameConfig.epCalculation.bookFactor);
            document.getElementById('ep-from-books').textContent = epFromBooks;
            
            // Calculate EP from research
            const epFromResearch = Math.floor(gameState.research.completed.length * gameConfig.epCalculation.researchFactor);
            document.getElementById('ep-from-research').textContent = epFromResearch;
            
            // Calculate total EP gain
            const totalEpGain = epFromLevel + epFromBooks + epFromResearch;
            document.getElementById('total-ep-gain').textContent = totalEpGain;
            document.getElementById('confirm-ep-gain').textContent = totalEpGain;
        }
        
        // Create facility card for the UI
        function createFacilityCard(facility) {
            const div = document.createElement('div');
            div.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container building-glow facility-card ${facility.id}`;
            div.dataset.facilityId = facility.id;
            
            // Get color class based on rarity
            const rarityData = gameConfig.rarities.find(r => r.name === facility.rarity) || gameConfig.rarities[0];
            const rarityColor = rarityData.color;
            
            // Create effects list
            let effectsHtml = '';
            if (facility.effects && facility.effects.length > 0) {
                effectsHtml = '<div class="mt-2 space-y-1">';
                facility.effects.forEach(effect => {
                    effectsHtml += `<div class="text-xs text-${rarityColor}-600 dark:text-${rarityColor}-400">â€¢ ${effect.description}</div>`;
                });
                effectsHtml += '</div>';
            }
            
            // Calculate upgrade costs
            const currentCost = facility.currentCost;
            const nextLevel = facility.level + 1;
            
            // Create button text and classes
            let buttonText = '';
            let buttonClasses = 'w-full text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200';
            
            if (facility.level === 0) {
                buttonText = `Build (${currentCost.kp} KP, ${currentCost.rp} RP)`;
                
                if (gameState.resources.knowledgePoints >= currentCost.kp && 
                    gameState.resources.researchPoints >= currentCost.rp) {
                    buttonClasses += ' bg-primary hover:bg-blue-700 text-white';
                } else {
                    buttonClasses += ' bg-gray-200 text-gray-500';
                }
            } else {
                buttonText = `Upgrade to Level ${nextLevel} (${currentCost.kp} KP, ${currentCost.rp} RP)`;
                
                if (gameState.resources.knowledgePoints >= currentCost.kp && 
                    gameState.resources.researchPoints >= currentCost.rp) {
                    buttonClasses += ' bg-primary hover:bg-blue-700 text-white';
                } else {
                    buttonClasses += ' bg-gray-200 text-gray-500';
                }
            }
            
            div.innerHTML = `
                <div class="absolute top-2 right-2 text-xs px-2 py-1 bg-${rarityColor}-100 text-${rarityColor}-800 dark:bg-${rarityColor}-900 dark:text-${rarityColor}-200 rounded">${facility.rarity.charAt(0).toUpperCase() + facility.rarity.slice(1)}</div>
                <h3 class="font-bold text-gray-900 dark:text-dark-text pr-20">${facility.name}</h3>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                    ${facility.description}
                </div>
                ${effectsHtml}
                <div class="space-y-2 mt-4">
                    <div>
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>Level: <span class="facility-level">${facility.level}</span></span>
                        </div>
                    </div>
                    <button class="${buttonClasses} facility-button">
                        ${buttonText}
                    </button>
                </div>
                <div class="tooltip">
                    <div class="text-xs font-semibold mb-1">${facility.name}</div>
                    <div class="text-xs mb-2">${facility.description}</div>
                    <div class="text-xs">
                        <div class="font-semibold">Effects:</div>
                        <ul class="list-disc list-inside">
                            ${facility.effects.map(effect => `<li>${effect.description}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Create research card for the UI
        function createResearchCard(research) {
            const div = document.createElement('div');
            div.className = "border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative research-card";
            div.dataset.researchId = research.id;
            
            // Get color class based on rarity
            const rarityData = gameConfig.rarities.find(r => r.name === research.rarity) || gameConfig.rarities[0];
            const rarityColor = rarityData.color;
            
            // Create effects list
            let effectsHtml = '';
            if (research.effects && research.effects.length > 0) {
                effectsHtml = '<div class="text-xs text-gray-600 dark:text-gray-400 mt-2">';
                effectsHtml += '<span class="font-medium">Benefits:</span>';
                effectsHtml += '<ul class="list-disc list-inside mt-1 space-y-1">';
                research.effects.forEach(effect => {
                    effectsHtml += `<li class="text-${rarityColor}-600 dark:text-${rarityColor}-400">${effect.description}</li>`;
                });
                effectsHtml += '</ul></div>';
            }
            
            // Determine button state
            let buttonState = '';
            let buttonClasses = 'w-full text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200';
            
            if (research.completed) {
                buttonState = 'Researched';
                buttonClasses += ' bg-gray-200 text-gray-500 cursor-not-allowed';
            } else if (gameState.resources.researchPoints < research.cost) {
                buttonState = `Research (${research.cost} RP)`;
                buttonClasses += ' bg-gray-200 text-gray-500';
            } else {
                buttonState = `Research (${research.cost} RP)`;
                buttonClasses += ' bg-primary hover:bg-blue-700 text-white';
            }
            
            div.innerHTML = `
                <div class="absolute top-2 right-2 text-xs px-2 py-1 bg-${rarityColor}-100 text-${rarityColor}-800 dark:bg-${rarityColor}-900 dark:text-${rarityColor}-200 rounded">${research.rarity.charAt(0).toUpperCase() + research.rarity.slice(1)}</div>
                <h3 class="font-bold text-gray-900 dark:text-dark-text pr-20">${research.name}</h3>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                    ${research.description}
                </div>
                ${effectsHtml}
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1 mt-3">
                    <span>Type: ${research.type.charAt(0).toUpperCase() + research.type.slice(1)} ${research.field.charAt(0).toUpperCase() + research.field.slice(1)}</span>
                    <span>Status: <span class="research-status">${research.completed ? 'Researched' : 'Not Researched'}</span></span>
                </div>
                <button class="${buttonClasses} research-button" ${research.completed ? 'disabled' : ''}>
                    ${buttonState}
                </button>
            `;
            
            return div;
        }
        
        // Create relic card for the UI
        function createRelicCard(relic) {
            const div = document.createElement('div');
            div.className = `relic-card bg-white dark:bg-dark-card overflow-hidden shadow-lg relative ${relic.id}`;
            div.dataset.relicId = relic.id;
            
            // Get rarity data
            const rarityData = gameConfig.relics.relicRarities.find(r => r.name === relic.rarity) || gameConfig.relics.relicRarities[0];
            
            // Create effects list
            let effectsHtml = '';
            if (relic.effects && relic.effects.length > 0) {
                effectsHtml = '<div class="px-4 py-2 space-y-1 border-t border-gray-200 dark:border-gray-700">';
                relic.effects.forEach(effect => {
                    effectsHtml += `<div class="text-xs text-${rarityData.color} dark:text-${rarityData.color}">â€¢ ${effect.description}</div>`;
                });
                effectsHtml += '</div>';
            }
            
            // Add the relic border based on rarity
            div.innerHTML = `
                <div class="relic-border ${rarityData.cssClass}"></div>
                <div class="px-4 pt-3 pb-2">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-gray-900 dark:text-dark-text text-sm">${relic.name}</h3>
                        <div class="text-xs px-2 py-1 bg-${rarityData.color} bg-opacity-20 text-${rarityData.color} rounded-full">${relic.rarity.charAt(0).toUpperCase() + relic.rarity.slice(1)}</div>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                        ${relic.collection}
                    </div>
                </div>
                ${effectsHtml}
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-${rarityData.color} to-transparent opacity-50"></div>
            `;
            
            // Add a subtle glow effect with animation
            div.classList.add('float-animation');
            
            return div;
        }
        
        // Update galaxy map UI
        function updateGalaxyUI() {
            // Update galaxy tab visibility based on unlock status
            if (gameState.galaxy.unlocked) {
                document.getElementById('galaxy-unlock-message').classList.add('hidden');
                document.getElementById('galaxy-interface').classList.remove('hidden');
                
                // Update galaxy stats
                document.getElementById('systems-discovered').textContent = gameState.galaxy.stats.systemsDiscovered;
                document.getElementById('outposts-established').textContent = gameState.galaxy.stats.outpostsEstablished;
                document.getElementById('exploration-range').textContent = gameState.galaxy.explorationRange;
                document.getElementById('next-system-cost').textContent = gameState.galaxy.nextSystemCost;
                
                // Update outposts list
                updateOutpostsList();
                
                // Update expedition status if there's an active expedition
                updateExpeditionStatus();
            } else {
                document.getElementById('galaxy-unlock-message').classList.remove('hidden');
                document.getElementById('galaxy-interface').classList.add('hidden');
            }
            
            // Also update the galaxy influence display
            document.getElementById('galaxy-influence').textContent = Math.floor(gameState.resources.influence);
        }
        
        // Initialize Galaxy Map
        function initializeGalaxyMap() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            // Clear existing map elements
            mapContainer.innerHTML = '';
            
            // Create exploration radius indicator
            const radiusIndicator = document.createElement('div');
            radiusIndicator.id = 'exploration-radius';
            radiusIndicator.className = 'exploration-radius';
            mapContainer.appendChild(radiusIndicator);
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.id = 'star-tooltip';
            tooltip.className = 'star-tooltip';
            mapContainer.appendChild(tooltip);
            
            // Create galaxy controls
            const controls = document.createElement('div');
            controls.className = 'galaxy-controls';
            controls.innerHTML = `
                <button class="galaxy-control-btn" id="zoom-in">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="zoom-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="center-map">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="explore-system">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            `;
            mapContainer.appendChild(controls);
            
            // Add background stars
            addBackgroundStars();
            
            // Render known systems
            renderGalaxySystems();
            
            // Update exploration radius
            updateExplorationRadius();
            
            // Add event listeners for controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoomGalaxyMap(0.25); // Zoom in by 25%
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                zoomGalaxyMap(-0.25); // Zoom out by 25%
            });
            
            document.getElementById('center-map').addEventListener('click', () => {
                centerGalaxyMap();
            });
            
            document.getElementById('explore-system').addEventListener('click', () => {
                exploreRandomSystem();
            });
            
            // Add drag functionality to the map
            addMapDragFunctionality();
        }
        
        // Add background stars to the galaxy map
        function addBackgroundStars() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            
            // Generate between 50-100 stars based on map size
            const numStars = Math.floor(mapWidth * mapHeight / 1000);
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // Random size (0.5px to 2px)
                const size = 0.5 + Math.random() * 1.5;
                
                // Random opacity
                const opacity = 0.3 + Math.random() * 0.7;
                
                // Apply styles
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.opacity = opacity.toString();
                
                // Add animation with random delay
                star.style.animation = `twinkle 3s ease-in-out infinite alternate`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                
                mapContainer.appendChild(star);
            }
        }
        
        // Render star systems on the galaxy map
        function renderGalaxySystems() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Clear existing systems
            const existingSystems = mapContainer.querySelectorAll('.star-system');
            existingSystems.forEach(system => system.remove());
            
            // Calculate current view parameters
            const zoomFactor = gameState.galaxy.zoomLevel;
            const viewCenterX = gameState.galaxy.viewCenter.x;
            const viewCenterY = gameState.galaxy.viewCenter.y;
            
            // Add home system at center if it doesn't exist
            if (!gameState.galaxy.discoveredSystems['home']) {
                gameState.galaxy.discoveredSystems['home'] = {
                    id: 'home',
                    name: 'Home System',
                    coordinates: { x: 0, y: 0 },
                    type: 'fiction',
                    rarity: 'uncommon',
                    discovered: true,
                    outpostEstablished: true,
                    description: 'Your home system, where your reading journey began.',
                    planets: [
                        {
                            id: 'home-prime',
                            name: 'Bibliotheca Prime',
                            colonized: true,
                            bonuses: [
                                { type: 'kp_per_page', value: 5 }
                            ],
                            description: 'Your starting world, providing a solid foundation for your reading empire.'
                        }
                    ]
                };
                gameState.galaxy.stats.systemsDiscovered = 1;
                gameState.galaxy.stats.outpostsEstablished = 1;
                gameState.galaxy.stats.planetsColonized = 1;
                
                // Add the home planet to active planets
                gameState.galaxy.activePlanets.push({
                    systemId: 'home',
                    planetId: 'home-prime',
                    systemName: 'Home System',
                    planetName: 'Bibliotheca Prime',
                    bonuses: [
                        { type: 'kp_per_page', value: 5 }
                    ]
                });
            }
            
            // Render each discovered system
            for (const systemId in gameState.galaxy.discoveredSystems) {
                const system = gameState.galaxy.discoveredSystems[systemId];
                
                // Calculate screen position
                const scaledX = (system.coordinates.x - viewCenterX) * zoomFactor * 50 + centerX;
                const scaledY = (system.coordinates.y - viewCenterY) * zoomFactor * 50 + centerY;
                
                // Skip if outside visible area with padding
                const padding = 50; // Pixels
                if (scaledX < -padding || scaledX > mapWidth + padding || 
                    scaledY < -padding || scaledY > mapHeight + padding) {
                    continue;
                }
                
                // Create system element
                const systemElement = document.createElement('div');
                systemElement.className = 'star-system';
                systemElement.dataset.systemId = systemId;
                
                // Set position and size based on rarity
                systemElement.style.left = `${scaledX}px`;
                systemElement.style.top = `${scaledY}px`;
                
                const size = gameConfig.galaxy.starSizesByRarity[system.rarity] * zoomFactor;
                systemElement.style.width = `${size}px`;
                systemElement.style.height = `${size}px`;
                
                // Set color based on type
                systemElement.style.backgroundColor = gameConfig.galaxy.systemColors[system.type];
                
                // Add outpost indicator if established
                if (system.outpostEstablished) {
                    systemElement.style.border = '2px solid white';
                }
                
                // Add glow based on rarity
                systemElement.style.boxShadow = `0 0 ${size/2}px ${gameConfig.galaxy.rarityColors[system.rarity]}`;
                
                // Add event listeners
                systemElement.addEventListener('mouseover', (e) => {
                    showSystemTooltip(system, e);
                });
                
                systemElement.addEventListener('mouseout', () => {
                    hideSystemTooltip();
                });
                
                systemElement.addEventListener('click', () => {
                    selectGalaxySystem(system);
                });
                
                mapContainer.appendChild(systemElement);
            }
        }
        
        // Update the exploration radius indicator
        function updateExplorationRadius() {
            const radiusIndicator = document.getElementById('exploration-radius');
            if (!radiusIndicator) return;
            
            const mapContainer = document.getElementById('galaxy-map');
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Calculate radius based on exploration range and zoom
            const radius = gameState.galaxy.explorationRange * gameState.galaxy.zoomLevel * 50;
            
            // Position and size the indicator
            radiusIndicator.style.left = `${centerX - radius}px`;
            radiusIndicator.style.top = `${centerY - radius}px`;
            radiusIndicator.style.width = `${radius * 2}px`;
            radiusIndicator.style.height = `${radius * 2}px`;
        }
        
        // Show tooltip for a star system
        function showSystemTooltip(system, event) {
            const tooltip = document.getElementById('star-tooltip');
            if (!tooltip) return;
            
            // Set tooltip content
            tooltip.innerHTML = `
                <div class="font-bold text-sm mb-1">${system.name}</div>
                <div class="flex justify-between text-xs mb-1">
                    <span>${capitalizeFirstLetter(system.type)}</span>
                    <span>${capitalizeFirstLetter(system.rarity)}</span>
                </div>
                <div class="text-xs mb-1">Planets: ${system.planets.length}</div>
                <div class="text-xs">${system.outpostEstablished ? 'âœ“ Outpost Established' : 'No Outpost'}</div>
            `;
            
            // Position tooltip near cursor
            const mapContainer = document.getElementById('galaxy-map');
            const rect = mapContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            tooltip.style.left = `${x + 15}px`;
            tooltip.style.top = `${y - 15}px`;
            
            // Show tooltip
            tooltip.style.opacity = '1';
        }
        
        // Hide system tooltip
        function hideSystemTooltip() {
            const tooltip = document.getElementById('star-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            if (!gameState.settings.showNotifications) return;
            
            const notificationContainer = document.getElementById('notification-container');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // Set background color based on type
            if (type === 'success') {
                notification.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
            } else if (type === 'error') {
                notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
            } else if (type === 'enlightenment') {
                notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                notification.innerHTML = `<div class="enlightenment-glow">${message}</div>`;
            } else {
                notification.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-800', 'dark:text-blue-100');
                notification.textContent = message;
            }
            
            if (type !== 'enlightenment') {
                notification.textContent = message;
            }
            
            // Add to notification area
            notificationContainer.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // Update current reading list
        function updateCurrentReadingList() {
            const listElement = document.getElementById('current-reading-list');
            
            // Clear the list
            listElement.innerHTML = '';
            
            if (gameState.currentBooks.length === 0) {
                listElement.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>';
                return;
            }
            
            // Add each book to the list
            gameState.currentBooks.forEach((book, index) => {
                const bookElement = document.createElement('div');
                bookElement.className = 'p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                
                // Handle display of custom genre
                let displayGenre = book.genre;
                if (book.genre === 'custom' && book.customGenre) {
                    displayGenre = book.customGenre;
                } else {
                    // Convert genre key to display name
                    const genreMap = {
                        'sci-fi': 'Science Fiction',
                        'fantasy': 'Fantasy',
                        'non-fiction': 'Non-Fiction',
                        'mystery': 'Mystery/Thriller',
                        'history': 'History',
                        'science': 'Science',
                        'biography': 'Biography',
                        'philosophy': 'Philosophy',
                        'poetry': 'Poetry',
                        'comic': 'Comic/Graphic Novel',
                        'other': 'Other'
                    };
                    displayGenre = genreMap[book.genre] || capitalizeFirstLetter(book.genre);
                }
                
                bookElement.innerHTML = `
                    <div class="flex justify-between">
                        <h4 class="font-medium text-gray-900 dark:text-dark-text">${book.title}</h4>
                        <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2 py-1 rounded-full">${displayGenre}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                        <span>Pages: ${book.pagesRead}</span>
                        <span>Reading Time: ${book.minutesRead} min</span>
                        <span>Difficulty: ${capitalizeFirstLetter(book.difficulty)}</span>
                    </div>
                `;
                
                listElement.appendChild(bookElement);
            });
        }
        
        // Update the outposts list in Galaxy tab
        function updateOutpostsList() {
            const outpostsList = document.getElementById('outposts-list');
            const noOutpostsMessage = document.getElementById('no-outposts-message');
            
            if (gameState.galaxy.stats.outpostsEstablished === 0) {
                noOutpostsMessage.classList.remove('hidden');
                outpostsList.classList.add('hidden');
                return;
            }
            
            noOutpostsMessage.classList.add('hidden');
            outpostsList.classList.remove('hidden');
            
            // Clear list
            outpostsList.innerHTML = '';
            
            // Get systems with outposts
            const outpostSystems = Object.values(gameState.galaxy.discoveredSystems)
                .filter(system => system.outpostEstablished);
            
            // Create outpost cards
            outpostSystems.forEach(system => {
                const outpostCard = document.createElement('div');
                outpostCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                
                // Get colonized planets in this system
                const colonizedPlanets = system.planets.filter(planet => planet.colonized);
                
                // Build bonuses text
                let bonusesHtml = '';
                if (colonizedPlanets.length > 0) {
                    colonizedPlanets.forEach(planet => {
                        if (planet.bonuses && planet.bonuses.length > 0) {
                            bonusesHtml += `<div class="mt-1"><span class="text-xs font-medium">${planet.name}:</span>`;
                            bonusesHtml += '<ul class="text-xs list-disc list-inside ml-2">';
                            
                            planet.bonuses.forEach(bonus => {
                                bonusesHtml += `<li>${bonus.description || bonus.type + ': ' + bonus.value}</li>`;
                            });
                            
                            bonusesHtml += '</ul></div>';
                        }
                    });
                }
                
                if (bonusesHtml === '') {
                    bonusesHtml = '<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">No active bonuses yet. Colonize planets to receive bonuses.</div>';
                }
                
                outpostCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-900 dark:text-dark-text">${system.name}</h3>
                        <div class="text-xs px-2 py-1 rounded" style="background-color: ${gameConfig.galaxy.systemColors[system.type]}20; color: ${gameConfig.galaxy.systemColors[system.type]};">
                            ${capitalizeFirstLetter(system.type)}
                        </div>
                    </div>
                    <div class="flex space-x-4 text-xs text-gray-600 dark:text-gray-400 mb-2">
                        <div>${colonizedPlanets.length}/${system.planets.length} Planets Colonized</div>
                        <div>${capitalizeFirstLetter(system.rarity)}</div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                        <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Active Bonuses:</div>
                        ${bonusesHtml}
                    </div>
                `;
                
                outpostsList.appendChild(outpostCard);
            });
        }
        
        // Update expedition status in the Galaxy UI
        function updateExpeditionStatus() {
            if (!gameState.galaxy.activeExpedition) return;
            
            const expeditionPanel = document.getElementById('expedition-panel');
            const expeditionProgress = document.getElementById('expedition-progress');
            const expeditionTime = document.getElementById('expedition-time');
            const expeditionMessage = document.getElementById('expedition-message');
            
            // Show the panel
            expeditionPanel.classList.remove('hidden');
            
            const now = Date.now();
            const elapsed = now - gameState.galaxy.activeExpedition.startTime;
            const duration = gameState.galaxy.activeExpedition.duration;
            const remaining = Math.max(0, duration - elapsed);
            
            // Calculate progress
            const progress = Math.min(100, (elapsed / duration) * 100);
            gameState.galaxy.activeExpedition.progress = progress;
            
            // Update progress bar
            expeditionProgress.style.width = `${progress}%`;
            
            // Update time remaining
            const seconds = Math.ceil(remaining / 1000);
            expeditionTime.textContent = `0:${seconds < 10 ? '0' + seconds : seconds}`;
            
            // Update message based on progress
            if (progress < 33) {
                expeditionMessage.textContent = 'Your literary expedition is exploring the cosmos...';
            } else if (progress < 66) {
                expeditionMessage.textContent = 'The expedition has detected intriguing narrative resonances...';
            } else if (progress < 100) {
                expeditionMessage.textContent = 'A new literary system is coming into focus...';
            }
            
            // Check if expedition is complete
            if (progress >= 100) {
                // Complete the expedition
                completeExpedition();
            } else {
                // Continue updating
                setTimeout(updateExpeditionStatus, 100);
            }
        }
        
        // Update the relic collections display
        function updateRelicCollections() {
            const collectionsContainer = document.getElementById('relic-collections-container');
            if (!collectionsContainer) return;
            
            collectionsContainer.innerHTML = '';
            
            // Get each collection
            Object.entries(gameState.relics.collections).forEach(([name, data]) => {
                const collectionDiv = document.createElement('div');
                collectionDiv.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-3';
                
                // Calculate progress percentage
                const percentage = (data.discovered / data.total) * 100;
                const isComplete = data.discovered === data.total;
                
                // Generate HTML
                collectionDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-medium text-gray-900 dark:text-dark-text">${name}</h4>
                        <span class="text-xs text-gray-600 dark:text-gray-400">${data.discovered}/${data.total}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full ${isComplete ? 'bg-enlightenment' : 'bg-primary'}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Collection Bonus:</span> ${data.bonus}
                        ${isComplete ? ' <span class="text-enlightenment">(Active)</span>' : ' <span class="text-gray-500">(Incomplete)</span>'}
                    </div>
                `;
                
                collectionsContainer.appendChild(collectionDiv);
            });
        }
        
        // Show the discovery modal for a newly found system
        function showDiscoveryModal(system) {
            // Update modal content
            document.getElementById('discovered-system-name').textContent = system.name;
            document.getElementById('discovered-system-description').textContent = system.description;
            document.getElementById('discovered-system-type').textContent = capitalizeFirstLetter(system.type);
            document.getElementById('discovered-system-planets').textContent = system.planets.length;
            document.getElementById('discovered-system-rarity').textContent = capitalizeFirstLetter(system.rarity);
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            document.getElementById('discovery-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').addEventListener('click', () => {
                document.getElementById('discovery-modal').classList.add('hidden');
                document.getElementById('discovery-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
                
                // Select the discovered system
                selectGalaxySystem(system);
            });
        }
        
        // Show the new facility modal
        function showNewFacilityModal(facility) {
            // Update modal content
            document.getElementById('new-facility-name').textContent = facility.name;
            document.getElementById('new-facility-description').textContent = facility.description;
            document.getElementById('new-facility-type').textContent = capitalizeFirstLetter(facility.type);
            document.getElementById('new-facility-rarity').textContent = capitalizeFirstLetter(facility.rarity);
            
            // Create effects list
            const effectsContainer = document.getElementById('new-facility-effects');
            effectsContainer.innerHTML = '';
            
            if (facility.effects && facility.effects.length > 0) {
                const effectsList = document.createElement('ul');
                effectsList.className = 'list-disc list-inside';
                
                facility.effects.forEach(effect => {
                    const effectItem = document.createElement('li');
                    effectItem.textContent = effect.description;
                    effectsList.appendChild(effectItem);
                });
                
                effectsContainer.appendChild(effectsList);
            } else {
                effectsContainer.textContent = 'No special effects';
            }
            
            // Show modal
            document.getElementById('new-facility-modal').classList.remove('hidden');
            document.getElementById('new-facility-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            
            // Add event listener to close button
            document.getElementById('close-facility-modal').addEventListener('click', () => {
                document.getElementById('new-facility-modal').classList.add('hidden');
                document.getElementById('new-facility-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
                
                // Add facility to UI
                updateFacilitiesUI();
            });
        }
        
        // Show the new research modal
        function showNewResearchModal(research) {
            // Update modal content
            document.getElementById('new-research-name').textContent = research.name;
            document.getElementById('new-research-description').textContent = research.description;
            document.getElementById('new-research-type').textContent = capitalizeFirstLetter(research.type);
            document.getElementById('new-research-rarity').textContent = capitalizeFirstLetter(research.rarity);
            document.getElementById('new-research-cost').textContent = research.cost;
            
            // Create effects list
            const effectsContainer = document.getElementById('new-research-effects');
            effectsContainer.innerHTML = '';
            
            if (research.effects && research.effects.length > 0) {
                const effectsList = document.createElement('ul');
                effectsList.className = 'list-disc list-inside';
                
                research.effects.forEach(effect => {
                    const effectItem = document.createElement('li');
                    effectItem.textContent = effect.description;
                    effectsList.appendChild(effectItem);
                });
                
                effectsContainer.appendChild(effectsList);
            } else {
                effectsContainer.textContent = 'No special effects';
            }
            
            // Show modal
            document.getElementById('new-research-modal').classList.remove('hidden');
            document.getElementById('new-research-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            
            // Add event listener to close button
            document.getElementById('close-research-modal').addEventListener('click', () => {
                document.getElementById('new-research-modal').classList.add('hidden');
                document.getElementById('new-research-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
                
                // Add research to UI
                updateResearchUI();
            });
        }
        
        // Show the new relic modal
        function showNewRelicModal(relic) {
            // Update modal content
            document.getElementById('new-relic-name').textContent = relic.name;
            document.getElementById('new-relic-description').textContent = relic.description;
            document.getElementById('new-relic-collection').textContent = relic.collection;
            document.getElementById('new-relic-rarity').textContent = capitalizeFirstLetter(relic.rarity);
            
            // Create effects list
            const effectsContainer = document.getElementById('new-relic-effects');
            effectsContainer.innerHTML = '';
            
            if (relic.effects && relic.effects.length > 0) {
                const effectsList = document.createElement('ul');
                effectsList.className = 'list-disc list-inside';
                
                relic.effects.forEach(effect => {
                    const effectItem = document.createElement('li');
                    effectItem.textContent = effect.description;
                    effectsList.appendChild(effectItem);
                });
                
                effectsContainer.appendChild(effectsList);
            } else {
                effectsContainer.textContent = 'No special effects';
            }
            
            // Show modal
            document.getElementById('new-relic-modal').classList.remove('hidden');
            document.getElementById('new-relic-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            
            // Add event listener to close button
            document.getElementById('close-relic-modal').addEventListener('click', () => {
                document.getElementById('new-relic-modal').classList.add('hidden');
                document.getElementById('new-relic-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
                
                // Update relic collections
                updateRelicCollectionsUI();
                
                // Update relics list
                updateRelicsUI();
            });
        }
        
        // Update the user interface based on game state
        function updateUI() {
            // Update resource displays
            document.getElementById('knowledge-points').textContent = Math.floor(gameState.resources.knowledgePoints);
            document.getElementById('research-points').textContent = Math.floor(gameState.resources.researchPoints);
            document.getElementById('influence').textContent = Math.floor(gameState.resources.influence);
            document.getElementById('quantum-fragments').textContent = Math.floor(gameState.resources.quantumFragments);
            
            // Update player stats
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('books-read').textContent = gameState.stats.booksCompleted;
            document.getElementById('relics-found').textContent = gameState.relics.discovered.length;
            document.getElementById('prestige-level').textContent = gameState.prestige.level;
            
// Calculate passive RP from facilities
let passiveRp = 0.5; // Base 0.5 RP/min
gameState.facilities.built.forEach(facility => {
    if (facility.effects) {
        facility.effects.forEach(effect => {
            if (effect.type === 'passive_rp') {
                passiveRp += effect.value;
            }
        });
    }
});
document.getElementById('passive-rp').textContent = passiveRp.toFixed(1);
            
            // Update Galaxy UI component
            updateGalaxyUI();
            
            // Update enlightenment UI if prestige is unlocked
            if (gameState.prestige.unlocked) {
                document.getElementById('enlightenment-points').textContent = gameState.prestige.enlightenmentPoints;
                updateEnlightenmentUI();
            }
            
            // Update stats tab
            document.getElementById('stat-total-books').textContent = gameState.stats.booksCompleted;
            document.getElementById('stat-total-pages').textContent = gameState.stats.pagesRead;
            document.getElementById('stat-total-minutes').textContent = gameState.stats.minutesRead;
            document.getElementById('stat-total-kp').textContent = Math.floor(gameState.stats.totalKpGenerated);
            
            // Update discovery stats
            document.getElementById('stat-facilities').textContent = gameState.stats.facilitiesBuilt;
            document.getElementById('stat-research').textContent = gameState.stats.researchCompleted;
            document.getElementById('stat-systems').textContent = gameState.stats.systemsDiscovered;
            document.getElementById('stat-relics').textContent = gameState.stats.relicsFound;
            
            // Update genre distribution
            updateGenreDistribution();
            
            // Update achievement progress
            document.getElementById('bookworm-progress').textContent = Math.min(gameState.stats.booksCompleted, 5);
            document.getElementById('prolific-progress').textContent = Math.min(gameState.stats.pagesRead, 1000);
            
            // Update lifetime stats
            document.getElementById('lifetime-prestige').textContent = gameState.lifetimeStats.totalPrestiges;
            document.getElementById('lifetime-ep').textContent = gameState.lifetimeStats.totalEnlightenmentPoints;
            document.getElementById('max-level').textContent = gameState.lifetimeStats.maxLevel;
            document.getElementById('max-books').textContent = gameState.lifetimeStats.maxBooks;
            
            // Update current reading list
            updateCurrentReadingList();
            
            // Update facilities UI
            updateFacilitiesUI();
            
            // Update research UI
            updateResearchUI();
            
            // Update relics UI
            updateRelicsUI();
            
            // Check for new unlocks
            checkUnlocks();
        }
        
        // Update facilities UI
        function updateFacilitiesUI() {
            const facilitiesGrid = document.getElementById('facilities-grid');
            const nextFacilityCost = document.getElementById('next-facility-cost');
            const nextFacilityRpCost = document.getElementById('next-facility-rp-cost');
            
            if (!facilitiesGrid) return;
            
            // Clear the grid
            facilitiesGrid.innerHTML = '';
            
            // Update next discovery cost
            nextFacilityCost.textContent = gameState.facilities.nextDiscoveryCost.kp;
            nextFacilityRpCost.textContent = gameState.facilities.nextDiscoveryCost.rp;
            
            // Add each available facility
            gameState.facilities.available.forEach(facility => {
                const facilityCard = createFacilityCard(facility);
                facilitiesGrid.appendChild(facilityCard);
            });
            
            // Add each built facility
            gameState.facilities.built.forEach(facility => {
                const facilityCard = createFacilityCard(facility);
                facilitiesGrid.appendChild(facilityCard);
            });
            
            // Add event listeners to facility buttons
            document.querySelectorAll('.facility-button').forEach(button => {
                button.addEventListener('click', handleFacilityButtonClick);
            });
        }
        
        // Update research UI
        function updateResearchUI() {
            const researchContainer = document.getElementById('research-projects-container');
            const nextResearchCost = document.getElementById('next-research-cost');
            
            if (!researchContainer) return;
            
            // Clear the container
            researchContainer.innerHTML = '';
            
            // Update next discovery cost
            nextResearchCost.textContent = gameState.research.nextDiscoveryCost;
            
            // Add each available research
            gameState.research.available.forEach(research => {
                const researchCard = createResearchCard(research);
                researchContainer.appendChild(researchCard);
            });
            
            // Add each completed research
            gameState.research.completed.forEach(research => {
                const researchCard = createResearchCard(research);
                researchContainer.appendChild(researchCard);
            });
            
            // Add event listeners to research buttons
            document.querySelectorAll('.research-button').forEach(button => {
                button.addEventListener('click', handleResearchButtonClick);
            });
        }
        
        // Update relics UI
        function updateRelicsUI() {
            // Update relics grid
            const relicsGrid = document.getElementById('relics-grid');
            const noRelicsMessage = document.getElementById('no-relics-message');
            const relicsCount = document.getElementById('relics-count');
            
            if (!relicsGrid) return;
            
            // Clear the grid
            relicsGrid.innerHTML = '';
            
            // Update relics count
            relicsCount.textContent = gameState.relics.discovered.length;
            
            // Show/hide no relics message
            if (gameState.relics.discovered.length === 0) {
                noRelicsMessage.classList.remove('hidden');
                relicsGrid.classList.add('hidden');
            } else {
                noRelicsMessage.classList.add('hidden');
                relicsGrid.classList.remove('hidden');
                
                // Add each discovered relic
                gameState.relics.discovered.forEach(relic => {
                    const relicCard = createRelicCard(relic);
                    relicsGrid.appendChild(relicCard);
                });
            }
        }
        
        // Update relic collections UI
        function updateRelicCollectionsUI() {
            // First update the data
            updateRelicCollections();
            
            // Then update the UI
            const collectionsContainer = document.getElementById('relic-collections-container');
            if (!collectionsContainer) return;
            
            collectionsContainer.innerHTML = '';
            
            // Add each collection
            Object.entries(gameState.relics.collections).forEach(([name, data]) => {
                const collectionDiv = document.createElement('div');
                collectionDiv.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-3';
                
                // Calculate progress percentage
                const percentage = (data.discovered / data.total) * 100;
                const isComplete = data.discovered === data.total;
                
                // Generate HTML
                collectionDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-medium text-gray-900 dark:text-dark-text">${name}</h4>
                        <span class="text-xs text-gray-600 dark:text-gray-400">${data.discovered}/${data.total}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                        <div class="h-2 rounded-full ${isComplete ? 'bg-enlightenment' : 'bg-primary'}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Collection Bonus:</span> ${data.bonus}
                        ${isComplete ? ' <span class="text-enlightenment">(Active)</span>' : ' <span class="text-gray-500">(Incomplete)</span>'}
                    </div>
                `;
                
                collectionsContainer.appendChild(collectionDiv);
            });
        }
        
        // Helper function to capitalize the first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // ==========================================
        // GAME LOGIC HANDLERS
        // ==========================================
        
        // Check for new unlocks based on game state
        function checkUnlocks() {
            // TODO: Implementation depends on specific unlock conditions
        }
        
        // Handle facility button click (build or upgrade)
        function handleFacilityButtonClick(event) {
            const facilityCard = event.target.closest('.facility-card');
            if (!facilityCard) return;
            
            const facilityId = facilityCard.dataset.facilityId;
            
            // Find the facility in available or built
            let facility = gameState.facilities.available.find(f => f.id === facilityId);
            let isAvailable = true;
            
            if (!facility) {
                facility = gameState.facilities.built.find(f => f.id === facilityId);
                isAvailable = false;
            }
            
            if (!facility) return;
            
            if (facility.level === 0) {
                // Build the facility
                if (gameState.resources.knowledgePoints < facility.currentCost.kp || 
                    gameState.resources.researchPoints < facility.currentCost.rp) {
                    showNotification('Not enough resources to build this facility.', 'error');
                    return;
                }
                
                // Deduct resources
                gameState.resources.knowledgePoints -= facility.currentCost.kp;
                gameState.resources.researchPoints -= facility.currentCost.rp;
                
                // Update facility
                facility.level = 1;
                
                // Calculate next upgrade cost
                facility.currentCost = {
                    kp: Math.floor(facility.baseCost.kp * Math.pow(facility.costMultiplier, facility.level)),
                    rp: Math.floor(facility.baseCost.rp * Math.pow(facility.costMultiplier, facility.level))
                };
                
                // Move from available to built
                if (isAvailable) {
                    gameState.facilities.available = gameState.facilities.available.filter(f => f.id !== facilityId);
                    gameState.facilities.built.push(facility);
                }
                
                // Update stats
                gameState.stats.facilitiesBuilt++;
                
                showNotification(`${facility.name} has been built!`, 'success');
            } else {
                // Upgrade the facility
                if (gameState.resources.knowledgePoints < facility.currentCost.kp || 
                    gameState.resources.researchPoints < facility.currentCost.rp) {
                    showNotification('Not enough resources to upgrade this facility.', 'error');
                    return;
                }
                
                // Deduct resources
                gameState.resources.knowledgePoints -= facility.currentCost.kp;
                gameState.resources.researchPoints -= facility.currentCost.rp;
                
                // Update facility
                facility.level++;
                
                // Calculate next upgrade cost
                facility.currentCost = {
                    kp: Math.floor(facility.baseCost.kp * Math.pow(facility.costMultiplier, facility.level)),
                    rp: Math.floor(facility.baseCost.rp * Math.pow(facility.costMultiplier, facility.level))
                };
                
                showNotification(`${facility.name} upgraded to level ${facility.level}!`, 'success');
            }
            
            // Update UI
            updateUI();
        }
        
        // Handle research button click
        function handleResearchButtonClick(event) {
            const researchCard = event.target.closest('.research-card');
            if (!researchCard) return;
            
            const researchId = researchCard.dataset.researchId;
            
            // Find the research in available list
            const research = gameState.research.available.find(r => r.id === researchId);
            if (!research || research.completed) return;
            
            // Check if player has enough RP
            if (gameState.resources.researchPoints < research.cost) {
                showNotification('Not enough Research Points to complete this research.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.researchPoints -= research.cost;
            
            // Mark as completed
            research.completed = true;
            research.completionDate = Date.now();
            
            // Move from available to completed
            gameState.research.available = gameState.research.available.filter(r => r.id !== researchId);
            gameState.research.completed.push(research);
            
            // Update stats
            gameState.stats.researchCompleted++;
            
            showNotification(`${research.name} research completed!`, 'success');
            
            // Update UI
            updateUI();
        }
        
        // Discover new facility
        function discoverNewFacility() {
            // Check if player has enough resources
            if (gameState.resources.knowledgePoints < gameState.facilities.nextDiscoveryCost.kp ||
                gameState.resources.researchPoints < gameState.facilities.nextDiscoveryCost.rp) {
                showNotification('Not enough resources to discover a new facility.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.knowledgePoints -= gameState.facilities.nextDiscoveryCost.kp;
            gameState.resources.researchPoints -= gameState.facilities.nextDiscoveryCost.rp;
            
            // Generate a new facility
            const newFacility = generateFacility();
            
            // Add to available facilities
            gameState.facilities.available.push(newFacility);
            
            // Increment discovery count
            gameState.facilities.discoveryCount++;
            
            // Calculate next discovery cost
            gameState.facilities.nextDiscoveryCost = {
                kp: Math.floor(gameState.facilities.nextDiscoveryCost.kp * gameState.facilities.costMultiplier),
                rp: Math.floor(gameState.facilities.nextDiscoveryCost.rp * gameState.facilities.costMultiplier)
            };
            
            // Show the new facility modal
            showNewFacilityModal(newFacility);
            
            // Update UI
            updateUI();
        }
        
        // Generate new research
        function generateNewResearch() {
            // Check if player has enough RP
            if (gameState.resources.researchPoints < gameState.research.nextDiscoveryCost) {
                showNotification('Not enough Research Points to generate new research.', 'error');
                return;
            }
            
            // Deduct resources
            gameState.resources.researchPoints -= gameState.research.nextDiscoveryCost;
            
            // Generate a new research project
            const newResearch = generateResearch();
            
            // Add to available research
            gameState.research.available.push(newResearch);
            
            // Increment discovery count
            gameState.research.discoveryCount++;
            
            // Calculate next discovery cost
            gameState.research.nextDiscoveryCost = Math.floor(gameState.research.nextDiscoveryCost * gameState.research.costMultiplier);
            
            // Show the new research modal
            showNewResearchModal(newResearch);
            
            // Update UI
            updateUI();
        }
        
        // Discover new relic
        function discoverNewRelic() {
            // Check if player has enough QF
            if (gameState.resources.quantumFragments < 50) {
                showNotification('Not enough Quantum Fragments to search for a relic.', 'error');
                return;
            }
            
            // Deduct QF
            gameState.resources.quantumFragments -= 50;
            
            // Generate a new relic
            const newRelic = generateRelic();
            
            // Add to discovered relics
            gameState.relics.discovered.push(newRelic);
            
            // Increment relic collection counter
            if (gameState.relics.collections[newRelic.collection]) {
                gameState.relics.collections[newRelic.collection].discovered++;
            }
            
            // Update stats
            gameState.stats.relicsFound++;
            
            // Show the new relic modal
            showNewRelicModal(newRelic);
            
            // Update UI
            updateUI();
        }
        
        // Select a galaxy system to view details
        function selectGalaxySystem(system) {
            // Show system details panel
            const detailsPanel = document.getElementById('system-details-panel');
            detailsPanel.classList.remove('hidden');
            
            // Update system details
            document.getElementById('selected-system-name').textContent = system.name;
            document.getElementById('selected-system-type').textContent = capitalizeFirstLetter(system.type);
            document.getElementById('selected-system-description').textContent = system.description;
            document.getElementById('selected-system-coordinates').textContent = `(${system.coordinates.x}, ${system.coordinates.y})`;
            document.getElementById('selected-system-planets').textContent = system.planets.length;
            document.getElementById('selected-system-rarity').textContent = capitalizeFirstLetter(system.rarity);
            
            // Update establish outpost button
            const outpostBtn = document.getElementById('establish-outpost-btn');
            if (system.outpostEstablished) {
                outpostBtn.textContent = 'Outpost Established';
                outpostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.remove('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = true;
            } else {
                const cost = calculateOutpostCost(system);
                outpostBtn.textContent = `Establish Outpost (${cost} INF)`;
                outpostBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.add('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = false;
                
                // Add event listener
                outpostBtn.onclick = () => establishOutpost(system);
            }
            
            // Populate planets list
            const planetsList = document.getElementById('system-planets-list');
            planetsList.innerHTML = '';
            
            system.planets.forEach(planet => {
                const planetElement = document.createElement('div');
                planetElement.className = 'p-2 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600';
                
                let bonusText = '';
                if (planet.bonuses && planet.bonuses.length > 0) {
                    bonusText = planet.bonuses.map(bonus => {
                        return bonus.description || `${bonus.type}: ${bonus.value}`;
                    }).join('<br>');
                }
                
                planetElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h5 class="font-medium text-gray-900 dark:text-gray-100">${planet.name}</h5>
                        ${planet.colonized ? 
                            '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-0.5 rounded">Colonized</span>' : 
                            '<button class="text-xs bg-galaxy hover:bg-indigo-700 text-white px-2 py-0.5 rounded colonize-planet-btn" data-planet-id="' + planet.id + '">Colonize</button>'
                        }
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${planet.description || 'A planet waiting to be explored and studied.'}</p>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1">
                        <span class="font-medium">Bonuses:</span><br>
                        ${bonusText || 'None discovered yet'}
                    </div>
                `;
                
                planetsList.appendChild(planetElement);
            });
            
            // Add event listeners to colonize buttons
            document.querySelectorAll('.colonize-planet-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const planetId = btn.dataset.planetId;
                    colonizePlanet(system, planetId);
                });
            });
        }
        
        // Establish an outpost in a star system
        function establishOutpost(system) {
            const cost = calculateOutpostCost(system);
            
            if (gameState.resources.influence < cost) {
                showNotification('Not enough Influence to establish an outpost.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= cost;
            
            // Update system
            system.outpostEstablished = true;
            gameState.galaxy.stats.outpostsEstablished++;
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            renderGalaxySystems();
            
            showNotification(`Outpost established in ${system.name}!`, 'success');
        }
        
        // Colonize a planet in a system
        function colonizePlanet(system, planetId) {
            // Find the planet
            const planet = system.planets.find(p => p.id === planetId);
            if (!planet) return;
            
            // Check if outpost is established
            if (!system.outpostEstablished) {
                showNotification('You must establish an outpost before colonizing planets.', 'error');
                return;
            }
            
            // Update planet status
            planet.colonized = true;
            gameState.galaxy.stats.planetsColonized++;
            
            // Add planet to active planets list
            gameState.galaxy.activePlanets.push({
                systemId: system.id,
                planetId: planet.id,
                systemName: system.name,
                planetName: planet.name,
                bonuses: planet.bonuses || []
            });
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            updateOutpostsList();
            
            showNotification(`Planet ${planet.name} colonized! You now receive its bonuses.`, 'success');
        }
        
        // Calculate the cost of establishing an outpost
        function calculateOutpostCost(system) {
            // Base cost
            let cost = gameState.galaxy.systemCosts.base;
            
            // Distance factor - further systems cost more
            const distance = Math.sqrt(
                Math.pow(system.coordinates.x, 2) + 
                Math.pow(system.coordinates.y, 2)
            );
            
            cost = Math.round(cost * Math.pow(gameState.galaxy.systemCosts.distanceMultiplier, distance));
            
            // Rarity factor - rarer systems cost more
            const rarityMultipliers = {
                'common': 1,
                'uncommon': 1.5,
                'rare': 2,
                'epic': 3,
                'legendary': 5
            };
            
            cost = Math.round(cost * rarityMultipliers[system.rarity]);
            
            // Apply system cost reduction effects from research and facilities
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'system_cost') {
                            cost = Math.round(cost * (1 - (effect.value / 100)));
                        }
                    });
                }
            });
            
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'system_cost') {
                            cost = Math.round(cost * (1 - (effect.value / 100)));
                        }
                    });
                }
            });
            
            return Math.max(10, cost); // Minimum cost of 10
        }
        
        // Zoom the galaxy map
        function zoomGalaxyMap(zoomChange) {
            // Update zoom level, keeping it within bounds
            gameState.galaxy.zoomLevel = Math.max(0.5, Math.min(3, gameState.galaxy.zoomLevel + zoomChange));
            
            // Re-render systems and update exploration radius
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Center the galaxy map on home
        function centerGalaxyMap() {
            gameState.galaxy.viewCenter = { x: 0, y: 0 };
            
            // Re-render systems
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Add drag functionality to the map
        function addMapDragFunctionality() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            let isDragging = false;
            let startX, startY;
            let startViewX, startViewY;
            
            mapContainer.addEventListener('mousedown', (e) => {
                // Only enable dragging with left mouse button
                if (e.button !== 0) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                // Change cursor
                mapContainer.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.style.cursor = 'default';
                }
            });
            
            // Prevent default behavior for right-click on the map
            mapContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Touch support for mobile devices
            mapContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return; // Only handle single touch
                
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.touches[0].clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.touches[0].clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // Explore a random system in the exploration range
        function exploreRandomSystem() {
            // Check if there's already an active expedition
            if (gameState.galaxy.activeExpedition) {
                showNotification('There is already an expedition in progress.', 'info');
                return;
            }
            
            // Check if player has enough influence
            if (gameState.resources.influence < gameState.galaxy.nextSystemCost) {
                showNotification('Not enough Influence to explore a new system.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= gameState.galaxy.nextSystemCost;
            
            // Start expedition
            gameState.galaxy.activeExpedition = {
                startTime: Date.now(),
                duration: 30000, // 30 seconds
                progress: 0
            };
            
            // Show expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.remove('hidden');
            
            // Start expedition progress
            updateExpeditionStatus();
            
            // Update UI
            updateUI();
            
            // Increase next system cost
            gameState.galaxy.nextSystemCost = Math.floor(gameState.galaxy.nextSystemCost * 1.1);
            
            showNotification('Expedition launched! Your literary explorers are venturing into the unknown...', 'info');
        }
        
        // Complete an expedition and discover a new system
        function completeExpedition() {
            // Clear active expedition
            gameState.galaxy.activeExpedition = null;
            
            // Hide expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.add('hidden');
            
            // Generate a new star system
            const newSystem = generateRandomSystem();
            
            // Add system to discovered systems
            gameState.galaxy.discoveredSystems[newSystem.id] = newSystem;
            gameState.galaxy.stats.systemsDiscovered++;
            gameState.stats.systemsDiscovered++;
            
            // Update UI
            updateUI();
            renderGalaxySystems();
            
            // Show discovery modal
            showDiscoveryModal(newSystem);
            
            // Small chance to find a relic while exploring
            let relicChance = 0.10; // Base 10% chance
            
            // Apply relic discovery chance bonuses
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'relic_chance') {
                            relicChance += effect.value / 100;
                        }
                    });
                }
            });
            
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'relic_chance') {
                            relicChance += effect.value / 100;
                        }
                    });
                }
            });
            
            if (Math.random() < relicChance) {
                // Generate a new relic
                const newRelic = generateRelic();
                
                // Add to discovered relics
                gameState.relics.discovered.push(newRelic);
                
                // Increment relic collection counter
                if (gameState.relics.collections[newRelic.collection]) {
                    gameState.relics.collections[newRelic.collection].discovered++;
                }
                
                // Update stats
                gameState.stats.relicsFound++;
                
                // Show the relic found notification
                setTimeout(() => {
                    showNewRelicModal(newRelic);
                }, 1000);
            }
        }
        
        // Generate a random star system
        function generateRandomSystem() {
            // Generate random coordinates within exploration range
            let x, y, distance;
            const maxAttempts = 20;
            let attempts = 0;
            
            // Keep trying until we find coordinates that aren't too close to existing systems
            do {
                // Random angle
                const angle = Math.random() * Math.PI * 2;
                
                // Random distance within exploration range
                const randomFactor = 0.3 + Math.random() * 0.7; // 30-100% of max range
                distance = gameState.galaxy.explorationRange * randomFactor;
                
                // Calculate coordinates
                x = Math.round(Math.cos(angle) * distance * 10) / 10;
                y = Math.round(Math.sin(angle) * distance * 10) / 10;
                
                // Check if too close to existing systems
                const tooClose = Object.values(gameState.galaxy.discoveredSystems).some(system => {
                    const dx = system.coordinates.x - x;
                    const dy = system.coordinates.y - y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    return dist < 0.5; // Minimum distance between systems
                });
                
                if (!tooClose) break;
                attempts++;
            } while (attempts < maxAttempts);
            
            // Pick a random system type
            const systemType = getRandomElement(gameConfig.galaxy.systemTypes);
            
            // Weighted random rarity
            const rarityChoice = weightedRandomFromArray(gameConfig.galaxy.systemRarities);
            
            // Generate system name
            const name = generateSystemName();
            
            // Generate system description
            const description = generateSystemDescription(systemType, rarityChoice);
            
            // Determine number of planets based on rarity
            const planetCounts = {
                'common': 1 + Math.floor(Math.random() * 2), // 1-2
                'uncommon': 2 + Math.floor(Math.random() * 2), // 2-3
                'rare': 3 + Math.floor(Math.random() * 2), // 3-4
                'epic': 4 + Math.floor(Math.random() * 2), // 4-5
                'legendary': 5 // Always 5
            };
            
            const numPlanets = planetCounts[rarityChoice];
            
            // Generate planets
            const planets = [];
            for (let i = 0; i < numPlanets; i++) {
                planets.push(generatePlanet(x, y, i, systemType, rarityChoice));
            }
            
            // Create the system object
            return {
                id: `system-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                name: name,
                coordinates: { x, y },
                type: systemType,
                rarity: rarityChoice,
                discovered: true,
                outpostEstablished: false,
                description: description,
                planets: planets
            };
        }
        
        // Generate a planet for a star system
        function generatePlanet(systemX, systemY, index, systemType, systemRarity) {
            // Generate planet name
            const name = generatePlanetName(systemType);
            
            // Generate planet description
            const description = generatePlanetDescription(systemType, systemRarity);
            
            // Generate bonuses based on system type and rarity
            const bonuses = generatePlanetBonuses(systemType, systemRarity);
            
            // Create the planet object
            return {
                id: `planet-${systemX}-${systemY}-${index}`,
                name: name,
                description: description,
                bonuses: bonuses,
                colonized: false
            };
        }
        
        // Generate a name for a star system
        function generateSystemName() {
            const prefixes = [
                "Alpha", "Beta", "Gamma", "Delta", "Zeta", "Theta", "Iota", "Kappa", "Lambda", "Mu",
                "Omicron", "Sigma", "Tau", "Upsilon", "Phi", "Chi", "Psi", "Omega", "Vega", "Antares",
                "Lyra", "Nova", "Cygnus", "Orion", "Andromeda", "Perseus", "Cassiopeia", "Sirius", "Canopus", "Arcturus",
                "Polaris", "Rigel", "Procyon", "Altair", "Deneb", "Regulus", "Spica", "Pollux", "Fomalhaut", "Betelgeuse",
                "Lexicon", "Archive", "Codex", "Compendium", "Grimoire", "Opus", "Chronicle", "Atlas", "Folio", "Quill",
                "Saga", "Verse", "Sonnet", "Stanza", "Canon", "Appendix", "Index", "Volume", "Anthology", "Manuscript",
                "Cosmos", "Quantum", "Nexus", "Parallax", "Enigma", "Paradox", "Zenith", "Apogee", "Eclipse", "Horizon",
"Pulsar", "Quasar", "Photon", "Neutron", "Stellar", "Celestial"
            ];
            
            const suffixes = [
                "Prime", "Major", "Minor", "Maxima", "Proxima", "Ultima", "Core", "Centauri", "Terminus",
                "Nebula", "Cluster", "Sector", "Quadrant", "System", "Complex", "Array", "Expanse", "Void", "Reach",
                "Archive", "Library", "Repository", "Compendium", "Collection", "Anthology", "Index", "Lexicon", "Chronicle",
                "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X",
                "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Theta", "Omega"
            ];
            
            // Choose name pattern
            const rand = Math.random();
            let name;
            
            if (rand < 0.25) {
                // Just prefix
                name = getRandomElement(prefixes);
            } else if (rand < 0.5) {
                // Prefix + Suffix
                name = `${getRandomElement(prefixes)} ${getRandomElement(suffixes)}`;
            } else if (rand < 0.75) {
                // Prefix + Number
                name = `${getRandomElement(prefixes)} ${Math.floor(Math.random() * 1000)}`;
            } else {
                // Prefix-Suffix
                name = `${getRandomElement(prefixes)}-${getRandomElement(suffixes)}`;
            }
            
            return name;
        }
        
        // Generate a description for a star system
        function generateSystemDescription(type, rarity) {
            const typeDescriptions = {
                fiction: [
                    "A nexus of fictional narratives and story constructs.",
                    "A system where the borders between reality and fiction blur continuously.",
                    "Inhabited by manifestations of literary archetypes and fictional tropes."
                ],
                academic: [
                    "A system dominated by precise logical structures and theoretical frameworks.",
                    "A collection of planets devoted to the preservation and analysis of knowledge.",
                    "A place where empirical observation and scholarly debate shape reality itself."
                ],
                historical: [
                    "A system where echoes of past events continue to reverberate across time.",
                    "Planets that preserve different eras and civilizations in meticulous detail.",
                    "A nexus of temporal currents, allowing for the study of historical cause and effect."
                ],
                experimental: [
                    "A system where the rules of literary reality are constantly being rewritten.",
                    "Planets occupied by avant-garde narrative structures and unconventional syntax.",
                    "A place where experimental prose forms have manifested as physical landscapes."
                ],
                metaphysical: [
                    "A system existing in the realm between concrete reality and abstract concept.",
                    "Planets that embody philosophical principles and metaphysical paradoxes.",
                    "A nexus where questions of being, knowing, and meaning take physical form."
                ]
            };
            
            const rarityDescriptions = {
                common: "A relatively stable and accessible system with standard literary properties.",
                uncommon: "A system with notable peculiarities and moderately rare narrative elements.",
                rare: "A remarkably uncommon system containing valuable literary constructs and rare conceptual resources.",
                epic: "An extraordinary system harboring powerful narrative forces and remarkable literary phenomena.",
                legendary: "A truly mythical system of immense power and importance in the literary cosmos."
            };
            
            // Select a random type description and add the rarity description
            const typeDesc = getRandomElement(typeDescriptions[type] || ["A system of unknown literary classification."]);
            const rarityDesc = rarityDescriptions[rarity] || "";
            
            return `${rarityDesc} ${typeDesc}`;
        }
        
        // Generate a planet name
        function generatePlanetName(systemType) {
            const prefixes = [
                "Lexica", "Biblio", "Litera", "Prosa", "Versa", "Scripta", "Narratum", "Chronica", "Cognita", "Sententia",
                "Nova", "Stellar", "Cosmo", "Astro", "Aether", "Nebula", "Pulsar", "Quasar", "Orbital", "Celestia",
                "Helio", "Lunar", "Solar", "Terran", "Vega", "Antares", "Echo", "Lumina", "Aurora", "Zenith",
                "Meridian", "Horizon", "Infinity", "Parallax", "Apogee", "Chronicle", "Saga", "Lexicon", "Compendium", "Atlas",
                "Opus", "Codex", "Grimoire", "Tome", "Libri", "Volumen", "Bibliotheca", "Arcanum", "Memoria", "Enigma"
            ];
            
            const suffixes = [
                "Prime", "Alpha", "Beta", "Gamma", "Major", "Minor", "Maxima", "Proxima", "Ultima", "Core",
                "Centauri", "Terminus", "Nexus", "Locus", "Vertex", "Apex", "Nadir", "Primordial", "Archive", "Library",
                "Repository", "Compendium", "Collection", "Anthology", "Index", "Lexicon", "Chronicle", "IX", "IV", "VI",
                "III", "II", "I", "VII", "VIII", "X"
            ];
            
            // Type-specific prefixes
            const typeSpecificPrefixes = {
                fiction: ["Narratia", "Fabulosa", "Fictum", "Mythos", "Epica", "Novella"],
                academic: ["Academica", "Scholastica", "Theorica", "Empirica", "Logica", "Analytica"],
                historical: ["Chronica", "Historia", "Memora", "Annala", "Tempus", "Epocha"],
                experimental: ["Avantia", "Abstracta", "Surrealia", "Dadaica", "Futura", "Moderna"],
                metaphysical: ["Metaphysica", "Philosophica", "Ethica", "Ontologia", "Existentia", "Transcendia"]
            };
            
            // Add type-specific prefixes to the pool
            const expandedPrefixes = [...prefixes];
            if (typeSpecificPrefixes[systemType]) {
                expandedPrefixes.push(...typeSpecificPrefixes[systemType]);
            }
            
            // Choose a prefix and suffix
            const prefix = getRandomElement(expandedPrefixes);
            const suffix = getRandomElement(suffixes);
            
            // Pattern selection
            const rand = Math.random();
            if (rand < 0.33) {
                return `${prefix} ${suffix}`;
            } else if (rand < 0.66) {
                return `${prefix}-${suffix}`;
            } else {
                return prefix;
            }
        }
        
        // Generate a planet description
        function generatePlanetDescription(systemType, systemRarity) {
            const descriptions = {
                fiction: [
                    "A world where fictional narratives have taken physical form, populated by literary archetypes.",
                    "Landscapes formed from the building blocks of stories and the essence of character development.",
                    "A planet where metaphor and symbolism have tangible effects on the physical environment."
                ],
                academic: [
                    "A world dedicated to the rigorous categorization and analysis of literary knowledge.",
                    "Terrain shaped by the structure of academic discourse and scholarly debate.",
                    "A planet where empirical observation and theoretical modeling coexist in perfect balance."
                ],
                historical: [
                    "A chronicle-world preserving the essence of literary movements throughout time.",
                    "Landscapes that shift through different literary periods, each preserved in remarkable detail.",
                    "A planetary record of creative evolution, from oral traditions to digital hypertext."
                ],
                experimental: [
                    "A world of constantly shifting narrative rules and experimental textual structures.",
                    "Landscapes formed from avant-garde prose techniques and unconventional syntax.",
                    "A planet where literary conventions are continuously deconstructed and reassembled."
                ],
                metaphysical: [
                    "A philosophical world where abstract concepts manifest as physical features.",
                    "Terrain shaped by the interplay between meaning, interpretation, and ontological uncertainty.",
                    "A planet existing simultaneously as text, subtext, and metatext."
                ]
            };
            
            const rarityEnhancements = {
                common: "This world offers basic resources for reading enhancement.",
                uncommon: "A notable source of literary insight and conceptual resources.",
                rare: "A remarkably potent world with rare and valuable literary properties.",
                epic: "An extraordinary planet containing powerful narrative energy and unique properties.",
                legendary: "A truly mythical world of immense power in the literary cosmos."
            };
            
            // Select a random description and add the rarity enhancement
            const descArray = descriptions[systemType] || [
                "A planet of indeterminate literary classification.",
                "A world containing various textual properties and narrative elements.",
                "A sphere of potential meaning waiting to be explored."
            ];
            
            const baseDesc = getRandomElement(descArray);
            const rarityEnhancement = rarityEnhancements[systemRarity] || "";
            
            return `${baseDesc} ${rarityEnhancement}`;
        }
        
        // Generate bonuses for a planet
        function generatePlanetBonuses(systemType, systemRarity) {
            // Select number of bonuses based on rarity
            const bonusCounts = {
                common: 1,
                uncommon: Math.random() < 0.7 ? 1 : 2, // 70% chance for 1, 30% for 2
                rare: Math.random() < 0.3 ? 1 : 2, // 30% chance for 1, 70% for 2
                epic: 2,
                legendary: Math.random() < 0.7 ? 2 : 3 // 70% chance for 2, 30% for 3
            };
            
            const numBonuses = bonusCounts[systemRarity] || 1;
            
            // Define system type specific bonus types
            const typeSpecificBonuses = {
                fiction: ['kp_per_page', 'completion_bonus', 'genre_bonus'],
                academic: ['rp_generation', 'research_cost', 'xp_gain'],
                historical: ['inf_gain', 'passive_inf', 'facility_cost'],
                experimental: ['kp_per_minute', 'passive_kp', 'passive_rp'],
                metaphysical: ['qf_gain', 'passive_qf', 'relic_chance']
            };
            
            // Create a pool of possible bonus types
            let bonusPool = [];
            
            // Add type-specific bonus types with higher weight
            if (typeSpecificBonuses[systemType]) {
                for (let i = 0; i < 3; i++) { // Add 3 copies for higher weight
                    bonusPool = bonusPool.concat(typeSpecificBonuses[systemType]);
                }
            }
            
            // Add general bonus types
            const generalBonusTypes = [
                'kp_per_page', 'kp_per_minute', 'rp_generation', 'inf_gain', 'xp_gain',
                'qf_gain', 'completion_bonus', 'offline_progress', 'passive_kp', 'passive_rp'
            ];
            bonusPool = bonusPool.concat(generalBonusTypes);
            
            // Generate bonuses
            const bonuses = [];
            for (let i = 0; i < numBonuses; i++) {
                if (bonusPool.length === 0) break;
                
                // Pick a random bonus type
                const bonusIndex = Math.floor(Math.random() * bonusPool.length);
                const bonusType = bonusPool.splice(bonusIndex, 1)[0];
                
                // Get bonus details
                const bonusTypeInfo = gameConfig.effectTypes.find(e => e.type === bonusType) || {
                    type: bonusType,
                    max: 20,
                    isPercentage: true,
                    desc: `${bonusType}: {value}`
                };
                
                // Calculate value based on rarity
                const rarityMultipliers = {
                    common: 0.3,
                    uncommon: 0.5,
                    rare: 0.7,
                    epic: 0.85,
                    legendary: 1.0
                };
                
                const multiplier = rarityMultipliers[systemRarity] || 0.5;
                
                // Calculate bonus value
                let value;
                if (bonusTypeInfo.isPercentage) {
                    // For percentage bonuses, use a range based on max value and rarity
                    value = Math.floor((0.3 + Math.random() * 0.7) * bonusTypeInfo.max * multiplier);
                    // Ensure minimum value of at least 3% for percentage bonuses
                    value = Math.max(3, value);
                } else {
                    // For direct value bonuses (like passive generation)
                    if (bonusTypeInfo.max < 1) {
                        // For values less than 1 (like 0.5 passive resources), use one decimal
                        value = Math.round((0.3 + Math.random() * 0.7) * bonusTypeInfo.max * multiplier * 10) / 10;
                        // Ensure minimum value of 0.1
                        value = Math.max(0.1, value);
                    } else {
                        // For integer values
                        value = Math.floor((0.3 + Math.random() * 0.7) * bonusTypeInfo.max * multiplier);
                        // Ensure minimum value of 1
                        value = Math.max(1, value);
                    }
                }
                
                // Create the bonus
                bonuses.push({
                    type: bonusType,
                    value: value,
                    description: bonusTypeInfo.desc.replace('{value}', value)
                });
            }
            
            return bonuses;
        }
        
        // Force unlock the galaxy feature
        function forceUnlockGalaxy() {
            if (gameState.resources.influence < 100) {
                showNotification('You need 100 Influence to unlock the galaxy.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= 100;
            
            // Unlock galaxy
            gameState.galaxy.unlocked = true;
            
            // Update UI
            updateUI();
            
            // Initialize galaxy map
            initializeGalaxyMap();
            
            showNotification('You have unlocked the Literary Galaxy!', 'success');
        }
        
        // ==========================================
        // GAME DATA MANAGEMENT
        // ==========================================
        
        // Save game to localStorage
        function saveGame() {
            // Update last saved timestamp
            gameState.lastSaved = Date.now();
            
            try {
                // Convert game state to string
                const saveData = JSON.stringify(gameState);
                
                // Save to localStorage
                localStorage.setItem('stellarBibliophile2_saveData', saveData);
                
                // Update last saved display
                const lastSavedElement = document.getElementById('last-saved');
                if (lastSavedElement) {
                    lastSavedElement.textContent = 'Last saved: ' + new Date().toLocaleTimeString();
                }
                
                return true;
            } catch (error) {
                console.error('Error saving game:', error);
                showNotification('Failed to save game: ' + error.message, 'error');
                return false;
            }
        }
        
        // Load game from localStorage
        function loadGame() {
            try {
                // Get save data from localStorage
                const saveData = localStorage.getItem('stellarBibliophile2_saveData');
                
                if (!saveData) {
                    return false;
                }
                
                // Parse save data
                const loadedState = JSON.parse(saveData);
                
                // Validate version compatibility
                if (!loadedState.version) {
                    showNotification('Invalid save data: missing version information', 'error');
                    return false;
                }
                
                // Patch any missing properties
                patchGameState(loadedState);
                
                // Apply the loaded state
                Object.assign(gameState, loadedState);
                
                // Update last played time
                gameState.lastPlayed = Date.now();
                
                // Calculate offline progress if enabled
                if (gameState.settings.offlineProgress) {
                    calculateOfflineProgress();
                }
                
                // Update UI
                updateUI();
                
                // Update last saved display
                const lastSavedElement = document.getElementById('last-saved');
                if (lastSavedElement && gameState.lastSaved) {
                    lastSavedElement.textContent = 'Last saved: ' + new Date(gameState.lastSaved).toLocaleTimeString();
                }
                
                return true;
            } catch (error) {
                console.error('Error loading game:', error);
                showNotification('Failed to load game: ' + error.message, 'error');
                return false;
            }
        }
        
        // Patch any missing properties in loaded game state
        function patchGameState(loadedState) {
            // Validate and patch settings
            if (!loadedState.settings) {
                loadedState.settings = gameState.settings;
            } else {
                // Ensure all settings exist
                for (const key in gameState.settings) {
                    if (loadedState.settings[key] === undefined) {
                        loadedState.settings[key] = gameState.settings[key];
                    }
                }
            }
            
            // Validate and patch resources
            if (!loadedState.resources) {
                loadedState.resources = gameState.resources;
            } else {
                // Ensure all resources exist
                for (const key in gameState.resources) {
                    if (loadedState.resources[key] === undefined) {
                        loadedState.resources[key] = gameState.resources[key];
                    }
                }
            }
            
            // Patch other essential structures
            if (!loadedState.facilities) loadedState.facilities = gameState.facilities;
            if (!loadedState.facilities.available) loadedState.facilities.available = [];
            if (!loadedState.facilities.built) loadedState.facilities.built = [];
            
            if (!loadedState.research) loadedState.research = gameState.research;
            if (!loadedState.research.available) loadedState.research.available = [];
            if (!loadedState.research.completed) loadedState.research.completed = [];
            
            if (!loadedState.relics) loadedState.relics = gameState.relics;
            if (!loadedState.relics.discovered) loadedState.relics.discovered = [];
            
            if (!loadedState.galaxy) loadedState.galaxy = gameState.galaxy;
            if (!loadedState.galaxy.discoveredSystems) loadedState.galaxy.discoveredSystems = {};
            if (!loadedState.galaxy.activePlanets) loadedState.galaxy.activePlanets = [];
            
            if (!loadedState.prestige) loadedState.prestige = gameState.prestige;
            if (!loadedState.lifetimeStats) loadedState.lifetimeStats = gameState.lifetimeStats;
            
            // Ensure the version is updated to current
            loadedState.version = GAME_VERSION;
        }
        
        // Export save data to text
        function exportSaveData() {
            try {
                // Get current game state
                const saveData = JSON.stringify(gameState);
                
                // Encode with base64 for safer copying
                const encodedData = btoa(saveData);
                
                // Show in export modal
                document.getElementById('export-save-text').value = encodedData;
                document.getElementById('save-export-modal').classList.remove('hidden');
                document.getElementById('save-export-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
                
                return encodedData;
            } catch (error) {
                console.error('Error exporting save data:', error);
                showNotification('Failed to export save data: ' + error.message, 'error');
                return null;
            }
        }
        
        // Import save data from text
        function importSaveData(encodedData) {
            if (!encodedData) {
                showNotification('No save data provided.', 'error');
                return false;
            }
            
            try {
                // Decode the base64 data
                const saveData = atob(encodedData);
                
                // Parse the JSON
                const loadedState = JSON.parse(saveData);
                
                // Validate basic structure
                if (!loadedState.version) {
                    showNotification('Invalid save data format.', 'error');
                    return false;
                }
                
                // Patch any missing properties
                patchGameState(loadedState);
                
                // Apply the loaded state
                Object.assign(gameState, loadedState);
                
                // Update UI
                updateUI();
                
                // Save to localStorage
                saveGame();
                
                showNotification('Save data imported successfully!', 'success');
                return true;
            } catch (error) {
                console.error('Error importing save data:', error);
                showNotification('Failed to import save data: ' + error.message, 'error');
                return false;
            }
        }
        
        // Reset game state
        function resetGame() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                // Create a fresh game state
                Object.assign(gameState, {
                    version: GAME_VERSION,
                    lastSaved: null,
                    lastPlayed: Date.now(),
                    settings: {
                        autoSave: true,
                        showNotifications: true,
                        offlineProgress: true,
                        animationEffects: true
                    },
                    player: {
                        level: 1,
                        experiencePoints: 0,
                        experienceToNextLevel: 100
                    },
                    resources: {
                        knowledgePoints: 50,
                        researchPoints: 0,
                        influence: 0,
                        quantumFragments: 0
                    },
                    facilities: {
                        available: [],
                        built: [],
                        discoveryCount: 0,
                        nextDiscoveryCost: { kp: 100, rp: 20 },
                        costMultiplier: 1.2
                    },
                    research: {
                        available: [],
                        completed: [],
                        discoveryCount: 0,
                        nextDiscoveryCost: 75,
                        costMultiplier: 1.25
                    },
                    stats: {
                        booksCompleted: 0,
                        pagesRead: 0,
                        minutesRead: 0,
                        totalKpGenerated: 0,
                        facilitiesBuilt: 0,
                        researchCompleted: 0,
                        systemsDiscovered: 0,
                        relicsFound: 0,
                        genreDistribution: {
                            'sci-fi': 0,
                            'fantasy': 0,
                            'non-fiction': 0,
                            'mystery': 0,
                            'history': 0,
                            'science': 0,
                            'biography': 0,
                            'philosophy': 0,
                            'poetry': 0,
                            'comic': 0,
                            'custom': {}
                        }
                    },
                    currentBooks: [],
                    galaxy: {
                        unlocked: false,
                        discoveredSystems: {},
                        currentCoordinates: { x: 0, y: 0 },
                        viewCenter: { x: 0, y: 0 },
                        explorationRange: 3,
                        zoomLevel: 1,
                        nextSystemCost: 25,
                        systemCosts: {
                            base: 25,
                            distanceMultiplier: 1.2
                        },
                        activePlanets: [],
                        activeExpedition: null,
                        stats: {
                            systemsDiscovered: 0,
                            outpostsEstablished: 0,
                            planetsColonized: 0,
                            expeditionsCompleted: 0,
                            rarePlanetsFound: 0
                        }
                    },
                    relics: {
                        discovered: [],
                        collections: {
                            "Scholar's Artifacts": { 
                                total: 4, 
                                discovered: 0, 
                                bonus: "Increases Knowledge Points gained by 25%"
                            },
                            "Cosmic Archives": { 
                                total: 5, 
                                discovered: 0, 
                                bonus: "Increases Research Points generation by 30%"
                            },
                            "Astral Fragments": { 
                                total: 3, 
                                discovered: 0, 
                                bonus: "Increases Influence gained by 20%"
                            },
                            "Temporal Paradoxes": { 
                                total: 4, 
                                discovered: 0, 
                                bonus: "Increases Quantum Fragment acquisition by 40%"
                            },
                            "Lost Library": { 
                                total: 5, 
                                discovered: 0, 
                                bonus: "Gain 2 Knowledge Points per second passively"
                            },
                            "Interdimensional Tomes": { 
                                total: 3, 
                                discovered: 0, 
                                bonus: "Retain an additional facility after ascension"
                            }
                        }
                    },
                    prestige: {
                        unlocked: true,
                        level: 0,
                        enlightenmentPoints: 0,
                        totalEnlightenmentEarned: 0,
                        permanentUpgrades: [
                            {
                                id: "resource_production",
                                name: "Resource Production",
                                description: "Permanently increases all resource production rates.",
                                level: 0,
                                maxLevel: Infinity,
                                baseCost: 5,
                                costMultiplier: 1.5,
                                effect: {
                                    type: "production_multiplier",
                                    value: 10,
                                    diminishingReturns: {
                                        threshold: 10,
                                        factor: 0.5
                                    }
                                }
                            },
                            {
                                id: "starting_resources",
                                name: "Starting Resources",
                                description: "Begin each prestige run with more resources.",
                                level: 0,
                                maxLevel: Infinity,
                                baseCost: 5,
                                costMultiplier: 1.4,
                                effect: {
                                    type: "starting_resources",
                                    kp: 25,
                                    rp: 10,
                                    diminishingReturns: {
                                        threshold: 10,
                                        factor: 0.75
                                    }
                                }
                            },
                            {
                                id: "reading_efficiency",
                                name: "Reading Efficiency",
                                description: "Permanently increases knowledge gained from reading.",
                                level: 0,
                                maxLevel: Infinity,
                                baseCost: 10,
                                costMultiplier: 1.4,
                                effect: {
                                    type: "reading_efficiency",
                                    value: 15,
                                    diminishingReturns: {
                                        threshold: 8,
                                        factor: 0.7
                                    }
                                }
                            },
                            {
                                id: "xp_boost",
                                name: "Experience Boost",
                                description: "Permanently increases experience gained from all sources.",
                                level: 0,
                                maxLevel: Infinity,
                                baseCost: 8,
                                costMultiplier: 1.5,
                                effect: {
                                    type: "xp_boost",
                                    value: 12,
                                    diminishingReturns: {
                                        threshold: 10,
                                        factor: 0.6
                                    }
                                }
                            },
                            {
                                id: "auto_research",
                                name: "Auto Research",
                                description: "Automatically research basic technologies after prestige.",
                                level: 0,
                                maxLevel: 10,
                                baseCost: 15,
                                costMultiplier: 1.6,
                                effect: {
                                    type: "auto_research",
                                    value: 1
                                }
                            },
                            {
                                id: "facility_retention",
                                name: "Facility Retention",
                                description: "Retain facilities after prestige.",
                                level: 0,
                                maxLevel: 10,
                                baseCost: 20,
                                costMultiplier: 1.8,
                                effect: {
                                    type: "facility_retention",
                                    value: 1
                                }
                            },
                            {
                                id: "quantum_efficiency",
                                name: "Quantum Efficiency",
                                description: "Retain more Quantum Fragments after prestige.",
                                level: 0,
                                maxLevel: 5,
                                baseCost: 12,
                                costMultiplier: 2.0,
                                effect: {
                                    type: "quantum_retention",
                                    value: 5
                                }
                            },
                            {
                                id: "enlightened_reading",
                                name: "Enlightened Reading",
                                description: "Gain Quantum Fragments while reading.",
                                level: 0,
                                maxLevel: Infinity,
                                baseCost: 18,
                                costMultiplier: 1.7,
                                effect: {
                                    type: "reading_quantum",
                                    value: 0.1,
                                    diminishingReturns: {
                                        threshold: 5,
                                        factor: 0.8
                                    }
                                }
                            }
                        ]
                    },
                    lifetimeStats: {
                        totalPrestiges: 0,
                        maxLevel: 1,
                        maxBooks: 0,
                        totalEnlightenmentPoints: 0
                    }
                });
                
                // Update UI
                updateUI();
                
                // Save to localStorage
                saveGame();
                
                showNotification('Game has been reset.', 'success');
            }
        }
        
        // Perform prestige
        function performPrestige() {
            // Calculate EP to be gained
            const epFromLevel = Math.floor(gameState.player.level * gameConfig.epCalculation.levelFactor);
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameConfig.epCalculation.bookFactor);
            const epFromResearch = Math.floor(gameState.research.completed.length * gameConfig.epCalculation.researchFactor);
            
            const totalEpGain = epFromLevel + epFromBooks + epFromResearch;
            
            // Update enlightenment points
            gameState.prestige.enlightenmentPoints += totalEpGain;
            gameState.prestige.totalEnlightenmentEarned += totalEpGain;
            gameState.lifetimeStats.totalEnlightenmentPoints += totalEpGain;
            
            // Update lifetime stats
            gameState.lifetimeStats.totalPrestiges++;
            gameState.lifetimeStats.maxLevel = Math.max(gameState.lifetimeStats.maxLevel, gameState.player.level);
            gameState.lifetimeStats.maxBooks = Math.max(gameState.lifetimeStats.maxBooks, gameState.stats.booksCompleted);
            
            // Increment prestige level
            gameState.prestige.level++;
            
            // Keep a percentage of Quantum Fragments
            let qfRetentionRate = 0.75; // Base 75% retention
            
            // Apply quantum efficiency upgrade if present
            const quantumEfficiency = gameState.prestige.permanentUpgrades.find(u => u.id === "quantum_efficiency");
            if (quantumEfficiency && quantumEfficiency.level > 0) {
                qfRetentionRate += (quantumEfficiency.effect.value * quantumEfficiency.level) / 100;
                // Cap at 100%
                qfRetentionRate = Math.min(1, qfRetentionRate);
            }
            
            const retainedQF = Math.floor(gameState.resources.quantumFragments * qfRetentionRate);
            
            // Store facilities that should be retained
            const facilitiesToRetain = [];
            
            // Check if facility retention upgrade is present
            const facilityRetention = gameState.prestige.permanentUpgrades.find(u => u.id === "facility_retention");
            if (facilityRetention && facilityRetention.level > 0) {
                // Sort facilities by level (highest first) and then by rarity
                const sortedFacilities = [...gameState.facilities.built].sort((a, b) => {
                    if (a.level !== b.level) return b.level - a.level;
                    
                    const rarityOrder = { legendary: 5, epic: 4, rare: 3, uncommon: 2, common: 1 };
                    return (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0);
                });
                
                // Add top N facilities to retain
                for (let i = 0; i < facilityRetention.level && i < sortedFacilities.length; i++) {
                    facilitiesToRetain.push(sortedFacilities[i]);
                }
            }
            
            // Store relics to retain
            const relicsToRetain = [...gameState.relics.discovered];
            
            // Reset progress
            gameState.player = {
                level: 1,
                experiencePoints: 0,
                experienceToNextLevel: 100
            };
            
            // Calculate starting resources from permanent upgrades
            let startingKP = 50; // Base starting KP
            let startingRP = 0;  // Base starting RP
            
            const startingResourcesUpgrade = gameState.prestige.permanentUpgrades.find(u => u.id === "starting_resources");
            if (startingResourcesUpgrade && startingResourcesUpgrade.level > 0) {
                let kpBonus = startingResourcesUpgrade.effect.kp * startingResourcesUpgrade.level;
                let rpBonus = startingResourcesUpgrade.effect.rp * startingResourcesUpgrade.level;
                
                // Apply diminishing returns if applicable
                if (startingResourcesUpgrade.effect.diminishingReturns && 
                    startingResourcesUpgrade.level > startingResourcesUpgrade.effect.diminishingReturns.threshold) {
                    const normalLevels = startingResourcesUpgrade.effect.diminishingReturns.threshold;
                    const diminishedLevels = startingResourcesUpgrade.level - normalLevels;
                    
                    kpBonus = (startingResourcesUpgrade.effect.kp * normalLevels) + 
                             (startingResourcesUpgrade.effect.kp * diminishedLevels * 
                              startingResourcesUpgrade.effect.diminishingReturns.factor);
                              
                    rpBonus = (startingResourcesUpgrade.effect.rp * normalLevels) + 
                             (startingResourcesUpgrade.effect.rp * diminishedLevels * 
                              startingResourcesUpgrade.effect.diminishingReturns.factor);
                }
                
                startingKP += kpBonus;
                startingRP += rpBonus;
            }
            
            // Apply relic effects to starting resources
            relicsToRetain.forEach(relic => {
                if (relic.effects) {
                    relic.effects.forEach(effect => {
                        if (effect.type === 'starting_kp') startingKP += effect.value;
                        if (effect.type === 'starting_rp') startingRP += effect.value;
                    });
                }
            });
            
            gameState.resources = {
                knowledgePoints: startingKP,
                researchPoints: startingRP,
                influence: 0,
                quantumFragments: retainedQF
            };
            
            gameState.facilities = {
                available: [],
                built: facilitiesToRetain,
                discoveryCount: 0,
                nextDiscoveryCost: { kp: 100, rp: 20 },
                costMultiplier: 1.2
            };
            
            gameState.research = {
                available: [],
                completed: [],
                discoveryCount: 0,
                nextDiscoveryCost: 75,
                costMultiplier: 1.25
            };
            
            // Auto-research if applicable
            const autoResearch = gameState.prestige.permanentUpgrades.find(u => u.id === "auto_research");
            if (autoResearch && autoResearch.level > 0) {
                // TODO: Generate and automatically complete some research based on level
            }
            
            gameState.stats = {
                booksCompleted: 0,
                pagesRead: 0,
                minutesRead: 0,
                totalKpGenerated: 0,
                facilitiesBuilt: facilitiesToRetain.length,
                researchCompleted: 0,
                systemsDiscovered: 0,
                relicsFound: relicsToRetain.length,
                genreDistribution: {
                    'sci-fi': 0,
                    'fantasy': 0,
                    'non-fiction': 0,
                    'mystery': 0,
                    'history': 0,
                    'science': 0,
                    'biography': 0,
                    'philosophy': 0,
                    'poetry': 0,
                    'comic': 0,
                    'custom': {}
                }
            };
            
            gameState.currentBooks = [];
            
            gameState.galaxy = {
                unlocked: false,
                discoveredSystems: {},
                currentCoordinates: { x: 0, y: 0 },
                viewCenter: { x: 0, y: 0 },
                explorationRange: 3,
                zoomLevel: 1,
                nextSystemCost: 25,
                systemCosts: {
                    base: 25,
                    distanceMultiplier: 1.2
                },
                activePlanets: [],
                activeExpedition: null,
                stats: {
                    systemsDiscovered: 0,
                    outpostsEstablished: 0,
                    planetsColonized: 0,
                    expeditionsCompleted: 0,
                    rarePlanetsFound: 0
                }
            };
            
            // Restore relics
            gameState.relics.discovered = relicsToRetain;
            
            // Reset collections to match retained relics
            for (const collection in gameState.relics.collections) {
                gameState.relics.collections[collection].discovered = 0;
            }
            
            // Recount relics by collection
            relicsToRetain.forEach(relic => {
                if (gameState.relics.collections[relic.collection]) {
                    gameState.relics.collections[relic.collection].discovered++;
                }
            });
            
            // Update UI
            updateUI();
            
            // Show notification
            showNotification(`Ascension complete! You gained ${totalEpGain} Enlightenment Points.`, 'enlightenment');
            
            // Save game
            saveGame();
        }
        
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        // Log reading session button
        document.getElementById('log-reading').addEventListener('click', function() {
            const bookTitle = document.getElementById('book-title').value.trim();
            let bookGenre = document.getElementById('book-genre').value;
            let customGenre = '';
            if (bookGenre === 'custom') {
                customGenre = document.getElementById('custom-genre').value.trim();
                if (!customGenre) {
                    showNotification('Please enter a custom genre', 'error');
                    return;
                }
            }
            const bookDifficulty = document.getElementById('book-difficulty').value;
            const pagesRead = parseInt(document.getElementById('pages-read').value) || 0;
            const readingMinutes = parseInt(document.getElementById('reading-minutes').value) || 0;
            
            if (!bookTitle) {
                showNotification('Please enter a book title', 'error');
                return;
            }
            
            if (pagesRead <= 0) {
                showNotification('Please enter a valid number of pages read', 'error');
                return;
            }
            
            if (readingMinutes <= 0) {
                showNotification('Please enter a valid number of reading minutes', 'error');
                return;
            }
            
            // Find if book already exists in current books
            let book = gameState.currentBooks.find(b => b.title.toLowerCase() === bookTitle.toLowerCase());
            
            // Calculate knowledge points
            const knowledgePointsGained = calculateReadingKp(pagesRead, readingMinutes, bookDifficulty);
            
            // Add to stats
            gameState.stats.pagesRead += pagesRead;
            gameState.stats.minutesRead += readingMinutes;
            gameState.stats.totalKpGenerated += knowledgePointsGained;
            
            // Add to resources
            gameState.resources.knowledgePoints += knowledgePointsGained;
            
            // Get chance for Quantum Fragment from reading
            let qfGainChance = 0.05; // Base 5% chance
            let qfAmount = 0;
            
            // Check for enlightened reading upgrade
            const enlightenedReading = gameState.prestige.permanentUpgrades.find(u => u.id === "enlightened_reading");
            if (enlightenedReading && enlightenedReading.level > 0) {
                let bonus = enlightenedReading.effect.value * enlightenedReading.level;
                
                // Apply diminishing returns if applicable
                if (enlightenedReading.effect.diminishingReturns && 
                    enlightenedReading.level > enlightenedReading.effect.diminishingReturns.threshold) {
                    const normalLevels = enlightenedReading.effect.diminishingReturns.threshold;
                    const diminishedLevels = enlightenedReading.level - normalLevels;
                    bonus = (enlightenedReading.effect.value * normalLevels) + 
                            (enlightenedReading.effect.value * diminishedLevels * 
                             enlightenedReading.effect.diminishingReturns.factor);
                }
                
                qfAmount = Math.floor(readingMinutes * bonus * 10) / 10;
                if (qfAmount > 0) {
                    gameState.resources.quantumFragments += qfAmount;
                }
            } else if (Math.random() < qfGainChance) {
                // Random chance for Quantum Fragment
                qfAmount = 1;
                gameState.resources.quantumFragments += qfAmount;
            }
            
            // Generate a very small amount of influence
            const influenceGained = Math.floor(readingMinutes * 0.1);
            if (influenceGained > 0) {
                gameState.resources.influence += influenceGained;
            }
            
            // Add experience
            const expGained = pagesRead * 1 + readingMinutes * 0.5;
            addExperience(expGained);
            
            if (book) {
                // Update existing book
                book.pagesRead += pagesRead;
                book.minutesRead += readingMinutes;
                
                showNotification(`Reading session logged: +${Math.floor(knowledgePointsGained)} KP${qfAmount > 0 ? ', +' + qfAmount + ' QF' : ''}${influenceGained > 0 ? ', +' + influenceGained + ' INF' : ''}`, 'success');
            } else {
                // Create new book
                book = {
                    title: bookTitle,
                    genre: bookGenre,
                    customGenre: customGenre,
                    difficulty: bookDifficulty,
                    pagesRead: pagesRead,
                    minutesRead: readingMinutes
                };
                
                gameState.currentBooks.push(book);
                
                showNotification(`New book started: ${bookTitle}. +${Math.floor(knowledgePointsGained)} KP${qfAmount > 0 ? ', +' + qfAmount + ' QF' : ''}${influenceGained > 0 ? ', +' + influenceGained + ' INF' : ''}`, 'success');
            }
            
            // Update UI
            updateUI();
            
            // Save game
            if (gameState.settings.autoSave) {
                saveGame();
            }
        });
        
        // Complete book button
        document.getElementById('complete-book').addEventListener('click', function() {
            const bookTitle = document.getElementById('book-title').value.trim();
            
            if (!bookTitle) {
                showNotification('Please enter a book title', 'error');
                return;
            }
            
            // Find book in current books
            const bookIndex = gameState.currentBooks.findIndex(b => b.title.toLowerCase() === bookTitle.toLowerCase());
            
            if (bookIndex === -1) {
                showNotification('Book not found in your current reading list', 'error');
                return;
            }
            
            const book = gameState.currentBooks[bookIndex];
            
            // Calculate completion bonus
            const baseKp = calculateReadingKp(book.pagesRead, book.minutesRead, book.difficulty);
            const completionBonus = Math.floor(baseKp * gameConfig.completionBonus);
            
            // Add completion bonus
            gameState.resources.knowledgePoints += completionBonus;
            gameState.stats.totalKpGenerated += completionBonus;
            
            // Add to genre stats
            if (book.genre === 'custom' && book.customGenre) {
                if (!gameState.stats.genreDistribution.custom[book.customGenre]) {
                    gameState.stats.genreDistribution.custom[book.customGenre] = 0;
                }
                gameState.stats.genreDistribution.custom[book.customGenre]++;
            } else {
                gameState.stats.genreDistribution[book.genre]++;
            }
            
            // Generate influence from completing a book
            let influenceGained = 5 + Math.floor(book.pagesRead * 0.05);
            
            // Apply influence gain bonuses
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'inf_gain') {
                            influenceGained = Math.floor(influenceGained * (1 + effect.value / 100));
                        }
                    });
                }
            });
            
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'inf_gain') {
                            influenceGained = Math.floor(influenceGained * (1 + effect.value / 100));
                        }
                    });
                }
            });
            
            gameState.resources.influence += influenceGained;
            
            // Generate quantum fragments on book completion
            let qfGained = Math.floor(1 + Math.random() * 3);
            
            // Apply QF gain bonuses
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'qf_gain') {
                            qfGained = Math.floor(qfGained * (1 + effect.value / 100));
                        }
                    });
                }
            });
            
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'qf_gain') {
                            qfGained = Math.floor(qfGained * (1 + effect.value / 100));
                        }
                    });
                }
            });
            
            gameState.resources.quantumFragments += qfGained;
            
            // Increment completed books count
            gameState.stats.booksCompleted++;
            
            // Remove from current books list
            gameState.currentBooks.splice(bookIndex, 1);
            
            // Generate a random chance to find a relic (1% base chance)
            let relicChance = 0.01;
            
            // Apply relic discovery chance bonuses
            gameState.facilities.built.forEach(facility => {
                if (facility.effects) {
                    facility.effects.forEach(effect => {
                        if (effect.type === 'relic_chance') {
                            relicChance += effect.value / 100;
                        }
                    });
                }
            });
            
            gameState.research.completed.forEach(research => {
                if (research.effects) {
                    research.effects.forEach(effect => {
                        if (effect.type === 'relic_chance') {
                            relicChance += effect.value / 100;
                        }
                    });
                }
            });
            
            if (Math.random() < relicChance) {
                // Generate a relic
                const newRelic = generateRelic();
                
                // Add to discovered relics
                gameState.relics.discovered.push(newRelic);
                
                // Increment relic collection counter
                if (gameState.relics.collections[newRelic.collection]) {
                    gameState.relics.collections[newRelic.collection].discovered++;
                }
                
                // Update stats
                gameState.stats.relicsFound++;
                
                // Show the relic discovery modal
                setTimeout(() => {
                    showNewRelicModal(newRelic);
                }, 1000);
            }
            
            // Show notification
            showNotification(`Book completed: ${book.title}. +${completionBonus} KP completion bonus, +${influenceGained} INF, +${qfGained} QF`, 'success');
            
            // Update UI
            updateUI();
            
            // Save game
            if (gameState.settings.autoSave) {
                saveGame();
            }
        });
        
        // Discover facility button
        document.getElementById('discover-facility-btn').addEventListener('click', function() {
            discoverNewFacility();
        });
        
        // Generate research button
        document.getElementById('generate-research-btn').addEventListener('click', function() {
            generateNewResearch();
        });
        
        // Discover relic button
        document.getElementById('discover-relic-btn').addEventListener('click', function() {
            discoverNewRelic();
        });
        
        // Force unlock galaxy button
        document.getElementById('force-unlock-galaxy').addEventListener('click', function() {
            forceUnlockGalaxy();
        });
        
        // Save game button
        document.getElementById('save-game').addEventListener('click', function() {
            if (saveGame()) {
                showNotification('Game saved successfully!', 'success');
            }
        });
        
        // Export save button
        document.getElementById('export-save').addEventListener('click', function() {
            exportSaveData();
        });
        
        // Copy save button (in modal)
        document.getElementById('copy-save-modal').addEventListener('click', function() {
            const saveText = document.getElementById('export-save-text');
            saveText.select();
            document.execCommand('copy');
            showNotification('Save data copied to clipboard!', 'success');
        });
        
        // Copy save button (in settings)
        document.getElementById('copy-save').addEventListener('click', function() {
            const saveData = exportSaveData();
            if (saveData) {
                // Create a temporary textarea element
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = saveData;
                document.body.appendChild(tempTextArea);
                
                // Select and copy
                tempTextArea.select();
                document.execCommand('copy');
                
                // Remove the element
                document.body.removeChild(tempTextArea);
                
                showNotification('Save data copied to clipboard!', 'success');
            }
        });
        
        // Close export modal button
        document.getElementById('close-export-modal').addEventListener('click', function() {
            document.getElementById('save-export-modal').classList.add('hidden');
            document.getElementById('save-export-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
        });
        
        // Import save button
        document.getElementById('import-save').addEventListener('click', function() {
            const saveData = document.getElementById('import-save-data').value.trim();
            importSaveData(saveData);
        });
        
        // Reset game button
        document.getElementById('reset-game').addEventListener('click', function() {
            resetGame();
        });
        
        // Prestige buttons
        document.getElementById('prestige-button').addEventListener('click', function() {
            document.getElementById('ascension-modal').classList.remove('hidden');
            document.getElementById('ascension-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            updateEpPreview();
        });
        
        document.getElementById('ascend-button').addEventListener('click', function() {
            document.getElementById('ascension-modal').classList.remove('hidden');
            document.getElementById('ascension-modal').querySelector('.modal-enter').classList.add('modal-enter-active');
            updateEpPreview();
        });
        
        // Cancel ascension button
        document.getElementById('cancel-ascension').addEventListener('click', function() {
            document.getElementById('ascension-modal').classList.add('hidden');
            document.getElementById('ascension-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
        });
        
        // Confirm ascension button
        document.getElementById('confirm-ascension').addEventListener('click', function() {
            document.getElementById('ascension-modal').classList.add('hidden');
            document.getElementById('ascension-modal').querySelector('.modal-enter').classList.remove('modal-enter-active');
            performPrestige();
        });
        
        // Setting toggle handlers
        document.getElementById('auto-save').addEventListener('change', function() {
            gameState.settings.autoSave = this.checked;
            saveGame();
        });
        
        document.getElementById('show-notifications').addEventListener('change', function() {
            gameState.settings.showNotifications = this.checked;
            saveGame();
        });
        
        document.getElementById('offline-progress').addEventListener('change', function() {
            gameState.settings.offlineProgress = this.checked;
            saveGame();
        });
        
        document.getElementById('animation-effects').addEventListener('change', function() {
            gameState.settings.animationEffects = this.checked;
            saveGame();
        });
        
        // Tab switching
        document.querySelectorAll('.tab-link').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab-link').forEach(t => {
                    t.classList.remove('active', 'border-primary', 'text-primary');
                    t.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                });
                
                // Add active class to clicked tab
                tab.classList.add('active', 'border-primary', 'text-primary');
                tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                
                // Handle enlightenment tab specially
                if (tab.getAttribute('data-tab') === 'enlightenment') {
                    tab.classList.add('text-enlightenment');
                    tab.classList.remove('text-primary');
                    
                    // Update EP preview calculations
                    updateEpPreview();
                }
                
                // Update genre distribution if on stats tab
                if (tab.getAttribute('data-tab') === 'stats') {
                    updateGenreDistribution();
                }
                
                // Initialize galaxy map if on galaxy tab
                if (tab.getAttribute('data-tab') === 'galaxy') {
                    updateGalaxyUI();
                    if (gameState.galaxy.unlocked) {
                        initializeGalaxyMap();
                    }
                }
                
                // Update relics if on relics tab
                if (tab.getAttribute('data-tab') === 'relics') {
                    updateRelicsUI();
                    updateRelicCollectionsUI();
                }
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden');
                    pane.classList.remove('active');
                });
                
                // Show the target tab pane
                const tabName = tab.getAttribute('data-tab');
                const tabPane = document.getElementById(tabName + '-tab');
                tabPane.classList.remove('hidden');
                tabPane.classList.add('active');
            });
        });
        
        // Custom Genre Selection
        document.getElementById('book-genre').addEventListener('change', function() {
            const customGenreContainer = document.getElementById('custom-genre-container');
            if (this.value === 'custom') {
                customGenreContainer.classList.remove('hidden');
            } else {
                customGenreContainer.classList.add('hidden');
            }
        });
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        // Initialize UI
        function init() {
            // Try to load saved game data
            const loaded = loadGame();
            
            if (!loaded) {
                // First time playing, show welcome message
                showNotification('Welcome to Stellar Bibliophile 2.0!', 'success');
                
                // Create a starting facility
                const startingFacility = generateFacility();
                gameState.facilities.available.push(startingFacility);
                
                // Create a starting research
                const startingResearch = generateResearch();
                gameState.research.available.push(startingResearch);
                
                // Save initial game state
                saveGame();
            }
            
            // Set up settings UI based on game state
            document.getElementById('auto-save').checked = gameState.settings.autoSave;
            document.getElementById('show-notifications').checked = gameState.settings.showNotifications;
            document.getElementById('offline-progress').checked = gameState.settings.offlineProgress;
            document.getElementById('animation-effects').checked = gameState.settings.animationEffects;
            
            // Update UI
            updateUI();
            
            // Set up resource generation interval
            setInterval(generatePassiveResources, gameConfig.resourceInterval);
            
            // Set up auto-save interval if enabled
            setInterval(() => {
                if (gameState.settings.autoSave) {
                    saveGame();
                }
            }, gameConfig.autoSaveInterval);
            
            // Setup enlightenment upgrade button listeners
            setupEnlightenmentUpgradeListeners();
        }
        
        // Setup event listeners for enlightenment upgrades
        function setupEnlightenmentUpgradeListeners() {
            // Use event delegation for enlightenment upgrade buttons
            document.getElementById('enlightenment-upgrades-container').addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.upgradeId) return;
                
                const upgradeId = button.dataset.upgradeId;
                const upgrade = gameState.prestige.permanentUpgrades.find(u => u.id === upgradeId);
                
                if (!upgrade) return;
                
                // Calculate cost
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                
                // Check if player can afford upgrade
                if (gameState.prestige.enlightenmentPoints < cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                // Check if upgrade is at max level
                if (upgrade.maxLevel !== Infinity && upgrade.level >= upgrade.maxLevel) {
                    showNotification('This upgrade is already at maximum level.', 'error');
                    return;
                }
                
                // Purchase the upgrade
                gameState.prestige.enlightenmentPoints -= cost;
                upgrade.level++;
                
                // Update UI
                updateEnlightenmentUI();
                updateUI();
                
                showNotification(`${upgrade.name} upgraded to level ${upgrade.level}!`, 'enlightenment');
                
                // Save game
                if (gameState.settings.autoSave) {
                    saveGame();
                }
            });
        }
        
        // Initialize the game when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
